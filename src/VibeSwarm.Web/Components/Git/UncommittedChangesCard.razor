@* Uncommitted changes card for failed/cancelled jobs that may have made partial changes *@
@using VibeSwarm.Shared.VersionControl
@using VibeSwarm.Shared.VersionControl.Models

<div class="card mb-3 mb-lg-4 @(HasChanges ? "border-warning" : "")">
	<div class="card-header @(HasChanges ? "bg-warning bg-opacity-25" : "bg-body-secondary")">
		<div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
			<div class="d-flex align-items-center gap-2">
				<i class="bi bi-folder-symlink me-1 opacity-75"></i>
				<strong>Working Directory Changes</strong>
				@if (HasChanges && DiffFiles.Count > 0)
				{
					<span class="badge bg-warning text-dark">@DiffFiles.Count file(s)</span>
				}
			</div>
			@if (!IsChecking)
			{
				<button class="btn btn-sm btn-outline-secondary" @onclick="OnRefresh"
					title="Check for changes in working directory">
					<i class="bi bi-arrow-repeat me-1"></i>
					<span class="d-none d-sm-inline">Refresh</span>
				</button>
			}
		</div>
	</div>
	<div class="card-body">
		@if (IsChecking)
		{
			<div class="d-flex align-items-center justify-content-center gap-2 py-4 text-body-secondary">
				<span class="spinner-border spinner-border-sm" role="status"></span>
				<span>Checking for uncommitted changes...</span>
			</div>
		}
		else if (!string.IsNullOrEmpty(ErrorMessage))
		{
			<div class="alert alert-danger mb-0">
				<i class="bi bi-exclamation-triangle me-1"></i>@ErrorMessage
			</div>
		}
		else if (!HasChecked)
		{
			<div class="text-center py-3">
				<p class="text-body-secondary mb-3">
					<i class="bi bi-exclamation-circle me-2"></i>
					This job @(JobFailed ? "failed" : "was cancelled") but the CLI agent may have made changes to the
					working directory.
				</p>
				<button class="btn btn-primary" @onclick="OnCheck">
					<i class="bi bi-search me-1"></i>Check for Changes
				</button>
			</div>
		}
		else if (!HasChanges)
		{
			<div class="text-center py-3 text-body-secondary">
				<i class="bi bi-check-circle me-2 text-success"></i>
				No uncommitted changes found in the working directory.
			</div>
		}
		else
		{
			@* Show uncommitted changes with options to commit or discard *@
			<div class="alert alert-warning mb-3">
				<i class="bi bi-exclamation-triangle me-2"></i>
				<strong>Uncommitted changes detected!</strong>
				<span class="d-block d-sm-inline mt-1 mt-sm-0 ms-sm-1">
					The CLI agent made changes before the job @(JobFailed ? "failed" : "was cancelled").
				</span>
			</div>

			@* Diff viewer for uncommitted changes *@
			<div class="mb-3">
				<div class="d-flex align-items-center justify-content-between mb-2">
					<span class="text-body-secondary small">
						<span class="text-success">+@GitDiffParser.TotalAdditions(DiffFiles)</span>
						<span class="text-danger ms-1">-@GitDiffParser.TotalDeletions(DiffFiles)</span>
					</span>
					<div class="btn-group btn-group-sm">
						<button type="button" class="btn btn-outline-secondary" @onclick="ExpandAll" title="Expand all"
							disabled="@(_expandedFiles.Count == DiffFiles.Count)">
							<i class="bi bi-arrows-expand"></i>
						</button>
						<button type="button" class="btn btn-outline-secondary" @onclick="CollapseAll" title="Collapse all"
							disabled="@(_expandedFiles.Count == 0)">
							<i class="bi bi-arrows-collapse"></i>
						</button>
					</div>
				</div>

				<div class="accordion border rounded overflow-y-auto" style="max-height: 350px;">
					@foreach (var (file, index) in DiffFiles.Select((f, i) => (f, i)))
					{
						var isExpanded = _expandedFiles.Contains(index);
						<div class="accordion-item">
							<h2 class="accordion-header">
								<button class="accordion-button @(isExpanded ? "" : "collapsed") py-2 px-3" type="button"
									@onclick="() => ToggleFile(index)">
									<span class="d-flex align-items-center gap-2 w-100">
										@if (file.IsNew)
										{
											<i class="bi bi-file-earmark-plus text-success" title="New file"></i>
										}
										else if (file.IsDeleted)
										{
											<i class="bi bi-file-earmark-minus text-danger" title="Deleted file"></i>
										}
										else
										{
											<i class="bi bi-file-earmark-diff text-warning" title="Modified file"></i>
										}
										<span class="font-monospace small text-truncate flex-grow-1">@file.FileName</span>
										<span class="small">
											@if (file.Additions > 0)
											{
												<span class="text-success fw-medium">+@file.Additions</span>
											}
											@if (file.Deletions > 0)
											{
												<span class="text-danger fw-medium ms-1">-@file.Deletions</span>
											}
										</span>
									</span>
								</button>
							</h2>
							<div class="accordion-collapse @(isExpanded ? "show" : "collapse")">
								<div class="accordion-body p-0">
									@if (!file.IsDeleted)
									{
										<div class="terminal-output overflow-auto p-2 small" style="max-height: 250px;">
											@((MarkupString)GitDiffParser.FormatDiffHtml(file.DiffContent))
										</div>
									}
									else
									{
										<div class="p-3 text-body-secondary small">
											<i class="bi bi-trash me-1"></i>File deleted
										</div>
									}
								</div>
							</div>
						</div>
					}
				</div>
			</div>

			<hr class="my-3" />

			@* Commit section for uncommitted changes *@
			<div class="mb-3">
				<label for="uncommittedCommitMsg" class="form-label fw-medium small">
					<i class="bi bi-chat-square-text me-1"></i>Commit Message (to keep changes)
				</label>
				<textarea class="form-control font-monospace" id="uncommittedCommitMsg" @bind="CommitMessage"
					@bind:event="oninput" rows="2" placeholder="Enter commit message to keep these changes..."
					disabled="@(IsCommitting || IsDiscarding)"></textarea>
			</div>

			@* Discard confirmation *@
			@if (_showDiscardConfirmation)
			{
				<div class="alert alert-danger py-3 mb-3">
					<div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
						<div>
							<i class="bi bi-exclamation-triangle me-2"></i>
							<strong>Are you sure?</strong> This will permanently discard all uncommitted changes.
						</div>
						<div class="d-flex gap-2">
							<button type="button" class="btn btn-secondary btn-sm"
								@onclick="() => _showDiscardConfirmation = false" disabled="@IsDiscarding">
								Cancel
							</button>
							<button type="button" class="btn btn-danger btn-sm" @onclick="ConfirmDiscard"
								disabled="@IsDiscarding">
								@if (IsDiscarding)
								{
									<span class="spinner-border spinner-border-sm me-1" role="status"></span>
								}
								Yes, Discard All
							</button>
						</div>
					</div>
				</div>
			}

			@* Action buttons *@
			<div class="d-flex flex-wrap gap-2">
				<button class="btn btn-success" @onclick="OnCommit"
					disabled="@(IsCommitting || IsDiscarding || string.IsNullOrWhiteSpace(CommitMessage))">
					@if (IsCommitting)
					{
						<span class="spinner-border spinner-border-sm me-1" role="status"></span>
						<span>Committing...</span>
					}
					else
					{
						<i class="bi bi-check-circle me-1"></i>
						<span>Keep Changes</span>
					}
				</button>
				<button class="btn btn-outline-danger" @onclick="() => _showDiscardConfirmation = true"
					disabled="@(IsCommitting || IsDiscarding || _showDiscardConfirmation)">
					<i class="bi bi-trash me-1"></i>
					<span>Discard Changes</span>
				</button>
			</div>
		}
	</div>
</div>

@code {
	[Parameter]
	public List<DiffFile> DiffFiles { get; set; } = new();

	[Parameter]
	public bool IsChecking { get; set; }

	[Parameter]
	public bool HasChecked { get; set; }

	[Parameter]
	public bool HasChanges { get; set; }

	[Parameter]
	public string? ErrorMessage { get; set; }

	[Parameter]
	public bool JobFailed { get; set; }

	[Parameter]
	public string CommitMessage { get; set; } = string.Empty;

	[Parameter]
	public EventCallback<string> CommitMessageChanged { get; set; }

	[Parameter]
	public bool IsCommitting { get; set; }

	[Parameter]
	public bool IsDiscarding { get; set; }

	[Parameter]
	public EventCallback OnCheck { get; set; }

	[Parameter]
	public EventCallback OnRefresh { get; set; }

	[Parameter]
	public EventCallback OnCommit { get; set; }

	[Parameter]
	public EventCallback OnDiscard { get; set; }

	private HashSet<int> _expandedFiles = new();
	private bool _showDiscardConfirmation = false;

	protected override void OnParametersSet()
	{
		// Auto-expand first file if there's only one
		if (DiffFiles.Count == 1 && _expandedFiles.Count == 0)
		{
			_expandedFiles.Add(0);
		}
	}

	private void ToggleFile(int index)
	{
		if (_expandedFiles.Contains(index))
			_expandedFiles.Remove(index);
		else
			_expandedFiles.Add(index);
	}

	private void ExpandAll()
	{
		_expandedFiles = Enumerable.Range(0, DiffFiles.Count).ToHashSet();
	}

	private void CollapseAll()
	{
		_expandedFiles.Clear();
	}

	private async Task ConfirmDiscard()
	{
		await OnDiscard.InvokeAsync();
		_showDiscardConfirmation = false;
	}
}