@* Modal component for adding and editing skills *@
@using VibeSwarm.Shared.Data
@using VibeSwarm.Shared.Services
@inject ISkillService SkillService

<ModalDialog IsVisible="IsVisible" IsVisibleChanged="HandleModalVisibilityChanged"
	Title="@(IsEdit ? "Edit Skill" : "Add Skill")" Icon="@(IsEdit ? "pencil" : "lightbulb")"
	Size="ModalDialog.ModalSize.Large" OnClose="HandleClose">
	<ChildContent>
		<EditForm Model="@Skill" OnValidSubmit="HandleValidSubmit">
			<DataAnnotationsValidator />
			<ValidationSummary class="text-danger mb-3" />

			<div class="mb-3">
				<label for="modal-name" class="form-label">Name</label>
				<InputText id="modal-name" @bind-Value="Skill.Name" class="form-control" placeholder="my-skill-name" />
				<ValidationMessage For="@(() => Skill.Name)" class="text-danger small" />
				<div class="form-text">
					Used as the MCP tool identifier. Use lowercase with hyphens.
				</div>
			</div>

			<div class="mb-3">
				<label for="modal-description" class="form-label">Description</label>
				<InputTextArea id="modal-description" @bind-Value="Skill.Description" class="form-control" rows="2"
					placeholder="Brief description of what this skill does..." />
				<div class="form-text">
					Shown to AI agents when they list available skills.
				</div>
			</div>

			<div class="mb-3">
				<label for="modal-content" class="form-label">Content (Markdown)</label>
				<InputTextArea id="modal-content" @bind-Value="Skill.Content" class="form-control font-monospace"
					rows="10"
					placeholder="# Skill Instructions&#10;&#10;Provide detailed instructions for the AI agent..." />
				<ValidationMessage For="@(() => Skill.Content)" class="text-danger small" />
				<div class="form-text">
					Markdown content defining the skill's instructions and capabilities.
				</div>
			</div>

			<div class="mb-3">
				<div class="form-check form-switch">
					<InputCheckbox id="modal-isEnabled" @bind-Value="Skill.IsEnabled" class="form-check-input" />
					<label class="form-check-label" for="modal-isEnabled">
						Enabled
					</label>
				</div>
				<div class="form-text">
					Disabled skills will not be exposed to providers.
				</div>
			</div>

			@if (!string.IsNullOrEmpty(ErrorMessage))
			{
				<div class="alert alert-danger mb-3">@ErrorMessage</div>
			}

			@if (!string.IsNullOrEmpty(SuccessMessage))
			{
				<div class="alert alert-success mb-3">@SuccessMessage</div>
			}

			<div class="d-flex gap-2 justify-content-end">
				<button type="button" class="btn btn-secondary" @onclick="HandleCancel">Cancel</button>
				<button type="submit" class="btn btn-primary" disabled="@IsSaving">
					@if (IsSaving)
					{
						<span class="spinner-border spinner-border-sm me-1" role="status"></span>
					}
					@(IsSaving ? "Saving..." : (IsEdit ? "Update Skill" : "Add Skill"))
				</button>
			</div>
		</EditForm>
	</ChildContent>
</ModalDialog>

@code {
	[Parameter]
	public bool IsVisible { get; set; }

	[Parameter]
	public EventCallback<bool> IsVisibleChanged { get; set; }

	[Parameter]
	public Skill? EditSkill { get; set; }

	[Parameter]
	public EventCallback<Guid?> OnSaved { get; set; }

	[Parameter]
	public EventCallback OnCancelled { get; set; }

	[Parameter]
	public EventCallback OnClosed { get; set; }

	private Skill Skill { get; set; } = new();
	private bool IsEdit => EditSkill != null;
	private bool IsSaving { get; set; }
	private string? ErrorMessage { get; set; }
	private string? SuccessMessage { get; set; }
	private bool _previousIsVisible;

	protected override void OnParametersSet()
	{
		// Only reset state when modal is opening (transitioning from hidden to visible)
		if (IsVisible && !_previousIsVisible)
		{
			ResetState();

			if (EditSkill != null)
			{
				// Clone the skill for editing
				Skill = new Skill
				{
					Id = EditSkill.Id,
					Name = EditSkill.Name,
					Description = EditSkill.Description,
					Content = EditSkill.Content,
					IsEnabled = EditSkill.IsEnabled,
					CreatedAt = EditSkill.CreatedAt,
					UpdatedAt = EditSkill.UpdatedAt
				};
			}
			else
			{
				// Reset for new skill
				Skill = new Skill();
			}
		}

		_previousIsVisible = IsVisible;
	}

	private async Task HandleValidSubmit()
	{
		IsSaving = true;
		ErrorMessage = null;
		SuccessMessage = null;

		try
		{
			// Validate unique name
			var nameExists = await SkillService.NameExistsAsync(
			Skill.Name,
			IsEdit ? Skill.Id : null);

			if (nameExists)
			{
				ErrorMessage = "A skill with this name already exists.";
				IsSaving = false;
				return;
			}

			Guid? newSkillId = null;

			if (IsEdit)
			{
				await SkillService.UpdateAsync(Skill);
				SuccessMessage = "Skill updated successfully.";
			}
			else
			{
				var created = await SkillService.CreateAsync(Skill);
				newSkillId = created.Id;
				SuccessMessage = "Skill added successfully.";
			}

			await OnSaved.InvokeAsync(newSkillId);
			await CloseModal();
		}
		catch (Exception ex)
		{
			ErrorMessage = $"Error saving skill: {ex.Message}";
		}
		finally
		{
			IsSaving = false;
		}
	}

	private async Task HandleCancel()
	{
		await OnCancelled.InvokeAsync();
		await CloseModal();
	}

	private async Task HandleClose()
	{
		ResetState();
		await OnClosed.InvokeAsync();
	}

	private async Task HandleModalVisibilityChanged(bool visible)
	{
		if (!visible)
		{
			ResetState();
			await IsVisibleChanged.InvokeAsync(false);
		}
	}

	private async Task CloseModal()
	{
		IsVisible = false;
		await IsVisibleChanged.InvokeAsync(false);
		ResetState();
	}

	private void ResetState()
	{
		Skill = new Skill();
		ErrorMessage = null;
		SuccessMessage = null;
		IsSaving = false;
	}
}