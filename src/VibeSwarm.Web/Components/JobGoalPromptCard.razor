@* Goal prompt display card with full view modal support *@

<div class="card mb-3 mb-lg-4">
	<div class="card-header bg-body-secondary d-flex justify-content-between align-items-center">
		<h5 class="mb-0 fw-semibold"><i class="bi bi-bullseye me-2 opacity-75"></i>Goal Prompt</h5>
		<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ShowFullPrompt"
			title="View full prompt">
			<i class="bi bi-arrows-fullscreen me-1"></i>
			<span class="d-none d-sm-inline">View Full</span>
		</button>
	</div>
	<div class="card-body d-flex flex-column gap-3">
		<div class="goal-prompt-box">@GoalPrompt</div>

		@if (!string.IsNullOrEmpty(SessionId))
		{
			<div class="d-flex flex-wrap gap-2">
				<StatItem Label="Session ID" Value="@SessionId" Monospace="true" />
			</div>
		}

		@if (!string.IsNullOrEmpty(ErrorMessage))
		{
			<div>
				<h6 class="text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>Error</h6>
				<pre class="error-output">@ErrorMessage</pre>
			</div>
		}

		@if (Status == JobStatus.Cancelled)
		{
			<div class="info-section">
				<h6>Job Cancelled</h6>
				<p class="mb-0">This job was cancelled and can be retried. Click "Retry" to run it again.</p>
			</div>
		}
		else if (Status == JobStatus.Failed && CanRetry)
		{
			<div class="info-section">
				<h6>Job Failed</h6>
				@if (string.IsNullOrEmpty(ErrorMessage) && HasConsoleOutput)
				{
					<p class="mb-0">This job failed during execution. Check the console output below for details. You can retry
						by clicking "Retry" above.</p>
				}
				else
				{
					<p class="mb-0">This job failed during execution. You can retry it by clicking "Retry" above.</p>
				}
			</div>
		}
	</div>
</div>

@* Full Prompt Modal *@
@if (_showModal)
{
	<div class="modal-backdrop fade show vs-modal-backdrop"></div>
	<div class="modal fade show d-block vs-modal-container" tabindex="-1" role="dialog" @onclick="CloseModal">
		<div class="modal-dialog modal-lg vs-modal-dialog modal-dialog-centered modal-dialog-scrollable"
			@onclick:stopPropagation="true">
			<div class="modal-content vs-modal-content">
				<div class="modal-header">
					<h5 class="modal-title"><i class="bi bi-file-text me-2"></i>Full Input Prompt</h5>
					<button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<pre class="full-prompt-content">@GoalPrompt</pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" @onclick="CopyToClipboard">
						<i class="bi bi-clipboard me-1"></i>Copy to Clipboard
					</button>
					<button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
				</div>
			</div>
		</div>
	</div>
}

@code {
	[Parameter, EditorRequired]
	public string GoalPrompt { get; set; } = string.Empty;

	[Parameter]
	public string? SessionId { get; set; }

	[Parameter]
	public string? ErrorMessage { get; set; }

	[Parameter]
	public JobStatus Status { get; set; }

	[Parameter]
	public bool CanRetry { get; set; }

	[Parameter]
	public bool HasConsoleOutput { get; set; }

	[Parameter]
	public EventCallback OnCopyToClipboard { get; set; }

	private bool _showModal = false;

	private void ShowFullPrompt()
	{
		_showModal = true;
	}

	private void CloseModal()
	{
		_showModal = false;
	}

	private async Task CopyToClipboard()
	{
		await OnCopyToClipboard.InvokeAsync();
	}
}