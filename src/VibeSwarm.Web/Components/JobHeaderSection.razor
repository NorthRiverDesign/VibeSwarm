@* Job detail page header section with status, stats, command display, and action buttons *@
@using VibeSwarm.Shared.Utilities

<div
	class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3 mb-3 mb-lg-4 pb-3 border-bottom">
	<div class="flex-grow-1 min-width-0 w-100 w-lg-auto">
		@* Title row with status and action buttons *@
		<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
			<div class="d-flex flex-wrap align-items-center gap-2">
				<h3 class="mb-0 fs-4 fw-semibold">Job Details</h3>
				<StatusBadge Status="@Status.ToString()" />
				@if (CancellationRequested && IsRunning)
				{
					<StatusBadge Status="Cancelling" />
				}
			</div>
			@* Action Buttons - integrated in header *@
			<div class="d-flex flex-wrap gap-2 flex-shrink-0">
				@if (CanRetry)
				{
					@if (ShowRetryOptions)
					{
						<ActionButton Icon="arrow-repeat" Text="@(IsRetrying ? "Retrying..." : "Retry")"
							Style="ActionButton.ButtonStyle.Primary" Size="ActionButton.ButtonSize.Small"
							IsLoading="@IsRetrying" OnClick="OnRetryWithOptions" />
					}
					else
					{
						<ActionButton Icon="arrow-repeat" Text="@(IsRetrying ? "Retrying..." : "Retry")"
							Style="ActionButton.ButtonStyle.Primary" Size="ActionButton.ButtonSize.Small"
							IsLoading="@IsRetrying" OnClick="OnRetry" />
					}
				}
				@if (CanCancel)
				{
					<ActionButton Icon="x-circle" Text="@(IsCancelling ? "Cancelling..." : "Cancel")"
						Style="ActionButton.ButtonStyle.Danger" Size="ActionButton.ButtonSize.Small"
						IsLoading="@IsCancelling" OnClick="OnCancel" />
				}
				@if (CanForceCancel)
				{
					<ActionButton Icon="stop-circle" Text="@(IsForceCancelling ? "Stopping..." : "Force Stop")"
						Style="ActionButton.ButtonStyle.Danger" Outline="true" Size="ActionButton.ButtonSize.Small"
						IsLoading="@IsForceCancelling" OnClick="OnForceCancel" />
				}
			</div>
		</div>

		@* Activity indicator when job is running *@
		@if (IsRunning && !string.IsNullOrEmpty(CurrentActivity))
		{
			<div
				class="d-flex align-items-center gap-2 mb-2 p-2 bg-info bg-opacity-10 rounded border border-info border-opacity-25">
				<span class="spinner-border spinner-border-sm text-info" role="status"></span>
				<span class="text-body small fw-medium">@CurrentActivity</span>
				@if (LastActivityAt.HasValue)
				{
					<span class="text-body-secondary small ms-auto">@LastActivityAt.Value.FormatTime()</span>
				}
			</div>
		}

		@* Metadata chips row *@
		<div class="d-flex flex-wrap align-items-center gap-2 mb-2">
			@if (!string.IsNullOrEmpty(ProviderName))
			{
				<span class="badge bg-primary bg-opacity-75 d-inline-flex align-items-center gap-1 fw-normal"
					title="Provider">
					<i class="bi bi-robot"></i>
					<span>@ProviderName</span>
				</span>
			}
			@if (!string.IsNullOrEmpty(GitHubRepository))
			{
				<span class="badge bg-dark bg-opacity-75 d-inline-flex align-items-center gap-1 fw-normal">
					<i class="bi bi-github"></i>
					<span>@GitHubRepository</span>
				</span>
			}
			@if (!string.IsNullOrEmpty(BranchName))
			{
				<span class="badge bg-secondary bg-opacity-75 d-inline-flex align-items-center gap-1 fw-normal">
					<i class="bi bi-diagram-2"></i>
					<span>@BranchName</span>
				</span>
			}
			@if (ProcessId.HasValue)
			{
				<span
					class="badge bg-secondary bg-opacity-50 d-inline-flex align-items-center gap-1 fw-normal d-none d-sm-inline-flex"
					title="Process ID">
					<i class="bi bi-cpu"></i>
					<span>PID: @ProcessId</span>
				</span>
			}
		</div>

		@* Timestamps row *@
		<div class="small text-body-secondary">
			<div class="d-flex flex-wrap gap-2 gap-sm-3">
				<span title="Created"><i
						class="bi bi-calendar-plus me-1 opacity-75"></i>@CreatedAt.FormatDateTimeShort()</span>
				@if (StartedAt.HasValue)
				{
					<span title="Started"><i
							class="bi bi-play-circle me-1 opacity-75"></i>@StartedAt.Value.FormatDateTimeShort()</span>
				}
				@if (CompletedAt.HasValue)
				{
					<span title="Completed"><i
							class="bi bi-check-circle me-1 opacity-75"></i>@CompletedAt.Value.FormatDateTimeShort()</span>
				}
			</div>
		</div>

		@* Stats Row - Token usage and cost *@
		@if (ShowStats)
		{
			<div
				class="d-flex flex-wrap gap-2 gap-sm-3 mt-2 pt-2 border-top border-secondary border-opacity-25 job-stats-row">
				@if (!string.IsNullOrEmpty(ModelUsed))
				{
					<span class="stat-pill" title="Model">
						<i class="bi bi-cpu me-1 opacity-75"></i>@ModelUsed
					</span>
				}
				@if (RetryCount > 0)
				{
					<span class="stat-pill" title="Attempt Number">
						<i class="bi bi-arrow-repeat me-1 opacity-75"></i>Attempt @(RetryCount + 1)
					</span>
				}
				@if (InputTokens.HasValue)
				{
					<span class="stat-pill" title="Input Tokens">
						<i class="bi bi-arrow-right-circle me-1 opacity-75"></i>@TokenHelper.FormatTokenCount(InputTokens.Value)
					</span>
				}
				@if (OutputTokens.HasValue)
				{
					<span class="stat-pill" title="Output Tokens">
						<i class="bi bi-arrow-left-circle me-1 opacity-75"></i>@TokenHelper.FormatTokenCount(OutputTokens.Value)
					</span>
				}
				@if (InputTokens.HasValue && OutputTokens.HasValue)
				{
					<span class="stat-pill" title="Total Tokens">
						<i class="bi bi-arrow-left-right me-1 opacity-75"></i>@TokenHelper.FormatTokenCount(InputTokens.Value +
										OutputTokens.Value)
			</span>
						}
				@if (TotalCostUsd.HasValue)
				{
					<span class="stat-pill stat-pill-cost" title="Total Cost">
						<i class="bi bi-currency-dollar me-1 opacity-75"></i>@TokenHelper.FormatCost(TotalCostUsd.Value)
					</span>
				}
			</div>
		}

		@* Command Display *@
		@if (!string.IsNullOrEmpty(DisplayCommand))
		{
			<div class="mt-2 pt-2 border-top border-secondary border-opacity-25">
				<div class="d-flex align-items-center gap-2 flex-wrap">
					<button type="button" class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
						@onclick="ToggleCommandDisplay" title="@(_showFullCommand ? "Hide command" : "Show command")">
						<i class="bi bi-terminal"></i>
						<span class="d-none d-sm-inline">Command</span>
						<i class="bi @(_showFullCommand ? "bi-chevron-up" : "bi-chevron-down") ms-1 small"></i>
					</button>
					@if (!_showFullCommand)
					{
						<code class="small text-truncate flex-grow-1" style="max-width: 400px;" title="@DisplayCommand">
				                            @TruncateCommand(DisplayCommand, 60)
				                        </code>
					}
					<button type="button" class="btn btn-sm btn-link text-body-secondary p-0" @onclick="CopyCommand"
						title="Copy command">
						<i class="bi bi-clipboard"></i>
					</button>
				</div>
				@if (_showFullCommand)
				{
					<div class="mt-2 p-2 bg-body-tertiary rounded border">
						<code class="small d-block text-break"
							style="white-space: pre-wrap; word-break: break-all;">@DisplayCommand</code>
					</div>
				}
			</div>
		}
	</div>
</div>

@code {
	[Parameter, EditorRequired]
	public JobStatus Status { get; set; }

	[Parameter]
	public bool CancellationRequested { get; set; }

	[Parameter]
	public string? GitHubRepository { get; set; }

	[Parameter]
	public string? BranchName { get; set; }

	[Parameter]
	public Guid ProjectId { get; set; }

	[Parameter]
	public string ProjectName { get; set; } = "Unknown";

	[Parameter]
	public string ProviderName { get; set; } = "Unknown";

	[Parameter]
	public int? ProcessId { get; set; }

	[Parameter]
	public DateTime CreatedAt { get; set; }

	[Parameter]
	public DateTime? StartedAt { get; set; }

	[Parameter]
	public DateTime? CompletedAt { get; set; }

	[Parameter]
	public string? ModelUsed { get; set; }

	[Parameter]
	public int RetryCount { get; set; }

	[Parameter]
	public int? InputTokens { get; set; }

	[Parameter]
	public int? OutputTokens { get; set; }

	[Parameter]
	public decimal? TotalCostUsd { get; set; }

	[Parameter]
	public string? CommandUsed { get; set; }

	[Parameter]
	public string? LiveCommand { get; set; }

	[Parameter]
	public bool CanRetry { get; set; }

	[Parameter]
	public bool CanCancel { get; set; }

	[Parameter]
	public bool CanForceCancel { get; set; }

	[Parameter]
	public bool ShowRetryOptions { get; set; }

	[Parameter]
	public bool IsRetrying { get; set; }

	[Parameter]
	public bool IsCancelling { get; set; }

	[Parameter]
	public bool IsForceCancelling { get; set; }

	[Parameter]
	public EventCallback OnRetry { get; set; }

	[Parameter]
	public EventCallback OnRetryWithOptions { get; set; }

	[Parameter]
	public EventCallback OnCancel { get; set; }

	[Parameter]
	public EventCallback OnForceCancel { get; set; }

	[Parameter]
	public EventCallback<string> OnCopyCommand { get; set; }

	[Parameter]
	public string? CurrentActivity { get; set; }

	[Parameter]
	public DateTime? LastActivityAt { get; set; }

	private bool _showFullCommand = false;

	private bool IsRunning => Status == JobStatus.Started || Status == JobStatus.Processing;

	private bool ShowStats => !string.IsNullOrEmpty(ModelUsed) || InputTokens.HasValue || OutputTokens.HasValue ||
	TotalCostUsd.HasValue || RetryCount > 0;

	private string? DisplayCommand => !string.IsNullOrEmpty(LiveCommand) ? LiveCommand : CommandUsed;

	private void ToggleCommandDisplay()
	{
		_showFullCommand = !_showFullCommand;
	}

	private async Task CopyCommand()
	{
		if (!string.IsNullOrEmpty(DisplayCommand))
		{
			await OnCopyCommand.InvokeAsync(DisplayCommand);
		}
	}

	private static string TruncateCommand(string command, int maxLength)
	{
		if (string.IsNullOrEmpty(command) || command.Length <= maxLength)
			return command;
		return command[..maxLength] + "...";
	}
}