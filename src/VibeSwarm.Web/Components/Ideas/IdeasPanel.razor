@* Ideas panel component for managing project feature ideas *@
@inject IProjectService ProjectService

<div class="card">
	<div class="card-header bg-body-secondary d-flex justify-content-between align-items-center">
		<h5 class="mb-0 fw-semibold">
			<i class="bi bi-lightbulb me-2"></i>Ideas
		</h5>
		<div class="d-flex align-items-center gap-2">
			<span class="badge bg-secondary">@Ideas.Count</span>
			@if (Ideas.Count >= 1)
			{
				@if (IsProcessingActive)
				{
					<button type="button" class="btn btn-sm btn-outline-danger" @onclick="OnStopProcessing"
						disabled="@IsTogglingProcessing">
						@if (IsTogglingProcessing)
						{
							<span class="spinner-border spinner-border-sm me-1" role="status"></span>
						}
						else
						{
							<i class="bi bi-stop-fill me-1"></i>
						}
						Stop
					</button>
				}
				else
				{
					<button type="button" class="btn btn-sm btn-success" @onclick="OnStartProcessing"
						disabled="@(IsTogglingProcessing || !HasDefaultProvider || HasActiveJobs)"
						title="@(HasActiveJobs ? "A job is already running on this project" : "Start all ideas processing")">
						@if (IsTogglingProcessing)
						{
							<span class="spinner-border spinner-border-sm me-1" role="status"></span>
						}
						else
						{
							<i class="bi bi-play-fill me-1"></i>
						}
						Start All
					</button>
				}
			}
		</div>
	</div>
	<div class="card-body">
		@* Add New Idea Form *@
		<div class="mb-3">
			<div class="d-flex gap-2 align-items-end">
				<div class="flex-grow-1">
					<textarea class="form-control" rows="2" placeholder="Enter a feature idea..."
						@bind="NewIdeaDescription" @bind:event="oninput" @onkeypress="HandleKeyPress"></textarea>
				</div>
				<button type="button" class="btn btn-primary" @onclick="AddIdea"
					disabled="@(string.IsNullOrWhiteSpace(NewIdeaDescription) || IsAddingIdea)" style="height: 58px;">
					@if (IsAddingIdea)
					{
						<span class="spinner-border spinner-border-sm" role="status"></span>
					}
					else
					{
						<i class="bi bi-plus-lg"></i>
					}
				</button>
			</div>
			<div class="form-text">
				Short description of a feature or update. Ideas will be expanded into full specs when processed. Press
				Ctrl+Enter to submit.
			</div>
		</div>

		@if (IsProcessingActive)
		{
			<div class="alert alert-info py-2 mb-3 d-flex align-items-center gap-2">
				<span class="spinner-border spinner-border-sm" role="status"></span>
				<span>Auto-processing active. Ideas will be converted to jobs automatically.</span>
			</div>
		}

		@* Ideas List *@
		@if (!Ideas.Any())
		{
			<div class="text-body-secondary text-center py-3">
				<i class="bi bi-lightbulb fs-1 opacity-50 mb-2 d-block"></i>
				<p class="mb-0">No ideas yet. Add some feature ideas above!</p>
			</div>
		}
		else
		{
			<ul class="list-group list-group-flush">
				@foreach (var idea in Ideas)
				{
					<li class="list-group-item px-0">
						@if (EditingIdeaId == idea.Id)
						{
							@* Edit Mode *@
							<div class="d-flex gap-2 align-items-end">
								<div class="flex-grow-1">
									<textarea class="form-control form-control-sm" rows="2" @bind="EditingIdeaDescription"
										@bind:event="oninput"></textarea>
								</div>
								<div class="d-flex flex-column gap-1">
									<button type="button" class="btn btn-sm btn-success" @onclick="SaveIdeaEdit"
										disabled="@(string.IsNullOrWhiteSpace(EditingIdeaDescription))">
										<i class="bi bi-check-lg"></i>
									</button>
									<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CancelIdeaEdit">
										<i class="bi bi-x-lg"></i>
									</button>
								</div>
							</div>
						}
						else
						{
							@* View Mode *@
							<div class="d-flex justify-content-between align-items-start gap-2">
								<div class="flex-grow-1 min-width-0">
									<div class="d-flex align-items-start gap-2">
										@if (idea.IsProcessing || IsIdeaProcessing(idea.Id))
										{
											<span class="spinner-border spinner-border-sm text-primary flex-shrink-0 mt-1" role="status"
												title="Processing..."></span>
										}
										else
										{
											<i class="bi bi-lightbulb text-warning flex-shrink-0 mt-1"></i>
										}
										<span
											class="@(idea.IsProcessing || IsIdeaProcessing(idea.Id) ? "text-body-secondary" : "") text-break"
											style="white-space: pre-wrap;">@idea.Description</span>
									</div>
									@if ((idea.IsProcessing || IsIdeaProcessing(idea.Id)) && idea.JobId.HasValue)
									{
										<small class="text-body-secondary ms-4">
											<a href="/jobs/view/@idea.JobId" class="text-decoration-none">
												View Job <i class="bi bi-arrow-right-short"></i>
											</a>
										</small>
									}
								</div>
								<div class="d-flex align-items-center gap-1 flex-shrink-0">
									@if (!idea.IsProcessing && !IsIdeaProcessing(idea.Id))
									{
										<button type="button" class="btn btn-sm btn-success" @onclick="() => StartSingleIdea(idea)"
											disabled="@(HasActiveJobs || !HasDefaultProvider || StartingIdeaId == idea.Id || idea.JobId.HasValue)"
											title="@(HasActiveJobs ? "A job is already running on this project" : "Start this idea")">
											@if (StartingIdeaId == idea.Id)
											{
												<span class="spinner-border spinner-border-sm" role="status"></span>
											}
											else
											{
												<i class="bi bi-play-fill"></i>
											}
										</button>
									}
									else
									{
										@* Show spinner when idea is processing *@
										<button type="button" class="btn btn-sm btn-outline-secondary" disabled>
											<span class="spinner-border spinner-border-sm" role="status"></span>
										</button>
									}
									<div class="dropdown">
										<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
											data-bs-toggle="dropdown" aria-expanded="false"
											disabled="@(idea.IsProcessing || IsIdeaProcessing(idea.Id) || idea.JobId.HasValue)">
											<i class="bi bi-three-dots-vertical"></i>
										</button>
										<ul class="dropdown-menu dropdown-menu-end">
											<li>
												<button class="dropdown-item" @onclick="() => StartEditIdea(idea)"
													disabled="@(idea.IsProcessing || IsIdeaProcessing(idea.Id) || idea.JobId.HasValue)">
													<i class="bi bi-pencil me-2"></i>Edit
												</button>
											</li>
											<li>
												<button class="dropdown-item" @onclick="() => OpenCopyModal(idea)">
													<i class="bi bi-copy me-2"></i>Copy to Project
												</button>
											</li>
											<li>
												<button class="dropdown-item" @onclick="() => OpenMoveModal(idea)"
													disabled="@(idea.IsProcessing || IsIdeaProcessing(idea.Id) || idea.JobId.HasValue)">
													<i class="bi bi-box-arrow-right me-2"></i>Move to Project
												</button>
											</li>
											<li>
												<hr class="dropdown-divider">
											</li>
											<li>
												<button class="dropdown-item text-danger"
													@onclick="() => OnDeleteIdea.InvokeAsync(idea.Id)"
													disabled="@(idea.IsProcessing || IsIdeaProcessing(idea.Id) || idea.JobId.HasValue)">
													<i class="bi bi-trash me-2"></i>Delete
												</button>
											</li>
										</ul>
									</div>
								</div>
							</div>
						}
					</li>
				}
			</ul>
		}

		@if (!HasDefaultProvider && Ideas.Any())
		{
			<div class="alert alert-warning py-2 mt-3 mb-0">
				<i class="bi bi-exclamation-triangle me-1"></i>
				<a href="/providers">Set a default provider</a> to enable Ideas auto-processing.
			</div>
		}
	</div>
</div>

@* Copy Idea Modal *@
@if (ShowCopyModal && SelectedIdea != null)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title"><i class="bi bi-copy me-2"></i>Copy Idea to Project</h5>
					<button type="button" class="btn-close" @onclick="CloseModals"></button>
				</div>
				<div class="modal-body">
					<p class="text-body-secondary mb-3">Select a project to copy this idea to:</p>
					<div class="mb-3">
						<label class="form-label fw-semibold">Idea</label>
						<div class="p-2 bg-body-tertiary rounded text-break" style="white-space: pre-wrap;">
							@SelectedIdea.Description</div>
					</div>
					<div class="mb-3">
						<label class="form-label fw-semibold">Target Project</label>
						<select class="form-select" @bind="SelectedTargetProjectId">
							<option value="">Select a project...</option>
							@foreach (var project in AvailableProjects.Where(p => p.Id != CurrentProjectId))
							{
								<option value="@project.Id">@project.Name</option>
							}
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
					<button type="button" class="btn btn-primary" @onclick="ConfirmCopyIdea"
						disabled="@(SelectedTargetProjectId == Guid.Empty || IsProcessingAction)">
						@if (IsProcessingAction)
						{
							<span class="spinner-border spinner-border-sm me-1" role="status"></span>
						}
						Copy Idea
					</button>
				</div>
			</div>
		</div>
	</div>
}

@* Move Idea Modal *@
@if (ShowMoveModal && SelectedIdea != null)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title"><i class="bi bi-box-arrow-right me-2"></i>Move Idea to Project</h5>
					<button type="button" class="btn-close" @onclick="CloseModals"></button>
				</div>
				<div class="modal-body">
					<p class="text-body-secondary mb-3">Select a project to move this idea to:</p>
					<div class="mb-3">
						<label class="form-label fw-semibold">Idea</label>
						<div class="p-2 bg-body-tertiary rounded text-break" style="white-space: pre-wrap;">
							@SelectedIdea.Description</div>
					</div>
					<div class="mb-3">
						<label class="form-label fw-semibold">Target Project</label>
						<select class="form-select" @bind="SelectedTargetProjectId">
							<option value="">Select a project...</option>
							@foreach (var project in AvailableProjects.Where(p => p.Id != CurrentProjectId))
							{
								<option value="@project.Id">@project.Name</option>
							}
						</select>
					</div>
					<div class="alert alert-warning py-2 mb-0">
						<i class="bi bi-exclamation-triangle me-1"></i>
						This will remove the idea from the current project.
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
					<button type="button" class="btn btn-warning" @onclick="ConfirmMoveIdea"
						disabled="@(SelectedTargetProjectId == Guid.Empty || IsProcessingAction)">
						@if (IsProcessingAction)
						{
							<span class="spinner-border spinner-border-sm me-1" role="status"></span>
						}
						Move Idea
					</button>
				</div>
			</div>
		</div>
	</div>
}

@code {
	[Parameter]
	public List<Idea> Ideas { get; set; } = new();

	[Parameter]
	public Guid CurrentProjectId { get; set; }

	[Parameter]
	public bool IsProcessingActive { get; set; }

	[Parameter]
	public bool IsTogglingProcessing { get; set; }

	[Parameter]
	public bool HasDefaultProvider { get; set; }

	[Parameter]
	public bool HasActiveJobs { get; set; }

	[Parameter]
	public bool IsAddingIdea { get; set; }

	[Parameter]
	public HashSet<Guid> ProcessingIdeaIds { get; set; } = new();

	[Parameter]
	public EventCallback OnStartProcessing { get; set; }

	[Parameter]
	public EventCallback OnStopProcessing { get; set; }

	[Parameter]
	public EventCallback<string> OnAddIdea { get; set; }

	[Parameter]
	public EventCallback<Idea> OnUpdateIdea { get; set; }

	[Parameter]
	public EventCallback<Guid> OnDeleteIdea { get; set; }

	[Parameter]
	public EventCallback<(Guid ideaId, Guid targetProjectId)> OnCopyIdea { get; set; }

	[Parameter]
	public EventCallback<(Guid ideaId, Guid targetProjectId)> OnMoveIdea { get; set; }

	[Parameter]
	public EventCallback<Guid> OnStartSingleIdea { get; set; }

	private string NewIdeaDescription { get; set; } = string.Empty;
	private Guid? EditingIdeaId { get; set; }
	private string EditingIdeaDescription { get; set; } = string.Empty;
	private Guid? StartingIdeaId { get; set; }

	// Modal state
	private bool ShowCopyModal { get; set; }
	private bool ShowMoveModal { get; set; }
	private Idea? SelectedIdea { get; set; }
	private Guid SelectedTargetProjectId { get; set; }
	private List<Project> AvailableProjects { get; set; } = new();
	private bool IsProcessingAction { get; set; }

	private async Task HandleKeyPress(KeyboardEventArgs e)
	{
		// Ctrl+Enter to submit for textarea
		if (e.Key == "Enter" && e.CtrlKey && !string.IsNullOrWhiteSpace(NewIdeaDescription))
		{
			await AddIdea();
		}
	}

	private async Task AddIdea()
	{
		if (string.IsNullOrWhiteSpace(NewIdeaDescription))
			return;

		await OnAddIdea.InvokeAsync(NewIdeaDescription.Trim());
		NewIdeaDescription = string.Empty;
	}

	private void StartEditIdea(Idea idea)
	{
		EditingIdeaId = idea.Id;
		EditingIdeaDescription = idea.Description;
	}

	private void CancelIdeaEdit()
	{
		EditingIdeaId = null;
		EditingIdeaDescription = string.Empty;
	}

	private async Task SaveIdeaEdit()
	{
		if (EditingIdeaId == null || string.IsNullOrWhiteSpace(EditingIdeaDescription))
			return;

		var idea = Ideas.FirstOrDefault(i => i.Id == EditingIdeaId);
		if (idea != null)
		{
			idea.Description = EditingIdeaDescription.Trim();
			await OnUpdateIdea.InvokeAsync(idea);
		}
		CancelIdeaEdit();
	}

	private async Task OpenCopyModal(Idea idea)
	{
		SelectedIdea = idea;
		SelectedTargetProjectId = Guid.Empty;
		await LoadAvailableProjects();
		ShowCopyModal = true;
	}

	private async Task OpenMoveModal(Idea idea)
	{
		SelectedIdea = idea;
		SelectedTargetProjectId = Guid.Empty;
		await LoadAvailableProjects();
		ShowMoveModal = true;
	}

	private async Task LoadAvailableProjects()
	{
		try
		{
			AvailableProjects = (await ProjectService.GetAllAsync()).ToList();
		}
		catch
		{
			AvailableProjects = new List<Project>();
		}
	}

	private void CloseModals()
	{
		ShowCopyModal = false;
		ShowMoveModal = false;
		SelectedIdea = null;
		SelectedTargetProjectId = Guid.Empty;
	}

	private async Task ConfirmCopyIdea()
	{
		if (SelectedIdea == null || SelectedTargetProjectId == Guid.Empty)
			return;

		IsProcessingAction = true;
		try
		{
			await OnCopyIdea.InvokeAsync((SelectedIdea.Id, SelectedTargetProjectId));
			CloseModals();
		}
		finally
		{
			IsProcessingAction = false;
		}
	}

	private async Task ConfirmMoveIdea()
	{
		if (SelectedIdea == null || SelectedTargetProjectId == Guid.Empty)
			return;

		IsProcessingAction = true;
		try
		{
			await OnMoveIdea.InvokeAsync((SelectedIdea.Id, SelectedTargetProjectId));
			CloseModals();
		}
		finally
		{
			IsProcessingAction = false;
		}
	}

	private async Task StartSingleIdea(Idea idea)
	{
		StartingIdeaId = idea.Id;
		try
		{
			await OnStartSingleIdea.InvokeAsync(idea.Id);
		}
		finally
		{
			StartingIdeaId = null;
		}
	}

	private bool IsIdeaProcessing(Guid ideaId)
	{
		return ProcessingIdeaIds.Contains(ideaId);
	}
}