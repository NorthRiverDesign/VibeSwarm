@* Modal component for adding and editing projects *@
@using VibeSwarm.Shared.Data
@using VibeSwarm.Shared.Services
@using VibeSwarm.Shared.VersionControl
@inject IProjectService ProjectService
@inject ISettingsService SettingsService
@inject IVersionControlService VersionControlService

<ModalDialog IsVisible="IsVisible" IsVisibleChanged="HandleModalVisibilityChanged"
	Title="@(IsEdit ? "Edit Project" : "New Project")" Icon="@(IsEdit ? "pencil" : "folder-plus")"
	Size="ModalDialog.ModalSize.Default" OnClose="HandleClose">
	<ChildContent>
		<EditForm Model="@Project" OnValidSubmit="HandleValidSubmit">
			<DataAnnotationsValidator />
			<ValidationSummary class="text-danger mb-3" />

			<div class="mb-3">
				<label for="modal-name" class="form-label">Name</label>
				<InputText id="modal-name" @bind-Value="Project.Name" class="form-control" placeholder="My Project" />
				<ValidationMessage For="@(() => Project.Name)" class="text-danger small" />
			</div>

			<div class="mb-3">
				<label for="modal-description" class="form-label">Description</label>
				<InputTextArea id="modal-description" @bind-Value="Project.Description" class="form-control" rows="2"
					placeholder="Brief description..." />
			</div>

			@if (!IsEdit)
			{
				<div class="mb-3">
					<label for="modal-githubRepo" class="form-label">
						<i class="bi bi-github me-1"></i>GitHub Repository
						<span class="text-body-secondary fw-normal">(optional)</span>
					</label>
					<div class="input-group">
						<span class="input-group-text">github.com/</span>
						<InputText id="modal-githubRepo" @bind-Value="Project.GitHubRepository" class="form-control"
							placeholder="owner/repo" @oninput="OnGitHubRepoChanged" />
					</div>
					<div class="form-text">
						Enter a GitHub repository to clone (e.g., <code>microsoft/vscode</code>).
						The repository will be cloned to the working path when creating the project.
					</div>
				</div>
			}

			<div class="mb-3">
				<label for="modal-workingPath" class="form-label">Working Path</label>
				<div class="input-group">
					<InputText id="modal-workingPath" @bind-Value="Project.WorkingPath" class="form-control"
						placeholder="@_workingPathPlaceholder" />
					<button type="button" class="btn btn-outline-secondary" @onclick="OpenDirectoryBrowser"
						title="Browse directories">
						<i class="bi bi-folder2-open"></i>
					</button>
				</div>
				<ValidationMessage For="@(() => Project.WorkingPath)" class="text-danger small" />
				<div class="form-text">Directory where CLI providers execute commands.</div>
			</div>

			@if (!string.IsNullOrEmpty(_cloneProgressMessage))
			{
				<div class="alert alert-info mb-3">
					<i class="bi bi-info-circle me-1"></i>@_cloneProgressMessage
				</div>
			}

			@if (!string.IsNullOrEmpty(ErrorMessage))
			{
				<div class="alert alert-danger mb-3">@ErrorMessage</div>
			}

			@if (!string.IsNullOrEmpty(SuccessMessage))
			{
				<div class="alert alert-success mb-3">@SuccessMessage</div>
			}

			<div class="d-flex gap-2 justify-content-end">
				<button type="button" class="btn btn-secondary" @onclick="HandleCancel">Cancel</button>
				<button type="submit" class="btn btn-primary" disabled="@IsSaving">
					@if (IsSaving)
					{
						<span class="spinner-border spinner-border-sm me-1" role="status"></span>
					}
					@if (IsSaving && _isCloning)
					{
						@:Cloning...
					}
					else
					{
						@(IsSaving ? "Saving..." : (IsEdit ? "Update Project" :
											(!string.IsNullOrWhiteSpace(Project.GitHubRepository) ? "Clone & Create" : "Create Project")))
					}
				</button>
			</div>
		</EditForm>
	</ChildContent>
</ModalDialog>

@if (_showDirectoryBrowser)
{
	<DirectoryBrowser @ref="_directoryBrowser" InitialPath="@_defaultProjectsDirectory"
		OnDirectorySelected="OnDirectorySelected" OnClosed="CloseDirectoryBrowser" />
}

@code {
	[Parameter]
	public bool IsVisible { get; set; }

	[Parameter]
	public EventCallback<bool> IsVisibleChanged { get; set; }

	[Parameter]
	public Project? EditProject { get; set; }

	[Parameter]
	public EventCallback<Guid?> OnSaved { get; set; }

	[Parameter]
	public EventCallback OnCancelled { get; set; }

	[Parameter]
	public EventCallback OnClosed { get; set; }

	private Project Project { get; set; } = new();
	private bool IsEdit => EditProject != null;
	private bool IsSaving { get; set; }
	private string? ErrorMessage { get; set; }
	private string? SuccessMessage { get; set; }
	private bool _previousIsVisible;
	private bool _isCloning;
	private string? _cloneProgressMessage;
	private bool _showDirectoryBrowser;
	private DirectoryBrowser? _directoryBrowser;
	private string? _defaultProjectsDirectory;

	private string _workingPathPlaceholder => !string.IsNullOrEmpty(_defaultProjectsDirectory)
	? Path.Combine(_defaultProjectsDirectory, "project-name")
	: (OperatingSystem.IsWindows() ? @"C:\projects\myapp" : "/home/user/projects/myapp");

	protected override async Task OnInitializedAsync()
	{
		await LoadDefaultProjectsDirectory();
	}

	private async Task LoadDefaultProjectsDirectory()
	{
		try
		{
			_defaultProjectsDirectory = await SettingsService.GetDefaultProjectsDirectoryAsync();
		}
		catch
		{
			// Ignore errors loading default directory
		}
	}

	protected override void OnParametersSet()
	{
		// Only reset state when modal is opening (transitioning from hidden to visible)
		if (IsVisible && !_previousIsVisible)
		{
			ResetState();

			if (EditProject != null)
			{
				// Clone the project for editing
				Project = new Project
				{
					Id = EditProject.Id,
					Name = EditProject.Name,
					Description = EditProject.Description,
					WorkingPath = EditProject.WorkingPath,
					GitHubRepository = EditProject.GitHubRepository,
					CreatedAt = EditProject.CreatedAt,
					UpdatedAt = EditProject.UpdatedAt
				};
			}
			else
			{
				// Reset for new project
				Project = new Project();
			}
		}

		_previousIsVisible = IsVisible;
	}

	private void OnGitHubRepoChanged(ChangeEventArgs e)
	{
		var repoValue = e.Value?.ToString() ?? string.Empty;
		Project.GitHubRepository = repoValue;

		// Auto-populate working path if it's empty or was auto-populated before
		if (!string.IsNullOrWhiteSpace(repoValue))
		{
			// Extract repo name from "owner/repo" format
			var parts = repoValue.Trim().Trim('/').Split('/');
			if (parts.Length >= 2 && !string.IsNullOrWhiteSpace(parts[1]))
			{
				var repoName = parts[1];

				// Auto-populate working path using default projects directory
				if (!string.IsNullOrEmpty(_defaultProjectsDirectory))
				{
					var suggestedPath = Path.Combine(_defaultProjectsDirectory, repoName);

					// Only auto-populate if working path is empty or matches a previously auto-populated value
					if (string.IsNullOrWhiteSpace(Project.WorkingPath) ||
					Project.WorkingPath.StartsWith(_defaultProjectsDirectory))
					{
						Project.WorkingPath = suggestedPath;
					}
				}

				// Also auto-populate the name if it's empty
				if (string.IsNullOrWhiteSpace(Project.Name))
				{
					Project.Name = repoName;
				}
			}
		}
	}

	private async Task HandleValidSubmit()
	{
		IsSaving = true;
		ErrorMessage = null;
		SuccessMessage = null;
		_cloneProgressMessage = null;

		try
		{
			Guid? newProjectId = null;

			if (IsEdit)
			{
				await ProjectService.UpdateAsync(Project);
				SuccessMessage = "Project updated successfully.";
			}
			else
			{
				// If a GitHub repository is specified, clone it first
				if (!string.IsNullOrWhiteSpace(Project.GitHubRepository))
				{
					_isCloning = true;
					StateHasChanged();

					try
					{
						// Get the clone URL
						var cloneUrl = VersionControlService.GetGitHubCloneUrl(Project.GitHubRepository);

						// Clone the repository with progress updates
						var cloneResult = await VersionControlService.CloneRepositoryAsync(
						cloneUrl,
						Project.WorkingPath,
						progressCallback: async (message) =>
						{
							_cloneProgressMessage = message;
							await InvokeAsync(StateHasChanged);
						});

						if (!cloneResult.Success)
						{
							ErrorMessage = cloneResult.Error ?? "Failed to clone repository.";
							return;
						}
					}
					catch (ArgumentException ex)
					{
						ErrorMessage = $"Invalid GitHub repository format: {ex.Message}";
						return;
					}
					finally
					{
						_isCloning = false;
						_cloneProgressMessage = null;
					}
				}

				var created = await ProjectService.CreateAsync(Project);
				newProjectId = created.Id;
				SuccessMessage = !string.IsNullOrWhiteSpace(Project.GitHubRepository)
				? "Project created and repository cloned successfully."
				: "Project created successfully.";
			}

			await OnSaved.InvokeAsync(newProjectId);
			await CloseModal();
		}
		catch (Exception ex)
		{
			ErrorMessage = $"Error saving project: {ex.Message}";
		}
		finally
		{
			IsSaving = false;
			_isCloning = false;
			_cloneProgressMessage = null;
		}
	}

	private async Task HandleCancel()
	{
		await OnCancelled.InvokeAsync();
		await CloseModal();
	}

	private async Task HandleClose()
	{
		ResetState();
		await OnClosed.InvokeAsync();
	}

	private async Task HandleModalVisibilityChanged(bool visible)
	{
		if (!visible)
		{
			ResetState();
			await IsVisibleChanged.InvokeAsync(false);
		}
	}

	private async Task CloseModal()
	{
		IsVisible = false;
		await IsVisibleChanged.InvokeAsync(false);
		ResetState();
	}

	private void ResetState()
	{
		Project = new Project();
		ErrorMessage = null;
		SuccessMessage = null;
		IsSaving = false;
		_isCloning = false;
		_cloneProgressMessage = null;
	}

	private async Task OpenDirectoryBrowser()
	{
		_showDirectoryBrowser = true;
		StateHasChanged();

		// Wait for the component to render
		await Task.Delay(50);

		if (_directoryBrowser != null)
		{
			var initialPath = !string.IsNullOrEmpty(Project.WorkingPath)
			? Project.WorkingPath
			: _defaultProjectsDirectory;
			await _directoryBrowser.ShowAsync(initialPath);
		}
	}

	private void OnDirectorySelected(string path)
	{
		Project.WorkingPath = path;
		_showDirectoryBrowser = false;
		StateHasChanged();
	}

	private void CloseDirectoryBrowser()
	{
		_showDirectoryBrowser = false;
	}
}