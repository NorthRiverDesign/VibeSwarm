@* Reusable project card component for project listings *@
@using VibeSwarm.Shared.Data

<a href="/projects/@ProjectId"
	class="card h-100 text-decoration-none border-start border-3 project-card-hover @GetBorderColorClass()">
	<div class="card-body">
		<h6 class="card-title fw-semibold mb-2">@Name</h6>
		@if (!string.IsNullOrEmpty(Description))
		{
			<p class="card-text small text-body-secondary mb-2">@TruncateText(Description, 60)</p>
		}

		@* Repository or Working Path *@
		<div class="mb-2">
			@if (!string.IsNullOrEmpty(GitHubRepository))
			{
				<div class="d-flex align-items-center gap-2 small">
					<i class="bi bi-github opacity-75"></i>
					<span class="text-body-secondary font-monospace text-truncate" style="max-width: 150px;"
						title="@GitHubRepository">
						@GitHubRepository
					</span>
					@if (!string.IsNullOrEmpty(CurrentBranch))
					{
						<span class="badge bg-secondary-subtle text-secondary-emphasis">
							<i class="bi bi-git me-1"></i>@TruncateText(CurrentBranch, 15)
						</span>
					}
				</div>
			}
			else
			{
				<small class="text-body-secondary font-monospace text-truncate d-block" style="max-width: 220px;"
					title="@WorkingPath">
					<i class="bi bi-folder2 me-1 opacity-75"></i>@TruncateText(WorkingPath, 30)
				</small>
			}
		</div>

		@* Latest Job Status *@
		@if (LatestJob != null)
		{
			<div class="border-top pt-2 mt-2">
				<div class="d-flex align-items-center gap-2 mb-1">
					<span class="badge @GetStatusBadgeClass(LatestJob.Status) d-flex align-items-center gap-1">
						<i class="bi @GetStatusIcon(LatestJob.Status)"></i>
						@LatestJob.Status
					</span>
					<small class="text-body-tertiary">@FormatTimeAgo(LatestJob.CreatedAt)</small>
				</div>
				<p class="card-text small text-body-secondary mb-0 text-truncate" title="@LatestJob.GoalPrompt">
					@TruncateText(LatestJob.GoalPrompt, 55)
				</p>
			</div>
		}
		else
		{
			<div class="border-top pt-2 mt-2">
				<small class="text-body-tertiary fst-italic">No jobs yet</small>
			</div>
		}
	</div>
</a>

@code {
	[Parameter]
	public Guid ProjectId { get; set; }

	[Parameter]
	public string Name { get; set; } = string.Empty;

	[Parameter]
	public string? Description { get; set; }

	[Parameter]
	public string WorkingPath { get; set; } = string.Empty;

	[Parameter]
	public string? GitHubRepository { get; set; }

	[Parameter]
	public string? CurrentBranch { get; set; }

	[Parameter]
	public Job? LatestJob { get; set; }

	[Parameter]
	public DateTime CreatedAt { get; set; }

	private string GetBorderColorClass()
	{
		if (LatestJob == null) return "border-secondary";

		return LatestJob.Status switch
		{
			JobStatus.Completed => "border-success",
			JobStatus.Failed => "border-danger",
			JobStatus.Processing or JobStatus.Started => "border-primary",
			JobStatus.Paused => "border-warning",
			JobStatus.Stalled => "border-warning",
			JobStatus.Cancelled => "border-secondary",
			_ => "border-secondary"
		};
	}

	private static string GetStatusBadgeClass(JobStatus status)
	{
		return status switch
		{
			JobStatus.Completed => "bg-success-subtle text-success-emphasis",
			JobStatus.Failed => "bg-danger-subtle text-danger-emphasis",
			JobStatus.Processing or JobStatus.Started => "bg-primary-subtle text-primary-emphasis",
			JobStatus.Paused => "bg-warning-subtle text-warning-emphasis",
			JobStatus.Stalled => "bg-warning-subtle text-warning-emphasis",
			JobStatus.Cancelled => "bg-secondary-subtle text-secondary-emphasis",
			JobStatus.New or JobStatus.Pending => "bg-info-subtle text-info-emphasis",
			_ => "bg-secondary-subtle text-secondary-emphasis"
		};
	}

	private static string GetStatusIcon(JobStatus status)
	{
		return status switch
		{
			JobStatus.Completed => "bi-check-circle-fill",
			JobStatus.Failed => "bi-x-circle-fill",
			JobStatus.Processing or JobStatus.Started => "bi-arrow-repeat",
			JobStatus.Paused => "bi-pause-circle-fill",
			JobStatus.Stalled => "bi-exclamation-triangle-fill",
			JobStatus.Cancelled => "bi-dash-circle-fill",
			JobStatus.New or JobStatus.Pending => "bi-hourglass-split",
			_ => "bi-circle"
		};
	}

	private static string TruncateText(string text, int maxLength)
	{
		if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
			return text;
		return text[..maxLength] + "...";
	}

	private static string FormatTimeAgo(DateTime dateTime)
	{
		var timeSpan = DateTime.UtcNow - dateTime;

		if (timeSpan.TotalMinutes < 1)
			return "just now";
		if (timeSpan.TotalMinutes < 60)
			return $"{(int)timeSpan.TotalMinutes}m ago";
		if (timeSpan.TotalHours < 24)
			return $"{(int)timeSpan.TotalHours}h ago";
		if (timeSpan.TotalDays < 7)
			return $"{(int)timeSpan.TotalDays}d ago";

		return dateTime.ToLocalTime().ToString("MMM d");
	}
}