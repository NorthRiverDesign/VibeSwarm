@* Unified job session panel - combines session log, error, console output, command, and live output *@
@inject IJSRuntime JSRuntime

<div class="card d-flex flex-column">
    <div class="card-header bg-body-secondary p-0">
        <div class="d-flex align-items-center justify-content-between border-bottom border-secondary border-opacity-25">
            @* Tabs *@
            <ul class="nav nav-tabs nav-tabs-card border-0 flex-grow-1 flex-nowrap" role="tablist">
                <li class="nav-item" role="presentation">
                    <button type="button" class="nav-link px-2 px-sm-3 @(_activeTab == "session" ? "active" : "")"
                        @onclick="@(() => _activeTab = "session")" role="tab">
                        @if (IsJobActive)
                        {
                            <span class="live-indicator me-1"></span>
                            <span>Live Output</span>
                        }
                        else if (Status == JobStatus.Completed)
                        {
                            <i class="bi bi-check-circle me-1 opacity-75 text-success"></i>
                            <span class="d-none d-sm-inline">Session Log</span>
                            <span class="d-sm-none">Log</span>
                        }
                        else if (Status == JobStatus.Failed || Status == JobStatus.Cancelled)
                        {
                            <i class="bi bi-x-circle me-1 opacity-75 text-danger"></i>
                            <span class="d-none d-sm-inline">Session Log</span>
                            <span class="d-sm-none">Log</span>
                        }
                        else
                        {
                            <i class="bi bi-chat-dots me-1 opacity-75"></i>
                            <span class="d-none d-sm-inline">Session Log</span>
                            <span class="d-sm-none">Log</span>
                        }
                    </button>
                </li>
                @if (!string.IsNullOrEmpty(ConsoleOutput) && !IsJobActive)
                {
                    <li class="nav-item" role="presentation">
                        <button type="button" class="nav-link px-2 px-sm-3 @(_activeTab == "console" ? "active" : "")"
                            @onclick="@(() => _activeTab = "console")" role="tab">
                            <i class="bi bi-terminal me-1 opacity-75"></i>
                            <span class="d-none d-sm-inline">Console Output</span>
                            <span class="d-sm-none">Console</span>
                        </button>
                    </li>
                }
                @if (!string.IsNullOrEmpty(CommandUsed))
                {
                    <li class="nav-item" role="presentation">
                        <button type="button" class="nav-link px-2 px-sm-3 @(_activeTab == "command" ? "active" : "")"
                            @onclick="@(() => _activeTab = "command")" role="tab">
                            <i class="bi bi-terminal-fill me-1 opacity-75"></i>
                            <span>Command</span>
                        </button>
                    </li>
                }
            </ul>
            @* Actions *@
            <div class="d-flex align-items-center gap-1 px-2">
                @if (IsJobActive && LiveOutputLines.Any())
                {
                    <ActionButton Icon="trash" Text="Clear" Outline="true" Size="ActionButton.ButtonSize.Small"
                        HideTextOnMobile="true" OnClick="OnClearLiveOutput" />
                }
            </div>
        </div>
    </div>

    @* Error Alert - inside the card when job has an error *@
    @if (!string.IsNullOrEmpty(ErrorMessage) && _activeTab == "session")
    {
        <div class="alert alert-danger d-flex align-items-start gap-2 m-2 mb-0" role="alert">
            <i class="bi bi-exclamation-triangle-fill flex-shrink-0 mt-1"></i>
            <div class="flex-grow-1 min-width-0">
                <strong class="d-block mb-1">Error</strong>
                <pre class="mb-0 small font-monospace overflow-auto"
                    style="white-space: pre-wrap; max-height: 150px;">@ErrorMessage</pre>
            </div>
        </div>
    }

    <div class="card-body p-0 flex-grow-1 overflow-hidden d-flex flex-column" style="min-height: 300px;">
        @if (_activeTab == "session")
        {
            @if (IsJobActive)
            {
                @* Live Output *@
                @if (LiveOutputLines.Any())
                {
                    <div class="terminal-output flex-grow-1 p-3 overflow-auto rounded-bottom small" style="max-height: 300px;">
                        @foreach (var line in LiveOutputLines.TakeLast(MaxOutputLines))
                        {
                            <div class="output-line d-flex gap-2 py-0 @(line.IsError ? "output-error" : "output-stdout")">
                                <span class="output-time flex-shrink-0 small d-none d-sm-inline">[@line.Timestamp.FormatTime()]</span>
                                <span class="output-text text-break">@line.Content</span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    @* Waiting for output placeholder *@
                    <div class="d-flex flex-column justify-content-center align-items-center flex-grow-1 py-5">
                        <div class="spinner-border text-info mb-3" role="status">
                            <span class="visually-hidden">Waiting for output...</span>
                        </div>
                        <p class="text-body-secondary mb-0">Waiting for agent output...</p>
                    </div>
                }
            }
            else
            {
                @* Session Log / Conversation *@
                <div class="flex-grow-1 overflow-auto p-2 p-sm-3">
                    @if (Messages.Any())
                    {
                        <div class="d-flex justify-content-end mb-2">
                            <span class="badge bg-secondary">@Messages.Count messages</span>
                        </div>
                    }
                    @if (!Messages.Any())
                    {
                        <div class="empty-state text-center py-5">
                            @if (Status == JobStatus.Completed)
                            {
                                <i class="bi bi-check-circle opacity-50 d-block mb-2" style="font-size: 2.5rem;"></i>
                                <span class="text-body-secondary">Job completed but no conversation was recorded.</span>
                            }
                            else if (Status == JobStatus.Failed)
                            {
                                <i class="bi bi-exclamation-circle opacity-50 d-block mb-2" style="font-size: 2.5rem;"></i>
                                <span class="text-body-secondary">Job failed. Check the error message above for details.</span>
                            }
                            else if (Status == JobStatus.Cancelled)
                            {
                                <i class="bi bi-x-circle opacity-50 d-block mb-2" style="font-size: 2.5rem;"></i>
                                <span class="text-body-secondary">Job was cancelled. No conversation recorded.</span>
                            }
                            else if (Status == JobStatus.New || Status == JobStatus.Pending)
                            {
                                <i class="bi bi-hourglass opacity-50 d-block mb-2" style="font-size: 2.5rem;"></i>
                                <span class="text-body-secondary">Conversation will appear after the job runs.</span>
                            }
                            else
                            {
                                <i class="bi bi-chat-left-text opacity-50 d-block mb-2" style="font-size: 2.5rem;"></i>
                                <span class="text-body-secondary">No conversation recorded for this job.</span>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="d-flex flex-column gap-3 overflow-auto p-2" style="max-height: 600px;">
                            @foreach (var message in Messages)
                            {
                                <ChatMessage Role="@message.Role" Content="@message.Content" ToolName="@message.ToolName"
                                    ToolInput="@message.ToolInput" ToolOutput="@message.ToolOutput" Timestamp="@message.CreatedAt" />
                            }
                        </div>
                    }
                </div>
            }
        }
        else if (_activeTab == "console")
        {
            <pre class="terminal-output flex-grow-1 m-0 p-3 overflow-auto rounded-bottom small text-break"
                style="max-height: 400px;">@ConsoleOutput</pre>
        }
        else if (_activeTab == "command")
        {
            <div class="p-3 flex-grow-1 overflow-auto">
                <div class="d-flex justify-content-end mb-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CopyCommandToClipboard"
                        title="Copy command to clipboard">
                        <i class="bi bi-clipboard me-1"></i>
                        <span class="d-none d-sm-inline">Copy</span>
                    </button>
                </div>
                <div class="p-3 bg-body-tertiary rounded border">
                    <code class="small d-block text-break" style="white-space: pre-wrap;">@CommandUsed</code>
                </div>
                @if (!string.IsNullOrEmpty(SessionId))
                {
                    <div class="mt-3">
                        <StatItem Label="Session ID" Value="@SessionId" Monospace="true" />
                    </div>
                }
            </div>
        }
    </div>

    @* Follow-up input section - only for completed jobs *@
    @if (CanSendFollowUp)
    {
        <div class="card-footer bg-body-tertiary border-top">
            <div class="d-flex gap-2">
                <textarea class="form-control" rows="2" placeholder="Add follow-up instructions..." @bind="_followUpPrompt"
                    @bind:event="oninput" disabled="@_isSendingFollowUp"></textarea>
                <button class="btn btn-primary align-self-end flex-shrink-0" @onclick="SendFollowUp"
                    disabled="@(string.IsNullOrWhiteSpace(_followUpPrompt) || _isSendingFollowUp)" title="Send follow-up">
                    @if (_isSendingFollowUp)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                    }
                    else
                    {
                        <i class="bi bi-send"></i>
                    }
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public List<JobMessage> Messages { get; set; } = new();

    [Parameter]
    public JobStatus Status { get; set; }

    [Parameter]
    public bool IsJobActive { get; set; }

    [Parameter]
    public string? ErrorMessage { get; set; }

    [Parameter]
    public string? ConsoleOutput { get; set; }

    [Parameter]
    public string? CommandUsed { get; set; }

    [Parameter]
    public string? SessionId { get; set; }

    [Parameter]
    public List<OutputLine> LiveOutputLines { get; set; } = new();

    [Parameter]
    public int MaxOutputLines { get; set; } = 500;

    [Parameter]
    public EventCallback OnClearLiveOutput { get; set; }

    [Parameter]
    public EventCallback<string> OnSendFollowUp { get; set; }

    private string _activeTab = "session";
    private string _followUpPrompt = string.Empty;
    private bool _isSendingFollowUp = false;

    private bool CanSendFollowUp => Status == JobStatus.Completed && OnSendFollowUp.HasDelegate;

    private async Task SendFollowUp()
    {
        if (string.IsNullOrWhiteSpace(_followUpPrompt) || _isSendingFollowUp) return;

        _isSendingFollowUp = true;
        try
        {
            await OnSendFollowUp.InvokeAsync(_followUpPrompt);
            _followUpPrompt = string.Empty;
        }
        finally
        {
            _isSendingFollowUp = false;
        }
    }

    private async Task CopyCommandToClipboard()
    {
        if (!string.IsNullOrEmpty(CommandUsed))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", CommandUsed);
        }
    }
}