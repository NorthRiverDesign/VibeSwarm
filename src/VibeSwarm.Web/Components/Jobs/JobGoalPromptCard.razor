@* Goal prompt display card with tabs for Prompt/Command and editable support *@

<div class="card mb-3 mb-lg-4">
	<div class="card-header bg-body-secondary p-0">
		<div class="d-flex align-items-center justify-content-between border-bottom border-secondary border-opacity-25">
			@* Tabs *@
			<ul class="nav nav-tabs nav-tabs-card border-0 flex-grow-1" role="tablist">
				<li class="nav-item" role="presentation">
					<button type="button" class="nav-link @(_activeTab == "prompt" ? "active" : "")"
						@onclick="@(() => _activeTab = "prompt")" role="tab">
						<i class="bi bi-bullseye me-1 opacity-75"></i>
						<span class="d-none d-sm-inline">Goal Prompt</span>
						<span class="d-sm-none">Prompt</span>
					</button>
				</li>
				@if (!string.IsNullOrEmpty(CommandUsed))
				{
					<li class="nav-item" role="presentation">
						<button type="button" class="nav-link @(_activeTab == "command" ? "active" : "")"
							@onclick="@(() => _activeTab = "command")" role="tab">
							<i class="bi bi-terminal me-1 opacity-75"></i>
							<span>Command</span>
						</button>
					</li>
				}
			</ul>
			@* Actions *@
			<div class="d-flex align-items-center gap-1 px-2">
				@if (IsEditable && _isEditing)
				{
					<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CancelEdit"
						title="Cancel editing">
						<i class="bi bi-x-lg"></i>
					</button>
					<button type="button" class="btn btn-sm btn-primary" @onclick="SavePrompt" disabled="@_isSaving"
						title="Save changes">
						@if (_isSaving)
						{
							<span class="spinner-border spinner-border-sm" role="status"></span>
						}
						else
						{
							<i class="bi bi-check-lg"></i>
						}
					</button>
				}
				else
				{
					@if (IsEditable)
					{
						<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="StartEdit" title="Edit prompt">
							<i class="bi bi-pencil"></i>
						</button>
					}
					<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ShowFullPrompt"
						title="View full">
						<i class="bi bi-arrows-fullscreen"></i>
					</button>
				}
			</div>
		</div>
	</div>
	<div class="card-body d-flex flex-column gap-3">
		@if (_activeTab == "prompt")
		{
			@if (IsEditable && _isEditing)
			{
				<textarea class="form-control goal-prompt-textarea" @bind="_editedPrompt" rows="6"
					placeholder="Enter the goal prompt for the AI agent..."></textarea>
			}
			else
			{
				<div class="goal-prompt-box">@GoalPrompt</div>
			}
		}
		else if (_activeTab == "command")
		{
			<div class="p-2 bg-body-tertiary rounded border">
				<code class="small d-block text-break"
					style="white-space: pre-wrap; word-break: break-all;">@CommandUsed</code>
			</div>
		}

		@if (!string.IsNullOrEmpty(SessionId))
		{
			<div class="d-flex flex-wrap gap-2">
				<StatItem Label="Session ID" Value="@SessionId" Monospace="true" />
			</div>
		}

		@if (!string.IsNullOrEmpty(ErrorMessage))
		{
			<div>
				<h6 class="text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>Error</h6>
				<pre class="error-output">@ErrorMessage</pre>
			</div>
		}

		@if (Status == JobStatus.Cancelled)
		{
			<div class="info-section">
				<h6>Job Cancelled</h6>
				<p class="mb-0">This job was cancelled. You can edit the prompt and retry.</p>
			</div>
		}
		else if (Status == JobStatus.Failed && CanRetry)
		{
			<div class="info-section">
				<h6>Job Failed</h6>
				@if (string.IsNullOrEmpty(ErrorMessage) && HasConsoleOutput)
				{
					<p class="mb-0">Check the console output for details. You can edit the prompt and retry.</p>
				}
				else
				{
					<p class="mb-0">You can edit the prompt and retry.</p>
				}
			</div>
		}
		else if (Status == JobStatus.New)
		{
			<div class="info-section">
				<h6>Pending Execution</h6>
				<p class="mb-0">This job is queued for processing. You can edit the prompt before it starts.</p>
			</div>
		}
	</div>
</div>

@* Full Prompt Modal *@
@if (_showModal)
{
	<div class="modal-backdrop fade show vs-modal-backdrop"></div>
	<div class="modal fade show d-block vs-modal-container" tabindex="-1" role="dialog" @onclick="CloseModal">
		<div class="modal-dialog modal-lg vs-modal-dialog modal-dialog-centered modal-dialog-scrollable"
			@onclick:stopPropagation="true">
			<div class="modal-content vs-modal-content">
				<div class="modal-header">
					<h5 class="modal-title"><i class="bi bi-file-text me-2"></i>Full Input Prompt</h5>
					<button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<pre class="full-prompt-content">@GoalPrompt</pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" @onclick="CopyToClipboard">
						<i class="bi bi-clipboard me-1"></i>Copy to Clipboard
					</button>
					<button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
				</div>
			</div>
		</div>
	</div>
}

@code {
	[Parameter, EditorRequired]
	public string GoalPrompt { get; set; } = string.Empty;

	[Parameter]
	public string? CommandUsed { get; set; }

	[Parameter]
	public string? SessionId { get; set; }

	[Parameter]
	public string? ErrorMessage { get; set; }

	[Parameter]
	public JobStatus Status { get; set; }

	[Parameter]
	public bool CanRetry { get; set; }

	[Parameter]
	public bool HasConsoleOutput { get; set; }

	[Parameter]
	public EventCallback OnCopyToClipboard { get; set; }

	[Parameter]
	public EventCallback<string> OnPromptChanged { get; set; }

	private bool _showModal = false;
	private string _activeTab = "prompt";
	private bool _isEditing = false;
	private string _editedPrompt = string.Empty;
	private bool _isSaving = false;

	private bool IsEditable => Status == JobStatus.New || Status == JobStatus.Failed || Status == JobStatus.Cancelled;

	private void ShowFullPrompt()
	{
		_showModal = true;
	}

	private void CloseModal()
	{
		_showModal = false;
	}

	private async Task CopyToClipboard()
	{
		await OnCopyToClipboard.InvokeAsync();
	}

	private void StartEdit()
	{
		_editedPrompt = GoalPrompt;
		_isEditing = true;
	}

	private void CancelEdit()
	{
		_isEditing = false;
		_editedPrompt = string.Empty;
	}

	private async Task SavePrompt()
	{
		if (string.IsNullOrWhiteSpace(_editedPrompt)) return;

		_isSaving = true;
		try
		{
			await OnPromptChanged.InvokeAsync(_editedPrompt);
			_isEditing = false;
		}
		finally
		{
			_isSaving = false;
		}
	}
}