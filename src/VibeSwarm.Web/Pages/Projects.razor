@page "/projects"
@attribute [Authorize]
@inject IProjectService ProjectService
@inject IJobService JobService
@inject ISettingsService SettingsService
@inject IFileSystemService FileSystemService
@inject NavigationManager NavigationManager
@implements IDisposable
@using VibeSwarm.Shared.Utilities

<PageHeader Title="Projects" />

<div class="row g-3 g-lg-4">
    @* Form first on mobile, second on desktop *@
    <div class="col-12 col-lg-4 order-1 order-lg-2">
        <div class="card">
            <div class="card-header bg-body-secondary">
                <h5 class="mb-0 fw-semibold">@(IsEditing ? "Edit Project" : "New Project")</h5>
            </div>
            <div class="card-body">
                <EditForm Model="@CurrentProject" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger mb-3" />

                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <InputText id="name" @bind-Value="CurrentProject.Name" class="form-control"
                            placeholder="My Project" />
                        <ValidationMessage For="@(() => CurrentProject.Name)" class="text-danger small" />
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <InputTextArea id="description" @bind-Value="CurrentProject.Description" class="form-control"
                            rows="2" placeholder="Brief description..." />
                    </div>

                    <div class="mb-3">
                        <label for="workingPath" class="form-label">Working Path</label>
                        <div class="input-group">
                            <InputText id="workingPath" @bind-Value="CurrentProject.WorkingPath" class="form-control"
                                placeholder="@_workingPathPlaceholder" />
                            <button type="button" class="btn btn-outline-secondary" @onclick="OpenDirectoryBrowser"
                                title="Browse directories">
                                <i class="bi bi-folder2-open"></i>
                            </button>
                        </div>
                        <ValidationMessage For="@(() => CurrentProject.WorkingPath)" class="text-danger small" />
                        <div class="form-text">Directory where CLI providers execute commands.</div>
                    </div>

                    <div class="d-flex flex-column flex-sm-row gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1" disabled="@IsSaving">
                            @if (IsSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            }
                            @(IsSaving ? "Saving..." : (IsEditing ? "Update" : "Create"))
                        </button>
                        @if (IsEditing)
                        {
                            <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger mt-3 mb-0">@ErrorMessage</div>
                    }

                    @if (!string.IsNullOrEmpty(SuccessMessage))
                    {
                        <div class="alert alert-success mt-3 mb-0">@SuccessMessage</div>
                    }
                </EditForm>
            </div>
        </div>
    </div>

    @* List second on mobile, first on desktop *@
    <div class="col-12 col-lg-8 order-2 order-lg-1">
        <div class="card">
            <div class="card-header bg-body-secondary">
                <h5 class="mb-0 fw-semibold">All Projects</h5>
            </div>
            <div class="card-body p-0">
                @if (IsLoading)
                {
                    <LoadingSpinner />
                }
                else if (!ProjectsWithStats.Any())
                {
                    <div class="p-3">
                        <EmptyState Icon="folder" Title="No projects yet"
                            Message="Create your first project to start running AI agent jobs." />
                    </div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var projectWithStats in ProjectsWithStats)
                        {
                            var project = projectWithStats.Project;
                            var stats = projectWithStats.Stats;
                            var projectActiveJobs = ActiveJobs.Where(j => j.ProjectId == project.Id).ToList();
                            <div
                                class="list-group-item d-flex flex-column flex-md-row align-items-md-center gap-2 gap-md-3 p-3 hover-bg-tertiary">
                                <div class="flex-grow-1 min-width-0">
                                    <div class="fw-semibold">
                                        <a href="/projects/@project.Id" class="text-decoration-none">@project.Name</a>
                                    </div>
                                    @if (!string.IsNullOrEmpty(project.Description))
                                    {
                                        <div class="small text-body-secondary">@TruncateText(project.Description, 80)</div>
                                    }
                                    <div class="d-flex flex-wrap gap-2 gap-md-3 mt-2 small text-body-secondary">
                                        <span class="font-monospace bg-body-tertiary px-2 py-1 rounded-1 text-truncate"
                                            style="max-width: 250px;">
                                            @project.WorkingPath
                                        </span>
                                        <span class="d-flex align-items-center gap-1">
                                            <i class="bi bi-calendar-plus opacity-75"></i>
                                            @project.CreatedAt.FormatDateTimeShort()
                                        </span>
                                    </div>
                                    @* Job Statistics Row *@
                                    @if (stats.TotalJobs > 0)
                                    {
                                        <div class="d-flex flex-wrap gap-2 gap-md-3 mt-2 small">
                                            <span class="d-flex align-items-center gap-1 text-body-secondary" title="Total jobs">
                                                <i class="bi bi-list-check opacity-75"></i>
                                                @stats.TotalJobs jobs
                                            </span>
                                            @if (stats.TotalInputTokens > 0 || stats.TotalOutputTokens > 0)
                                            {
                                                <span class="d-flex align-items-center gap-1 text-body-secondary"
                                                    title="Total tokens (input / output)">
                                                    <i class="bi bi-braces opacity-75"></i>
                                                    @TokenHelper.FormatTokenCount(stats.TotalInputTokens) /
                                                    @TokenHelper.FormatTokenCount(stats.TotalOutputTokens)
                                                </span>
                                            }
                                            @if (stats.TotalCostUsd > 0)
                                            {
                                                <span class="d-flex align-items-center gap-1 text-success fw-medium" title="Total cost">
                                                    <i class="bi bi-currency-dollar opacity-75"></i>
                                                    @TokenHelper.FormatCost(stats.TotalCostUsd)
                                                </span>
                                            }
                                        </div>
                                    }
                                    @if (projectActiveJobs.Any())
                                    {
                                        <div class="border-top pt-2 mt-2">
                                            @foreach (var job in projectActiveJobs)
                                            {
                                                <div class="active-job-item">
                                                    <a href="/jobs/@job.Id"
                                                        class="d-flex align-items-center gap-2 text-decoration-none">
                                                        <StatusBadge Status="@job.Status.ToString()" />
                                                        <span class="text-truncate"
                                                            style="max-width: 200px;">@TruncateText(job.GoalPrompt, 50)</span>
                                                        @if (!string.IsNullOrEmpty(job.CurrentActivity))
                                                        {
                                                            <span class="job-activity d-none d-md-inline">@job.CurrentActivity</span>
                                                        }
                                                    </a>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                                <div class="d-flex flex-wrap gap-2 flex-shrink-0">
                                    <ActionButton Icon="pencil" Text="Edit" Outline="true" Size="ActionButton.ButtonSize.Small"
                                        HideTextOnMobile="true" OnClick="@(() => EditProject(project))" />
                                    <ActionButton Icon="trash" Text="Delete" Outline="true" Size="ActionButton.ButtonSize.Small"
                                        Style="ActionButton.ButtonStyle.Danger" HideTextOnMobile="true"
                                        OnClick="@(() => DeleteProject(project.Id))" />
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (_showDirectoryBrowser)
{
    <DirectoryBrowser @ref="_directoryBrowser" InitialPath="@_defaultProjectsDirectory"
        OnDirectorySelected="OnDirectorySelected" OnClosed="CloseDirectoryBrowser" />
}

@code {
    private List<ProjectWithStats> ProjectsWithStats { get; set; } = new();
    private List<Job> ActiveJobs { get; set; } = new();
    private Project CurrentProject { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private bool IsSaving { get; set; }
    private bool IsEditing { get; set; }
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }
    private System.Threading.Timer? _refreshTimer;
    private bool _showDirectoryBrowser = false;
    private DirectoryBrowser? _directoryBrowser;
    private string? _defaultProjectsDirectory;

    private string _workingPathPlaceholder => !string.IsNullOrEmpty(_defaultProjectsDirectory)
    ? Path.Combine(_defaultProjectsDirectory, "project-name")
    : (OperatingSystem.IsWindows() ? @"C:\projects\myapp" : "/home/user/projects/myapp");

    protected override async Task OnInitializedAsync()
    {
        await LoadDefaultProjectsDirectory();
        await LoadProjects();
        await LoadActiveJobs();
        StartAutoRefresh();
    }

    private async Task LoadDefaultProjectsDirectory()
    {
        try
        {
            _defaultProjectsDirectory = await SettingsService.GetDefaultProjectsDirectoryAsync();
        }
        catch
        {
            // Ignore errors loading default directory
        }
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (ActiveJobs.Any())
            {
                await InvokeAsync(async () =>
        {
            await LoadActiveJobs();
            StateHasChanged();
        });
            }
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private async Task LoadActiveJobs()
    {
        try
        {
            ActiveJobs = (await JobService.GetActiveJobsAsync()).ToList();
        }
        catch
        {
            // Ignore errors loading active jobs
        }
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text[..maxLength] + "...";
    }

    private async Task LoadProjects()
    {
        IsLoading = true;
        try
        {
            ProjectsWithStats = (await ProjectService.GetAllWithStatsAsync()).ToList();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        IsSaving = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            if (IsEditing)
            {
                await ProjectService.UpdateAsync(CurrentProject);
                SuccessMessage = "Project updated successfully.";
            }
            else
            {
                await ProjectService.CreateAsync(CurrentProject);
                SuccessMessage = "Project created successfully.";
            }

            CurrentProject = new Project();
            IsEditing = false;
            await LoadProjects();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error saving project: {ex.Message}";
        }
        finally
        {
            IsSaving = false;
        }
    }

    private void EditProject(Project project)
    {
        CurrentProject = new Project
        {
            Id = project.Id,
            Name = project.Name,
            Description = project.Description,
            WorkingPath = project.WorkingPath
        };
        IsEditing = true;
        ErrorMessage = null;
        SuccessMessage = null;
    }

    private void CancelEdit()
    {
        CurrentProject = new Project();
        IsEditing = false;
        ErrorMessage = null;
        SuccessMessage = null;
    }

    private async Task DeleteProject(Guid id)
    {
        try
        {
            await ProjectService.DeleteAsync(id);
            await LoadProjects();
            SuccessMessage = "Project deleted successfully.";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error deleting project: {ex.Message}";
        }
    }

    private async Task OpenDirectoryBrowser()
    {
        _showDirectoryBrowser = true;
        StateHasChanged();

        // Wait for the component to render
        await Task.Delay(50);

        if (_directoryBrowser != null)
        {
            var initialPath = !string.IsNullOrEmpty(CurrentProject.WorkingPath)
            ? CurrentProject.WorkingPath
            : _defaultProjectsDirectory;
            await _directoryBrowser.ShowAsync(initialPath);
        }
    }

    private void OnDirectorySelected(string path)
    {
        CurrentProject.WorkingPath = path;
        _showDirectoryBrowser = false;
        StateHasChanged();
    }

    private void CloseDirectoryBrowser()
    {
        _showDirectoryBrowser = false;
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}