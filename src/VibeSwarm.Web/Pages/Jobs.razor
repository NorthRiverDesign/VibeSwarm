@page "/jobs"
@page "/jobs/{ProjectFilter:guid?}"
@attribute [Authorize]
@inject IJobService JobService
@inject IProjectService ProjectService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@using System.Threading

@if (_isLoading)
{
    <LoadingSpinner />
}
else
{
    @* Mobile: Project filter dropdown *@
    <div class="d-lg-none mb-3 jobs-mobile-filters">
        <div class="d-flex flex-column gap-2">
            <select class="form-select form-select-sm w-100" @onchange="OnProjectFilterChanged">
                <option value="" selected="@(_selectedProjectId == null)">All Projects</option>
                @foreach (var project in _projects)
                {
                    <option value="@project.Id" selected="@(_selectedProjectId == project.Id)">
                        @project.Name (@GetJobCountForProject(project.Id))
                    </option>
                }
            </select>
            <div class="btn-group w-100" role="group" aria-label="Status filter">
                <button type="button" class="btn btn-sm @(_statusFilter == "all" ? "btn-primary" : "btn-outline-secondary")"
                    @onclick='() => SetStatusFilter("all")' title="All">
                    <i class="bi bi-inbox me-1"></i><span class="d-none d-sm-inline">All</span>
                </button>
                <button type="button" class="btn btn-sm @(_statusFilter == "active" ? "btn-info" : "btn-outline-secondary")"
                    @onclick='() => SetStatusFilter("active")' title="Active">
                    <i class="bi bi-play-circle me-1"></i><span class="d-none d-sm-inline">Active</span>
                </button>
                <button type="button"
                    class="btn btn-sm @(_statusFilter == "completed" ? "btn-success" : "btn-outline-secondary")"
                    @onclick='() => SetStatusFilter("completed")' title="Completed">
                    <i class="bi bi-check-circle me-1"></i><span class="d-none d-sm-inline">Done</span>
                </button>
                <button type="button"
                    class="btn btn-sm @(_statusFilter == "failed" ? "btn-danger" : "btn-outline-secondary")"
                    @onclick='() => SetStatusFilter("failed")' title="Failed">
                    <i class="bi bi-x-circle me-1"></i><span class="d-none d-sm-inline">Failed</span>
                </button>
            </div>
        </div>
    </div>

    @* Desktop: Inbox-style split layout *@
    <div class="jobs-inbox-layout d-flex flex-column">
        @* Project Sidebar (desktop only) *@
        <aside class="jobs-project-sidebar d-none d-lg-flex flex-column border-end bg-body flex-shrink-0">
            <div class="p-3 border-bottom">
                <h5 class="mb-0 fw-semibold d-flex align-items-center gap-2">
                    <i class="bi bi-inbox"></i> Jobs
                </h5>
            </div>
            <div class="flex-grow-1 overflow-auto">
                @* All Projects option *@
                <button type="button"
                    class="project-filter-item w-100 text-start border-0 bg-transparent d-flex align-items-center gap-2 p-3 cursor-pointer @(_selectedProjectId == null ? "active" : "")"
                    @onclick="() => SelectProject(null)">
                    <i class="bi bi-collection"></i>
                    <span class="flex-grow-1">All Projects</span>
                    <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">@_jobs?.Count()</span>
                </button>

                <div class="border-top"></div>

                @* Project list *@
                @foreach (var project in _projects)
                {
                    var jobCount = GetJobCountForProject(project.Id);
                    var activeCount = GetActiveCountForProject(project.Id);
                    <button type="button"
                        class="project-filter-item w-100 text-start border-0 bg-transparent d-flex align-items-center gap-2 p-3 cursor-pointer @(_selectedProjectId == project.Id ? "active" : "")"
                        @onclick="() => SelectProject(project.Id)">
                        <i class="bi bi-folder"></i>
                        <span class="flex-grow-1 text-truncate">@project.Name</span>
                        @if (activeCount > 0)
                        {
                            <span class="badge bg-info rounded-pill">@activeCount</span>
                        }
                        <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">@jobCount</span>
                    </button>
                }
            </div>

            @* Status filter buttons in sidebar footer *@
            <div class="p-3 border-top">
                <div class="btn-group w-100" role="group">
                    <button type="button"
                        class="btn btn-sm @(_statusFilter == "all" ? "btn-primary" : "btn-outline-secondary")"
                        @onclick='() => SetStatusFilter("all")'>All</button>
                    <button type="button"
                        class="btn btn-sm @(_statusFilter == "active" ? "btn-info" : "btn-outline-secondary")"
                        @onclick='() => SetStatusFilter("active")'>Active</button>
                    <button type="button"
                        class="btn btn-sm @(_statusFilter == "completed" ? "btn-success" : "btn-outline-secondary")"
                        @onclick='() => SetStatusFilter("completed")'>Done</button>
                    <button type="button"
                        class="btn btn-sm @(_statusFilter == "failed" ? "btn-danger" : "btn-outline-secondary")"
                        @onclick='() => SetStatusFilter("failed")'>Failed</button>
                </div>
            </div>
        </aside>

        @* Job List Panel *@
        <div class="jobs-list-panel flex-grow-1 d-flex flex-column min-width-0 bg-body">
            @* Stats header *@
            @if (HasTokenData())
            {
                <div class="d-flex flex-wrap align-items-center gap-2 p-2 px-3 border-bottom bg-body-secondary small">
                    @if (GetTotalInputTokens() > 0 || GetTotalOutputTokens() > 0)
                    {
                        <span class="d-flex align-items-center gap-1">
                            <i class="bi bi-arrow-left-right opacity-75"></i>
                            @TokenHelper.FormatTokenCount(GetTotalInputTokens() + GetTotalOutputTokens()) tokens
                        </span>
                    }
                    @if (GetTotalCost() > 0)
                    {
                        <span class="d-flex align-items-center gap-1 text-success fw-medium">
                            <i class="bi bi-currency-dollar opacity-75"></i>
                            @TokenHelper.FormatCost(GetTotalCost())
                        </span>
                    }
                    <span class="ms-auto text-body-secondary">
                        @GetFilteredJobs().Count() jobs
                    </span>
                </div>
            }

            @* Job list *@
            <div class="flex-grow-1 overflow-auto">
                @if (_jobs == null || !_jobs.Any())
                {
                    <EmptyState Icon="list-check" Title="No jobs yet"
                        Message="Jobs are created when you run AI agent tasks on your projects.">
                        <a href="/projects" class="btn btn-sm btn-primary">
                            <i class="bi bi-folder me-1"></i>Go to Projects
                        </a>
                    </EmptyState>
                }
                else if (!GetFilteredJobs().Any())
                {
                    <EmptyState Icon="@GetFilterEmptyIcon()" Title="@GetFilterEmptyTitle()"
                        Message="@GetFilterEmptyMessage()" />
                }
                else
                {
                    @foreach (var job in GetFilteredJobs())
                    {
                        <JobListItem Status="@job.Status.ToString()" Prompt="@GetJobDisplayTitle(job)"
                            ProjectName="@(job.Project?.Name ?? "Unknown")" ShowProjectName="@(_selectedProjectId == null)"
                            ModelUsed="@job.ModelUsed"
                            Activity="@((job.Status == JobStatus.Started || job.Status == JobStatus.Processing) ? (job.CurrentActivity ?? "Working...") : null)"
                            TimeDisplay="@GetTimeDisplay(job)" Cost="@job.TotalCostUsd" InputTokens="@job.InputTokens"
                            OutputTokens="@job.OutputTokens" OnClick="@(() => NavigateToJob(job.Id))" />
                    }
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid? ProjectFilter { get; set; }

    private IEnumerable<Job>? _jobs;
    private IEnumerable<Project> _projects = Enumerable.Empty<Project>();
    private bool _isLoading = true;
    private string _statusFilter = "all";
    private Guid? _selectedProjectId;
    private DotNetObjectReference<Jobs>? _dotNetReference;
    private IJSObjectReference? _signalRModule;
    private Timer? _refreshTimer;
    private bool _isRefreshing = false;

    protected override async Task OnInitializedAsync()
    {
        _selectedProjectId = ProjectFilter;
        await LoadData();
        StartAutoRefresh();
    }

    protected override void OnParametersSet()
    {
        if (ProjectFilter != _selectedProjectId)
        {
            _selectedProjectId = ProjectFilter;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeSignalR();
        }
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new Timer(async _ =>
        {
            if (HasActiveJobs() && !_isRefreshing)
            {
                await InvokeAsync(async () =>
        {
            await RefreshJobsSafely();
        });
            }
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private bool HasActiveJobs()
    {
        return _jobs?.Any(j => j.Status == JobStatus.New ||
        j.Status == JobStatus.Started ||
        j.Status == JobStatus.Processing) ?? false;
    }

    private async Task RefreshJobsSafely()
    {
        if (_isRefreshing) return;

        try
        {
            _isRefreshing = true;
            await LoadData();
            StateHasChanged();
        }
        finally
        {
            _isRefreshing = false;
        }
    }

    private async Task InitializeSignalR()
    {
        try
        {
            _dotNetReference = DotNetObjectReference.Create(this);
            _signalRModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/jobListSignalR.js");
            await _signalRModule.InvokeVoidAsync("initializeJobListHub", _dotNetReference);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing SignalR: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnJobStatusChanged(string jobId, string status)
    {
        Console.WriteLine($"[Jobs] OnJobStatusChanged: {jobId} -> {status}");

        if (_jobs != null && Guid.TryParse(jobId, out var id) && Enum.TryParse<JobStatus>(status, out var newStatus))
        {
            var job = _jobs.FirstOrDefault(j => j.Id == id);
            if (job != null)
            {
                job.Status = newStatus;
                if (newStatus == JobStatus.Started)
                {
                    job.StartedAt = DateTime.UtcNow;
                }
                else if (newStatus == JobStatus.Completed || newStatus == JobStatus.Failed || newStatus == JobStatus.Cancelled)
                {
                    job.CompletedAt = DateTime.UtcNow;
                }
                await InvokeAsync(StateHasChanged);
            }
        }

        if (!_isRefreshing)
        {
            _ = Task.Run(async () =>
            {
                await Task.Delay(500);
                await InvokeAsync(async () => await RefreshJobsSafely());
            });
        }
    }

    [JSInvokable]
    public async Task OnJobActivityUpdated(string jobId, string activity, DateTime timestamp)
    {
        if (_jobs != null && Guid.TryParse(jobId, out var id))
        {
            var job = _jobs.FirstOrDefault(j => j.Id == id);
            if (job != null)
            {
                job.CurrentActivity = activity;
                job.LastActivityAt = timestamp;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    [JSInvokable]
    public async Task OnJobCreated(string jobId, string projectId)
    {
        Console.WriteLine($"[Jobs] OnJobCreated: {jobId}");
        if (!_isRefreshing)
        {
            await InvokeAsync(async () => await RefreshJobsSafely());
        }
    }

    [JSInvokable]
    public async Task OnJobDeleted(string jobId, string projectId)
    {
        Console.WriteLine($"[Jobs] OnJobDeleted: {jobId}");
        if (!_isRefreshing)
        {
            await InvokeAsync(async () => await RefreshJobsSafely());
        }
    }

    [JSInvokable]
    public async Task OnJobCompleted(string jobId, bool success, string? errorMessage)
    {
        Console.WriteLine($"[Jobs] OnJobCompleted: {jobId}, success: {success}");

        if (_jobs != null && Guid.TryParse(jobId, out var id))
        {
            var job = _jobs.FirstOrDefault(j => j.Id == id);
            if (job != null)
            {
                job.Status = success ? JobStatus.Completed : JobStatus.Failed;
                job.CompletedAt = DateTime.UtcNow;
                if (!string.IsNullOrEmpty(errorMessage))
                {
                    job.ErrorMessage = errorMessage;
                }
                await InvokeAsync(StateHasChanged);
            }
        }

        if (!_isRefreshing)
        {
            await InvokeAsync(async () => await RefreshJobsSafely());
        }
    }

    [JSInvokable]
    public async Task OnJobListChanged()
    {
        Console.WriteLine($"[Jobs] OnJobListChanged");
        if (!_isRefreshing)
        {
            await InvokeAsync(async () => await RefreshJobsSafely());
        }
    }

    private async Task LoadData()
    {
        try
        {
            var jobsTask = JobService.GetAllAsync();
            var projectsTask = ProjectService.GetAllAsync();

            await Task.WhenAll(jobsTask, projectsTask);

            _jobs = await jobsTask;
            _projects = await projectsTask;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SetStatusFilter(string filter)
    {
        _statusFilter = filter;
    }

    private void SelectProject(Guid? projectId)
    {
        _selectedProjectId = projectId;
        // Update URL without full navigation to preserve state
        var url = projectId.HasValue ? $"/jobs/{projectId}" : "/jobs";
        NavigationManager.NavigateTo(url, forceLoad: false, replace: true);
    }

    private void OnProjectFilterChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out var projectId))
        {
            SelectProject(projectId);
        }
        else
        {
            SelectProject(null);
        }
    }

    private int GetJobCountForProject(Guid projectId) => _jobs?.Count(j => j.ProjectId == projectId) ?? 0;
    private int GetActiveCountForProject(Guid projectId) => _jobs?.Count(j => j.ProjectId == projectId &&
    (j.Status == JobStatus.New || j.Status == JobStatus.Started || j.Status == JobStatus.Processing)) ?? 0;

    private int GetActiveCount() => _jobs?.Count(j => j.Status == JobStatus.New || j.Status == JobStatus.Started || j.Status
    == JobStatus.Processing) ?? 0;
    private int GetCompletedCount() => _jobs?.Count(j => j.Status == JobStatus.Completed) ?? 0;
    private int GetFailedCount() => _jobs?.Count(j => j.Status == JobStatus.Failed || j.Status == JobStatus.Cancelled) ?? 0;

    // Token and cost summary methods
    private int GetTotalInputTokens() => GetFilteredJobs().Sum(j => j.InputTokens ?? 0);
    private int GetTotalOutputTokens() => GetFilteredJobs().Sum(j => j.OutputTokens ?? 0);
    private decimal GetTotalCost() => GetFilteredJobs().Sum(j => j.TotalCostUsd ?? 0);
    private bool HasTokenData() => GetTotalInputTokens() > 0 || GetTotalOutputTokens() > 0 || GetTotalCost() > 0;

    private IEnumerable<Job> GetFilteredJobs()
    {
        if (_jobs == null) return Enumerable.Empty<Job>();

        // First filter by project if selected
        var filtered = _selectedProjectId.HasValue
        ? _jobs.Where(j => j.ProjectId == _selectedProjectId.Value)
        : _jobs;

        // Then filter by status
        return _statusFilter switch
        {
            "active" => filtered.Where(j => j.Status == JobStatus.New || j.Status == JobStatus.Started || j.Status ==
            JobStatus.Processing),
            "completed" => filtered.Where(j => j.Status == JobStatus.Completed),
            "failed" => filtered.Where(j => j.Status == JobStatus.Failed || j.Status == JobStatus.Cancelled),
            _ => filtered
        };
    }

    private string GetFilterEmptyIcon() => _statusFilter switch
    {
        "active" => "activity",
        "completed" => "check-circle",
        "failed" => "x-circle",
        _ => "inbox"
    };

    private string GetFilterEmptyTitle() => _statusFilter switch
    {
        "active" => "No active jobs",
        "completed" => "No completed jobs",
        "failed" => "No failed jobs",
        _ => "No jobs"
    };

    private string GetFilterEmptyMessage() => _statusFilter switch
    {
        "active" => "There are no jobs currently running. Start a new job from a project.",
        "completed" => "No jobs have been completed yet.",
        "failed" => "No jobs have failed. That's good news!",
        _ => "No jobs to display."
    };

    private void NavigateToJob(Guid jobId)
    {
        // Include project filter as query param so we can return to the same view
        var returnUrl = _selectedProjectId.HasValue ? $"/jobs/{_selectedProjectId}" : "/jobs";
        NavigationManager.NavigateTo($"/jobs/view/{jobId}?returnUrl={Uri.EscapeDataString(returnUrl)}");
    }

    private static string TruncatePrompt(string prompt, int maxLength)
    {
        if (string.IsNullOrEmpty(prompt) || prompt.Length <= maxLength)
            return prompt;
        return prompt[..maxLength] + "...";
    }

    private static string GetTimeDisplay(Job job)
    {
        if (job.CompletedAt.HasValue)
        {
            var duration = job.CompletedAt.Value - (job.StartedAt ?? job.CreatedAt);
            return $"Completed in {FormatDuration(duration)}";
        }
        if (job.StartedAt.HasValue)
        {
            var duration = DateTime.UtcNow - job.StartedAt.Value;
            return $"Running for {FormatDuration(duration)}";
        }
        return $"Created {FormatTimeAgo(job.CreatedAt)}";
    }

    private static string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalMinutes < 1) return $"{duration.Seconds}s";
        if (duration.TotalHours < 1) return $"{duration.Minutes}m {duration.Seconds}s";
        return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }

    private static string FormatTimeAgo(DateTime time)
    {
        var elapsed = DateTime.UtcNow - time;
        if (elapsed.TotalMinutes < 1) return "just now";
        if (elapsed.TotalMinutes < 60) return $"{(int)elapsed.TotalMinutes}m ago";
        if (elapsed.TotalHours < 24) return $"{(int)elapsed.TotalHours}h ago";
        return $"{(int)elapsed.TotalDays}d ago";
    }

    private static string GetJobDisplayTitle(Job job)
    {
        // Use Title if available, otherwise use GoalPrompt
        return !string.IsNullOrEmpty(job.Title) ? job.Title : job.GoalPrompt;
    }

    public async ValueTask DisposeAsync()
    {
        _refreshTimer?.Dispose();

        if (_signalRModule != null)
        {
            try
            {
                await _signalRModule.InvokeVoidAsync("disposeJobListHub");
                await _signalRModule.DisposeAsync();
            }
            catch { }
        }

        _dotNetReference?.Dispose();
    }
}