@page "/jobs"
@attribute [Authorize]
@inject IJobService JobService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@using System.Threading

<PageHeader Title="Jobs" Subtitle="@($"{(_jobs?.Count() ?? 0)} total")" />

@if (_isLoading)
{
    <LoadingSpinner />
}
else if (_jobs == null || !_jobs.Any())
{
    <EmptyState Icon="list-check" Title="No jobs yet"
        Message="Jobs are created when you run AI agent tasks on your projects.">
        <a href="/projects" class="btn btn-sm btn-primary">
            <i class="bi bi-folder me-1"></i>Go to Projects
        </a>
    </EmptyState>
}
else
{
    <div class="filter-buttons mb-3">
        <button type="button" class="btn btn-sm @(_filter == "all" ? "btn-primary" : "btn-outline-secondary")"
            @onclick='() => SetFilter("all")'>
            All
            <span class="badge bg-secondary ms-1">@_jobs.Count()</span>
        </button>
        <button type="button" class="btn btn-sm @(_filter == "active" ? "btn-primary" : "btn-outline-secondary")"
            @onclick='() => SetFilter("active")'>
            Active
            <span class="badge bg-secondary ms-1">@GetActiveCount()</span>
        </button>
        <button type="button" class="btn btn-sm @(_filter == "completed" ? "btn-primary" : "btn-outline-secondary")"
            @onclick='() => SetFilter("completed")'>
            Completed
            <span class="badge bg-secondary ms-1">@GetCompletedCount()</span>
        </button>
        <button type="button" class="btn btn-sm @(_filter == "failed" ? "btn-primary" : "btn-outline-secondary")"
            @onclick='() => SetFilter("failed")'>
            Failed
            <span class="badge bg-secondary ms-1">@GetFailedCount()</span>
        </button>
    </div>

    @* Token and Cost Summary *@
    @if (HasTokenData())
    {
        <div class="d-flex flex-wrap gap-2 mb-3">
            @if (GetTotalInputTokens() > 0)
            {
                <StatItem Label="Total Input" Value="@TokenHelper.FormatTokenCount(GetTotalInputTokens())" />
            }
            @if (GetTotalOutputTokens() > 0)
            {
                <StatItem Label="Total Output" Value="@TokenHelper.FormatTokenCount(GetTotalOutputTokens())" />
            }
            @if (GetTotalInputTokens() > 0 || GetTotalOutputTokens() > 0)
            {
                <StatItem Label="Total Tokens"
                    Value="@TokenHelper.FormatTokenCount(GetTotalInputTokens() + GetTotalOutputTokens())" />
            }
            @if (GetTotalCost() > 0)
            {
                <StatItem Label="Total Cost" Value="@TokenHelper.FormatCost(GetTotalCost())" />
            }
        </div>
    }

    @if (!GetFilteredJobs().Any())
    {
        <EmptyState Icon="@GetFilterEmptyIcon()" Title="@GetFilterEmptyTitle()" Message="@GetFilterEmptyMessage()" />
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
            @foreach (var job in GetFilteredJobs())
            {
                <div class="col">
                    <JobCard Status="@job.Status.ToString()"
                        IsCancelling="@(job.CancellationRequested && (job.Status == JobStatus.Started || job.Status == JobStatus.Processing))"
                        ProjectName="@(job.Project?.Name ?? "Unknown")" ProviderName="@(job.Provider?.Name ?? "Unknown")"
                        Prompt="@job.GoalPrompt"
                        Activity="@((job.Status == JobStatus.Started || job.Status == JobStatus.Processing) ? (job.CurrentActivity ?? "Working...") : null)"
                        TimeDisplay="@((job.Status != JobStatus.Started && job.Status != JobStatus.Processing) ? GetTimeDisplay(job) : null)"
                        Cost="@job.TotalCostUsd" InputTokens="@job.InputTokens" OutputTokens="@job.OutputTokens"
                        ModelUsed="@job.ModelUsed" OnClick="@(() => NavigateToJob(job.Id))" />
                </div>
            }
        </div>
    }
}

@code {
    private IEnumerable<Job>? _jobs;
    private bool _isLoading = true;
    private string _filter = "all";
    private DotNetObjectReference<Jobs>? _dotNetReference;
    private IJSObjectReference? _signalRModule;
    private Timer? _refreshTimer;
    private bool _isRefreshing = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobs();
        StartAutoRefresh();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeSignalR();
        }
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new Timer(async _ =>
        {
            if (HasActiveJobs() && !_isRefreshing)
            {
                await InvokeAsync(async () =>
        {
            await RefreshJobsSafely();
        });
            }
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private bool HasActiveJobs()
    {
        return _jobs?.Any(j => j.Status == JobStatus.New ||
        j.Status == JobStatus.Started ||
        j.Status == JobStatus.Processing) ?? false;
    }

    private async Task RefreshJobsSafely()
    {
        if (_isRefreshing) return;

        try
        {
            _isRefreshing = true;
            await LoadJobs();
            StateHasChanged();
        }
        finally
        {
            _isRefreshing = false;
        }
    }

    private async Task InitializeSignalR()
    {
        try
        {
            _dotNetReference = DotNetObjectReference.Create(this);
            _signalRModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/jobListSignalR.js");
            await _signalRModule.InvokeVoidAsync("initializeJobListHub", _dotNetReference);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing SignalR: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnJobStatusChanged(string jobId, string status)
    {
        Console.WriteLine($"[Jobs] OnJobStatusChanged: {jobId} -> {status}");

        if (_jobs != null && Guid.TryParse(jobId, out var id) && Enum.TryParse<JobStatus>(status, out var newStatus))
        {
            var job = _jobs.FirstOrDefault(j => j.Id == id);
            if (job != null)
            {
                job.Status = newStatus;
                if (newStatus == JobStatus.Started)
                {
                    job.StartedAt = DateTime.UtcNow;
                }
                else if (newStatus == JobStatus.Completed || newStatus == JobStatus.Failed || newStatus == JobStatus.Cancelled)
                {
                    job.CompletedAt = DateTime.UtcNow;
                }
                await InvokeAsync(StateHasChanged);
            }
        }

        if (!_isRefreshing)
        {
            _ = Task.Run(async () =>
            {
                await Task.Delay(500);
                await InvokeAsync(async () => await RefreshJobsSafely());
            });
        }
    }

    [JSInvokable]
    public async Task OnJobActivityUpdated(string jobId, string activity, DateTime timestamp)
    {
        if (_jobs != null && Guid.TryParse(jobId, out var id))
        {
            var job = _jobs.FirstOrDefault(j => j.Id == id);
            if (job != null)
            {
                job.CurrentActivity = activity;
                job.LastActivityAt = timestamp;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    [JSInvokable]
    public async Task OnJobCreated(string jobId, string projectId)
    {
        Console.WriteLine($"[Jobs] OnJobCreated: {jobId}");
        if (!_isRefreshing)
        {
            await InvokeAsync(async () => await RefreshJobsSafely());
        }
    }

    [JSInvokable]
    public async Task OnJobDeleted(string jobId, string projectId)
    {
        Console.WriteLine($"[Jobs] OnJobDeleted: {jobId}");
        if (!_isRefreshing)
        {
            await InvokeAsync(async () => await RefreshJobsSafely());
        }
    }

    [JSInvokable]
    public async Task OnJobCompleted(string jobId, bool success, string? errorMessage)
    {
        Console.WriteLine($"[Jobs] OnJobCompleted: {jobId}, success: {success}");

        if (_jobs != null && Guid.TryParse(jobId, out var id))
        {
            var job = _jobs.FirstOrDefault(j => j.Id == id);
            if (job != null)
            {
                job.Status = success ? JobStatus.Completed : JobStatus.Failed;
                job.CompletedAt = DateTime.UtcNow;
                if (!string.IsNullOrEmpty(errorMessage))
                {
                    job.ErrorMessage = errorMessage;
                }
                await InvokeAsync(StateHasChanged);
            }
        }

        if (!_isRefreshing)
        {
            await InvokeAsync(async () => await RefreshJobsSafely());
        }
    }

    [JSInvokable]
    public async Task OnJobListChanged()
    {
        Console.WriteLine($"[Jobs] OnJobListChanged");
        if (!_isRefreshing)
        {
            await InvokeAsync(async () => await RefreshJobsSafely());
        }
    }

    private async Task LoadJobs()
    {
        try
        {
            _jobs = await JobService.GetAllAsync();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SetFilter(string filter)
    {
        _filter = filter;
    }

    private int GetActiveCount() => _jobs?.Count(j => j.Status == JobStatus.New || j.Status == JobStatus.Started || j.Status
    == JobStatus.Processing) ?? 0;
    private int GetCompletedCount() => _jobs?.Count(j => j.Status == JobStatus.Completed) ?? 0;
    private int GetFailedCount() => _jobs?.Count(j => j.Status == JobStatus.Failed || j.Status == JobStatus.Cancelled) ?? 0;

    // Token and cost summary methods
    private int GetTotalInputTokens() => GetFilteredJobs().Sum(j => j.InputTokens ?? 0);
    private int GetTotalOutputTokens() => GetFilteredJobs().Sum(j => j.OutputTokens ?? 0);
    private decimal GetTotalCost() => GetFilteredJobs().Sum(j => j.TotalCostUsd ?? 0);
    private bool HasTokenData() => GetTotalInputTokens() > 0 || GetTotalOutputTokens() > 0 || GetTotalCost() > 0;

    private IEnumerable<Job> GetFilteredJobs()
    {
        if (_jobs == null) return Enumerable.Empty<Job>();

        return _filter switch
        {
            "active" => _jobs.Where(j => j.Status == JobStatus.New || j.Status == JobStatus.Started || j.Status ==
            JobStatus.Processing),
            "completed" => _jobs.Where(j => j.Status == JobStatus.Completed),
            "failed" => _jobs.Where(j => j.Status == JobStatus.Failed || j.Status == JobStatus.Cancelled),
            _ => _jobs
        };
    }

    private string GetFilterEmptyIcon() => _filter switch
    {
        "active" => "activity",
        "completed" => "check-circle",
        "failed" => "x-circle",
        _ => "inbox"
    };

    private string GetFilterEmptyTitle() => _filter switch
    {
        "active" => "No active jobs",
        "completed" => "No completed jobs",
        "failed" => "No failed jobs",
        _ => "No jobs"
    };

    private string GetFilterEmptyMessage() => _filter switch
    {
        "active" => "There are no jobs currently running. Start a new job from a project.",
        "completed" => "No jobs have been completed yet.",
        "failed" => "No jobs have failed. That's good news!",
        _ => "No jobs to display."
    };

    private void NavigateToJob(Guid jobId)
    {
        NavigationManager.NavigateTo($"/jobs/{jobId}");
    }

    private static string TruncatePrompt(string prompt, int maxLength)
    {
        if (string.IsNullOrEmpty(prompt) || prompt.Length <= maxLength)
            return prompt;
        return prompt[..maxLength] + "...";
    }

    private static string GetTimeDisplay(Job job)
    {
        if (job.CompletedAt.HasValue)
        {
            var duration = job.CompletedAt.Value - (job.StartedAt ?? job.CreatedAt);
            return $"Completed in {FormatDuration(duration)}";
        }
        if (job.StartedAt.HasValue)
        {
            var duration = DateTime.UtcNow - job.StartedAt.Value;
            return $"Running for {FormatDuration(duration)}";
        }
        return $"Created {FormatTimeAgo(job.CreatedAt)}";
    }

    private static string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalMinutes < 1) return $"{duration.Seconds}s";
        if (duration.TotalHours < 1) return $"{duration.Minutes}m {duration.Seconds}s";
        return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }

    private static string FormatTimeAgo(DateTime time)
    {
        var elapsed = DateTime.UtcNow - time;
        if (elapsed.TotalMinutes < 1) return "just now";
        if (elapsed.TotalMinutes < 60) return $"{(int)elapsed.TotalMinutes}m ago";
        if (elapsed.TotalHours < 24) return $"{(int)elapsed.TotalHours}h ago";
        return $"{(int)elapsed.TotalDays}d ago";
    }

    public async ValueTask DisposeAsync()
    {
        _refreshTimer?.Dispose();

        if (_signalRModule != null)
        {
            try
            {
                await _signalRModule.InvokeVoidAsync("disposeJobListHub");
                await _signalRModule.DisposeAsync();
            }
            catch { }
        }

        _dotNetReference?.Dispose();
    }
}