@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
	@foreach (var notification in NotificationService.Notifications)
	{
		<div class="toast show fade @GetToastClass(notification.Type)" role="alert" aria-live="assertive"
			aria-atomic="true">
			<div class="toast-header">
				<i class="@GetIconClass(notification.Type) me-2"></i>
				<strong class="me-auto">@notification.Title</strong>
				<small class="text-body-secondary">@GetTimeAgo(notification.CreatedAt)</small>
				<button type="button" class="btn-close" aria-label="Close"
					@onclick="() => Dismiss(notification.Id)"></button>
			</div>
			<div class="toast-body">
				@notification.Message
			</div>
		</div>
	}
</div>

@code {
	private Timer? _autoRemoveTimer;
	private Timer? _refreshTimer;

	protected override void OnInitialized()
	{
		NotificationService.OnChange += StateHasChanged;

		// Timer to auto-remove expired notifications
		_autoRemoveTimer = new Timer(_ =>
		{
			InvokeAsync(() =>
	{
			var now = DateTime.UtcNow;
			var expiredNotifications = NotificationService.Notifications
	.Where(n => (now - n.CreatedAt).TotalMilliseconds > n.DurationMs)
	.ToList();

			foreach (var notification in expiredNotifications)
			{
				NotificationService.Remove(notification.Id);
			}
		});
		}, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));

		// Timer to refresh "time ago" display
		_refreshTimer = new Timer(_ =>
		{
			InvokeAsync(StateHasChanged);
		}, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
	}

	private void Dismiss(Guid id)
	{
		NotificationService.Remove(id);
	}

	private string GetToastClass(NotificationType type)
	{
		return type switch
		{
			NotificationType.Success => "border-success",
			NotificationType.Error => "border-danger",
			NotificationType.Warning => "border-warning",
			NotificationType.Info => "border-info",
			_ => ""
		};
	}

	private string GetIconClass(NotificationType type)
	{
		// Using Unicode characters as Bootstrap doesn't include icons by default
		// You could replace these with Bootstrap Icons if you add that library
		return type switch
		{
			NotificationType.Success => "bi bi-check-circle-fill text-success",
			NotificationType.Error => "bi bi-x-circle-fill text-danger",
			NotificationType.Warning => "bi bi-exclamation-triangle-fill text-warning",
			NotificationType.Info => "bi bi-info-circle-fill text-info",
			_ => "bi bi-bell-fill"
		};
	}

	private string GetTimeAgo(DateTime createdAt)
	{
		var elapsed = DateTime.UtcNow - createdAt;
		if (elapsed.TotalSeconds < 5)
			return "just now";
		if (elapsed.TotalSeconds < 60)
			return $"{(int)elapsed.TotalSeconds}s ago";
		if (elapsed.TotalMinutes < 60)
			return $"{(int)elapsed.TotalMinutes}m ago";
		return $"{(int)elapsed.TotalHours}h ago";
	}

	public void Dispose()
	{
		NotificationService.OnChange -= StateHasChanged;
		_autoRemoveTimer?.Dispose();
		_refreshTimer?.Dispose();
	}
}