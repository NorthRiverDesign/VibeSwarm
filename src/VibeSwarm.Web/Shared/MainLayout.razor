@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@inject NotificationService NotificationService
@inject IJobService JobService
@implements IAsyncDisposable

<div class="app-layout">
    @* Mobile Header *@
    <header class="app-header d-lg-none">
        <button class="btn btn-link nav-toggle" @onclick="ToggleMobileMenu" aria-label="Toggle navigation">
            <i class="bi bi-list"></i>
        </button>
        <a class="app-brand" href="/">
            <span class="brand-icon">üêù</span>
            <span class="brand-text">VibeSwarm</span>
        </a>
        <div class="header-actions">
            <LoginDisplay />
        </div>
    </header>

    @* Sidebar Navigation *@
    <nav class="app-sidebar @(_mobileMenuOpen ? "open" : "")">
        <div class="sidebar-header d-none d-lg-flex">
            <a class="app-brand" href="/">
                <span class="brand-icon">üêù</span>
                <span class="brand-text">VibeSwarm</span>
            </a>
        </div>

        <div class="sidebar-nav">
            <NavLink class="nav-item" href="/" Match="NavLinkMatch.All" @onclick="CloseMobileMenu">
                <i class="bi bi-house-door"></i>
                <span>Dashboard</span>
            </NavLink>
            <NavLink class="nav-item" href="/projects" @onclick="CloseMobileMenu">
                <i class="bi bi-folder"></i>
                <span>Projects</span>
            </NavLink>
            <NavLink class="nav-item" href="/jobs" @onclick="CloseMobileMenu">
                <i class="bi bi-gear-wide-connected"></i>
                <span>Jobs</span>
            </NavLink>
            <NavLink class="nav-item" href="/providers" @onclick="CloseMobileMenu">
                <i class="bi bi-plug"></i>
                <span>Providers</span>
            </NavLink>
            <NavLink class="nav-item" href="/settings" @onclick="CloseMobileMenu">
                <i class="bi bi-sliders"></i>
                <span>Settings</span>
            </NavLink>
        </div>

        <div class="sidebar-footer d-none d-lg-block">
            <LoginDisplay />
        </div>
    </nav>

    @* Mobile Menu Overlay *@
    @if (_mobileMenuOpen)
    {
        <div class="sidebar-overlay d-lg-none" @onclick="CloseMobileMenu"></div>
    }

    @* Main Content *@
    <main class="app-main">
        <div class="main-content">
            @Body
        </div>
    </main>
</div>

<ToastContainer />

@code {
    private DotNetObjectReference<MainLayout>? _dotNetReference;
    private bool _hubInitialized = false;
    private bool _mobileMenuOpen = false;

    private void ToggleMobileMenu()
    {
        _mobileMenuOpen = !_mobileMenuOpen;
    }

    private void CloseMobileMenu()
    {
        _mobileMenuOpen = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeGlobalHub();
        }
    }

    private async Task InitializeGlobalHub()
    {
        if (_hubInitialized) return;

        try
        {
            _dotNetReference = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("VibeSwarmHub.initialize", _dotNetReference);
            _hubInitialized = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MainLayout] Error initializing global hub: {ex.Message}");
        }
    }

    [JSInvokable]
    public void OnConnectionStateChanged(string state)
    {
        Console.WriteLine($"[MainLayout] Connection state: {state}");
    }

    [JSInvokable]
    public async Task OnGlobalJobStatusChanged(string jobId, string status)
    {
        Console.WriteLine($"[MainLayout] Job {jobId} status changed to {status}");
        // Additional global handling can be added here
        await Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnGlobalJobActivityUpdated(string jobId, string activity, DateTime timestamp)
    {
        // Activity updates are handled silently
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnGlobalJobCreated(string jobId, string projectId)
    {
        Console.WriteLine($"[MainLayout] New job created: {jobId}");
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnGlobalJobDeleted(string jobId, string projectId)
    {
        Console.WriteLine($"[MainLayout] Job deleted: {jobId}");
        return Task.CompletedTask;
    }

    [JSInvokable]
    public async Task OnGlobalJobCompleted(string jobId, bool success, string? errorMessage)
    {
        Console.WriteLine($"[MainLayout] Job {jobId} completed, success: {success}");

        // Get job details to show in notification
        if (Guid.TryParse(jobId, out var id))
        {
            try
            {
                var job = await JobService.GetByIdAsync(id);
                var projectName = job?.Project?.Name;

                await InvokeAsync(() =>
                {
                    NotificationService.ShowJobCompleted(id, success, projectName, errorMessage);
                    StateHasChanged();
                });
            }
            catch
            {
                // If we can't get the job details, show a generic notification
                await InvokeAsync(() =>
                {
                    NotificationService.ShowJobCompleted(id, success, null, errorMessage);
                    StateHasChanged();
                });
            }
        }
    }

    [JSInvokable]
    public Task OnGlobalJobListChanged()
    {
        // Job list changes don't need global notifications
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnGlobalJobMessageAdded(string jobId)
    {
        // Message additions don't need global notifications
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnGlobalProcessStarted(string jobId, int processId, string command)
    {
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnGlobalProcessExited(string jobId, int processId, int exitCode, double durationSeconds)
    {
        return Task.CompletedTask;
    }

    [JSInvokable]
    public async Task OnShowNotification(string title, string message, string type)
    {
        await InvokeAsync(() =>
        {
            var notificationType = type?.ToLower() switch
            {
                "success" => NotificationType.Success,
                "error" => NotificationType.Error,
                "warning" => NotificationType.Warning,
                _ => NotificationType.Info
            };

            NotificationService.Show(message, title, notificationType);
            StateHasChanged();
        });
    }

    public async ValueTask DisposeAsync()
    {
        _dotNetReference?.Dispose();

        try
        {
            // Don't dispose the global hub - it persists across navigation
            // Just clear the .NET reference
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}