@using Microsoft.AspNetCore.Components.Authorization
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager

<AuthorizeView>
    <Authorized>
        <div class="login-display w-100">
            @* Desktop: User info with gear dropdown on the right *@
            <div class="user-menu d-none d-lg-flex justify-content-between align-items-center w-100">
                <div class="user-info">
                    <i class="bi bi-person-circle"></i>
                    <span class="user-name">@context.User.Identity?.Name</span>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link user-menu-toggle p-0 ms-2" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false" title="User options">
                        <i class="bi bi-gear"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <button class="dropdown-item" type="button" @onclick="ShowChangePasswordModal">
                                <i class="bi bi-key me-2"></i>Change Password
                            </button>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item" href="/logout">
                                <i class="bi bi-box-arrow-right me-2"></i>Log Out
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            @* Mobile: Compact dropdown with user icon *@
            <div class="dropdown d-lg-none">
                <button class="btn btn-link user-menu-toggle-mobile p-0" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false" title="User menu">
                    <i class="bi bi-person-circle me-1"></i>
                    <i class="bi bi-chevron-down small"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li class="dropdown-header">
                        <span class="fw-semibold">@context.User.Identity?.Name</span>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <button class="dropdown-item" type="button" @onclick="ShowChangePasswordModal">
                            <i class="bi bi-key me-2"></i>Change Password
                        </button>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <a class="dropdown-item" href="/logout">
                            <i class="bi bi-box-arrow-right me-2"></i>Log Out
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <a href="/login" class="btn btn-sm btn-primary">Login</a>
    </NotAuthorized>
</AuthorizeView>

@* Change Password Modal *@
<ModalDialog @bind-IsVisible="_showChangePasswordModal" Title="Change Password" Icon="key"
    Size="ModalDialog.ModalSize.Default">
    <ChildContent>
        <EditForm Model="@_changePasswordModel" OnValidSubmit="HandleChangePassword">
            <DataAnnotationsValidator />

            @if (!string.IsNullOrEmpty(_changePasswordError))
            {
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle me-1"></i>@_changePasswordError
                </div>
            }

            @if (!string.IsNullOrEmpty(_changePasswordSuccess))
            {
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-1"></i>@_changePasswordSuccess
                </div>
            }

            <div class="mb-3">
                <label for="currentPassword" class="form-label">Current Password</label>
                <InputText id="currentPassword" type="password" @bind-Value="_changePasswordModel.CurrentPassword"
                    class="form-control" />
                <ValidationMessage For="@(() => _changePasswordModel.CurrentPassword)" class="text-danger small" />
            </div>

            <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <InputText id="newPassword" type="password" @bind-Value="_changePasswordModel.NewPassword"
                    class="form-control" />
                <ValidationMessage For="@(() => _changePasswordModel.NewPassword)" class="text-danger small" />
                <div class="form-text">
                    Password must be at least 8 characters and contain uppercase, lowercase, and a digit.
                </div>
            </div>

            <div class="mb-3">
                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                <InputText id="confirmPassword" type="password" @bind-Value="_changePasswordModel.ConfirmPassword"
                    class="form-control" />
                <ValidationMessage For="@(() => _changePasswordModel.ConfirmPassword)" class="text-danger small" />
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" @onclick="CloseChangePasswordModal">Cancel</button>
                <button type="submit" class="btn btn-primary" disabled="@_isChangingPassword">
                    @if (_isChangingPassword)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Change Password
                </button>
            </div>
        </EditForm>
    </ChildContent>
</ModalDialog>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private bool _showChangePasswordModal;
    private bool _isChangingPassword;
    private string? _changePasswordError;
    private string? _changePasswordSuccess;
    private ChangePasswordModel _changePasswordModel = new();

    private void ShowChangePasswordModal()
    {
        _changePasswordModel = new ChangePasswordModel();
        _changePasswordError = null;
        _changePasswordSuccess = null;
        _showChangePasswordModal = true;
    }

    private void CloseChangePasswordModal()
    {
        _showChangePasswordModal = false;
    }

    private async Task HandleChangePassword()
    {
        _changePasswordError = null;
        _changePasswordSuccess = null;

        if (_changePasswordModel.NewPassword != _changePasswordModel.ConfirmPassword)
        {
            _changePasswordError = "New password and confirmation do not match.";
            return;
        }

        _isChangingPassword = true;

        try
        {
            if (AuthenticationStateTask == null)
            {
                _changePasswordError = "Unable to get current user.";
                return;
            }

            var authState = await AuthenticationStateTask;
            var user = await UserManager.GetUserAsync(authState.User);

            if (user == null)
            {
                _changePasswordError = "Unable to find current user.";
                return;
            }

            var result = await UserManager.ChangePasswordAsync(user, _changePasswordModel.CurrentPassword,
            _changePasswordModel.NewPassword);

            if (result.Succeeded)
            {
                _changePasswordSuccess = "Password changed successfully.";
                _changePasswordModel = new ChangePasswordModel();
            }
            else
            {
                _changePasswordError = string.Join(" ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            _changePasswordError = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isChangingPassword = false;
        }
    }

    public class ChangePasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Current password is required.")]
        public string CurrentPassword { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "New password is required.")]
        [System.ComponentModel.DataAnnotations.MinLength(8, ErrorMessage = "Password must be at least 8 characters.")]
        public string NewPassword { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Please confirm your new password.")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}