@* Modal component for creating new jobs *@
@using VibeSwarm.Shared.VersionControl.Models

<ModalDialog IsVisible="IsVisible" IsVisibleChanged="IsVisibleChanged" Title="Create Job" Icon="plus-circle"
	Size="ModalDialog.ModalSize.Large" OnClose="Close">
	<ChildContent>
		<EditForm Model="@JobModel" OnValidSubmit="HandleSubmit">
			<DataAnnotationsValidator />
			<ValidationSummary class="text-danger mb-3" />

			<div class="mb-3">
				<label for="goalPrompt" class="form-label">Goal Prompt</label>
				<InputTextArea id="goalPrompt" @bind-Value="JobModel.GoalPrompt" class="form-control" rows="4"
					placeholder="Describe what you want the AI agent to accomplish..." />
				<ValidationMessage For="@(() => JobModel.GoalPrompt)" class="text-danger small" />
			</div>

			<div class="mb-3">
				<label for="provider" class="form-label">Provider</label>
				<InputSelect id="provider" Value="JobModel.ProviderId" ValueExpression="@(() => JobModel.ProviderId)"
					ValueChanged="@((Guid value) => HandleProviderChanged(value))" class="form-select">
					<option value="@Guid.Empty">Select a provider...</option>
					@foreach (var provider in Providers.Where(p => p.IsEnabled))
					{
						<option value="@provider.Id">@provider.Name (@provider.Type)</option>
					}
				</InputSelect>
				@if (!Providers.Any(p => p.IsEnabled))
				{
					<div class="form-text text-warning">
						No enabled providers. <a href="/providers">Configure one</a> first.
					</div>
				}
			</div>

			<div class="mb-3">
				<label for="model" class="form-label">Model</label>
				<InputSelect id="model" @bind-Value="SelectedModelId" class="form-select"
					disabled="@(JobModel.ProviderId == Guid.Empty || IsLoadingModels)">
					@if (IsLoadingModels)
					{
						<option value="">Loading models...</option>
					}
					else if (!AvailableModels.Any())
					{
						<option value="">@(JobModel.ProviderId == Guid.Empty ? "Select a provider first..." :
													"No models available")</option>
					}
					else
					{
						<option value="">Use provider default</option>
						@foreach (var model in AvailableModels.Where(m => m.IsAvailable))
						{
							<option value="@model.ModelId">@(model.DisplayName ?? model.ModelId)@(model.IsDefault ?
														" (default)" : "")</option>
						}
					}
				</InputSelect>
				<div class="form-text">Leave empty to use the provider's default model.</div>
			</div>

			@if (ShowBranchSelector && Branches.Any())
			{
				<div class="mb-3">
					<label for="branch" class="form-label">Branch</label>
					<InputSelect id="branch" @bind-Value="JobModel.Branch" class="form-select">
						@foreach (var branch in Branches.Where(b => !b.IsRemote).OrderByDescending(b => b.Name ==
											CurrentBranch))
						{
							<option value="@branch.Name">
								@branch.Name @(branch.Name == CurrentBranch ? "(current)" : "")
							</option>
						}
					</InputSelect>
					<div class="form-text">The branch where the AI agent will operate.</div>
				</div>
			}

			@* Multi-Cycle Options (Collapsible) *@
			<div class="mb-3">
				<button type="button" class="btn btn-link p-0 text-decoration-none" @onclick="ToggleAdvancedOptions">
					<i class="bi @(ShowAdvancedOptions ? "bi-chevron-down" : "bi-chevron-right") me-1"></i>
					Advanced Options
				</button>
			</div>

			@if (ShowAdvancedOptions)
			{
				<div class="border rounded p-3 mb-3 bg-body-tertiary">
					<div class="mb-3">
						<label for="cycleMode" class="form-label">Cycle Mode</label>
						<InputSelect id="cycleMode" @bind-Value="JobModel.CycleMode" class="form-select">
							<option value="@CycleMode.SingleCycle">Single Cycle (default)</option>
							<option value="@CycleMode.FixedCount">Fixed Count</option>
							<option value="@CycleMode.Autonomous">Autonomous</option>
						</InputSelect>
						<div class="form-text">
							@switch (JobModel.CycleMode)
							{
								case CycleMode.SingleCycle:
									<span>Agent runs once and completes.</span>
									break;
								case CycleMode.FixedCount:
									<span>Agent runs for a fixed number of cycles.</span>
									break;
								case CycleMode.Autonomous:
									<span>Agent decides when the task is complete (max cycles as safety limit).</span>
									break;
							}
						</div>
					</div>

					@if (JobModel.CycleMode != CycleMode.SingleCycle)
					{
						<div class="mb-3">
							<label for="maxCycles" class="form-label">Max Cycles</label>
							<InputNumber id="maxCycles" @bind-Value="JobModel.MaxCycles" class="form-control" min="1"
								max="100" />
							<div class="form-text">Maximum number of execution cycles (1-100).</div>
						</div>

						<div class="mb-3">
							<label for="cycleSessionMode" class="form-label">Session Mode</label>
							<InputSelect id="cycleSessionMode" @bind-Value="JobModel.CycleSessionMode" class="form-select">
								<option value="@CycleSessionMode.ContinueSession">Continue Session</option>
								<option value="@CycleSessionMode.FreshSession">Fresh Session</option>
							</InputSelect>
							<div class="form-text">
								@if (JobModel.CycleSessionMode == CycleSessionMode.ContinueSession)
								{
									<span>Maintain context between cycles (recommended for iterative work).</span>
								}
								else
								{
									<span>Start fresh context each cycle (useful for independent tasks).</span>
								}
							</div>
						</div>

						<div class="mb-3">
							<label for="cycleReviewPrompt" class="form-label">Cycle Review Prompt (Optional)</label>
							<InputTextArea id="cycleReviewPrompt" @bind-Value="JobModel.CycleReviewPrompt" class="form-control"
								rows="2" placeholder="Instructions for reviewing progress between cycles..." />
							<div class="form-text">Additional context provided at the start of each subsequent cycle.
							</div>
						</div>
					}
				</div>
			}

			@if (!string.IsNullOrEmpty(ErrorMessage))
			{
				<Alert Type="Alert.AlertType.Danger" Message="@ErrorMessage" Class="mb-0" />
			}
		</EditForm>
	</ChildContent>
	<FooterContent>
		<button type="button" class="btn btn-secondary" @onclick="Close" disabled="@IsSaving">Cancel</button>
		<button type="button" class="btn btn-primary" @onclick="HandleSubmit"
			disabled="@(IsSaving || JobModel.ProviderId == Guid.Empty)">
			@if (IsSaving)
			{
				<span class="spinner-border spinner-border-sm me-1" role="status"></span>
				<span>Creating...</span>
			}
			else
			{
				<i class="bi bi-plus-lg me-1"></i>
				<span>Create Job</span>
			}
		</button>
	</FooterContent>
</ModalDialog>

@code {
	[Parameter]
	public bool IsVisible { get; set; }

	[Parameter]
	public EventCallback<bool> IsVisibleChanged { get; set; }

	[Parameter, EditorRequired]
	public Job JobModel { get; set; } = new();

	[Parameter]
	public List<Provider> Providers { get; set; } = new();

	[Parameter]
	public List<ProviderModel> AvailableModels { get; set; } = new();

	[Parameter]
	public List<GitBranchInfo> Branches { get; set; } = new();

	[Parameter]
	public string? CurrentBranch { get; set; }

	[Parameter]
	public bool ShowBranchSelector { get; set; }

	[Parameter]
	public bool IsLoadingModels { get; set; }

	[Parameter]
	public bool IsSaving { get; set; }

	[Parameter]
	public string? ErrorMessage { get; set; }

	[Parameter]
	public string SelectedModelId { get; set; } = string.Empty;

	[Parameter]
	public EventCallback<Guid> OnProviderChanged { get; set; }

	[Parameter]
	public EventCallback OnSubmit { get; set; }

	private bool ShowAdvancedOptions { get; set; } = false;

	private void ToggleAdvancedOptions()
	{
		ShowAdvancedOptions = !ShowAdvancedOptions;
	}

	private async Task HandleProviderChanged(Guid providerId)
	{
		JobModel.ProviderId = providerId;
		await OnProviderChanged.InvokeAsync(providerId);
	}

	private async Task HandleSubmit()
	{
		JobModel.ModelUsed = string.IsNullOrEmpty(SelectedModelId) ? null : SelectedModelId;
		await OnSubmit.InvokeAsync();
	}

	private async Task Close()
	{
		await IsVisibleChanged.InvokeAsync(false);
	}
}