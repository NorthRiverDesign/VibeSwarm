@* Job detail page header section with status, stats, command display, and action buttons *@
@using VibeSwarm.Shared.Utilities

<div
	class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3 mb-3 mb-lg-4 pb-3 border-bottom">
	<div class="flex-grow-1 min-width-0 w-100 w-lg-auto">
		@* Title row with action buttons *@
		<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
			<h3 class="mb-0 fs-4 fw-semibold text-truncate" title="@JobTitle">@(string.IsNullOrEmpty(JobTitle) ? "Job Details" : JobTitle)</h3>
			@* Action Buttons - integrated in header *@
			<div class="d-flex flex-wrap gap-2 flex-shrink-0">
				@if (CanRetry)
				{
					@* Retry dropdown menu *@
					<div class="dropdown">
						<button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
								aria-expanded="false" disabled="@IsRetrying">
							@if (IsRetrying)
							{
								<span class="spinner-border spinner-border-sm me-1" role="status"></span>
								<span>Retrying...</span>
							}
							else
							{
								<i class="bi bi-three-dots-vertical me-1"></i>
								<span>Actions</span>
							}
						</button>
						<ul class="dropdown-menu dropdown-menu-end">
							<li>
								<button class="dropdown-item" @onclick="OnRetry">
									<i class="bi bi-arrow-repeat me-2"></i>Retry Job
								</button>
							</li>
							@if (ShowRetryOptions)
							{
								<li>
									<button class="dropdown-item" @onclick="OnRetryWithOptions">
										<i class="bi bi-sliders me-2"></i>Retry with Options...
									</button>
								</li>
							}
						</ul>
					</div>
				}
				@if (CanCancel)
				{
					<ActionButton Icon="x-circle" Text="@(IsCancelling ? "Cancelling..." : "Cancel")"
								  Style="ActionButton.ButtonStyle.Danger" Size="ActionButton.ButtonSize.Small"
								  IsLoading="@IsCancelling" OnClick="OnCancel" />
				}
				@if (CanForceCancel)
				{
					<ActionButton Icon="stop-circle" Text="@(IsForceCancelling ? "Stopping..." : "Force Stop")"
								  Style="ActionButton.ButtonStyle.Danger" Size="ActionButton.ButtonSize.Small"
								  IsLoading="@IsForceCancelling" OnClick="OnForceCancel" />
				}
			</div>
		</div>

		@* Activity indicator when job is running *@
		@if (IsRunning && !string.IsNullOrEmpty(CurrentActivity))
		{
			<div
				class="d-flex align-items-center gap-2 mb-2 p-2 bg-info bg-opacity-10 rounded border border-info border-opacity-25">
				<span class="spinner-border spinner-border-sm text-info" role="status"></span>
				<span class="text-body small fw-medium">@CurrentActivity</span>
				@if (LastActivityAt.HasValue)
				{
					<span class="text-body-secondary small ms-auto">@LastActivityAt.Value.FormatTime()</span>
				}
			</div>
		}

		@* Metadata chips row - Status badge moved here with provider *@
		<div class="d-flex flex-wrap align-items-center gap-2 mb-2">
			<StatusBadge Status="@Status.ToString()" />
			@if (CancellationRequested && IsRunning)
			{
				<StatusBadge Status="Cancelling" />
			}
			@if (!string.IsNullOrEmpty(ProviderName))
			{
				<span class="badge bg-primary bg-opacity-75 d-inline-flex align-items-center gap-1 fw-normal"
					  title="Provider">
					<i class="bi bi-robot"></i>
					<span>@ProviderName</span>
				</span>
			}
			@if (!string.IsNullOrEmpty(GitHubRepository))
			{
				<span class="badge bg-dark bg-opacity-75 d-inline-flex align-items-center gap-1 fw-normal">
					<i class="bi bi-github"></i>
					<span>@GitHubRepository</span>
				</span>
			}
			@if (!string.IsNullOrEmpty(BranchName))
			{
				<span class="badge bg-secondary bg-opacity-75 d-inline-flex align-items-center gap-1 fw-normal">
					<i class="bi bi-diagram-2"></i>
					<span>@BranchName</span>
				</span>
			}
			@if (ProcessId.HasValue)
			{
				<span
					class="badge bg-secondary bg-opacity-50 d-inline-flex align-items-center gap-1 fw-normal d-none d-sm-inline-flex"
					title="Process ID">
					<i class="bi bi-cpu"></i>
					<span>PID: @ProcessId</span>
				</span>
			}
			@if (MaxCycles > 1)
			{
				<span class="badge bg-info bg-opacity-75 d-inline-flex align-items-center gap-1 fw-normal"
					  title="@GetCycleModeTitle()">
					<i class="bi bi-arrow-repeat"></i>
					<span>Cycle @CurrentCycle/@MaxCycles</span>
				</span>
			}
		</div>

		@* Timestamps row *@
		<div class="small text-body-secondary">
			<div class="d-flex flex-wrap gap-2 gap-sm-3">
				<span title="Created"><i
					class="bi bi-calendar-plus me-1 opacity-75"></i>@CreatedAt.FormatDateTimeShort()</span>
					@if (StartedAt.HasValue)
					{
						<span title="Started"><i
							class="bi bi-play-circle me-1 opacity-75"></i>@StartedAt.Value.FormatDateTimeShort()</span>
						}
						@if (CompletedAt.HasValue)
						{
							<span title="Completed"><i
								class="bi bi-check-circle me-1 opacity-75"></i>@CompletedAt.Value.FormatDateTimeShort()</span>
							}
							@if (ExecutionDuration.HasValue)
							{
								<span title="Execution Time" class="fw-medium"><i
									class="bi bi-stopwatch me-1 opacity-75"></i>@TokenHelper.FormatDuration(ExecutionDuration)</span>
								}
				else if (IsRunning && StartedAt.HasValue)
								{
									<span title="Running Time" class="fw-medium text-info"><i
										class="bi bi-stopwatch me-1 opacity-75"></i>@TokenHelper.FormatDuration(DateTime.UtcNow -
															StartedAt.Value)</span>
									}
								</div>
							</div>

							@* Stats Row - Token usage and cost *@
							@if (ShowStats)
							{
								<div class="d-flex flex-wrap gap-2 gap-sm-3 mt-2 pt-2 border-top border-secondary border-opacity-25 small">
									@if (!string.IsNullOrEmpty(ModelUsed))
									{
										<span class="d-inline-flex align-items-center px-2 py-1 bg-body-tertiary rounded-pill text-nowrap"
											  title="Model">
											<i class="bi bi-cpu me-1 opacity-75"></i>@ModelUsed
										</span>
									}
									@if (RetryCount > 0)
									{
										<span class="d-inline-flex align-items-center px-2 py-1 bg-body-tertiary rounded-pill text-nowrap"
											  title="Attempt Number">
											<i class="bi bi-arrow-repeat me-1 opacity-75"></i>Attempt @(RetryCount + 1)
										</span>
									}
									@if (InputTokens.HasValue && InputTokens.Value > 0)
									{
										<span class="d-inline-flex align-items-center px-2 py-1 bg-body-tertiary rounded-pill text-nowrap"
											  title="Input Tokens">
											<i class="bi bi-arrow-right-circle me-1 opacity-75"></i>@TokenHelper.FormatTokenCount(InputTokens.Value)
										</span>
									}
									@if (OutputTokens.HasValue && OutputTokens.Value > 0)
									{
										<span class="d-inline-flex align-items-center px-2 py-1 bg-body-tertiary rounded-pill text-nowrap"
											  title="Output Tokens">
											<i class="bi bi-arrow-left-circle me-1 opacity-75"></i>@TokenHelper.FormatTokenCount(OutputTokens.Value)
										</span>
									}
									@if (InputTokens.HasValue && InputTokens.Value > 0 && OutputTokens.HasValue && OutputTokens.Value > 0)
									{
										<span class="d-inline-flex align-items-center px-2 py-1 bg-body-tertiary rounded-pill text-nowrap"
											  title="Total Tokens">
											<i class="bi bi-arrow-left-right me-1 opacity-75"></i>@TokenHelper.FormatTokenCount(InputTokens.Value +
																																											OutputTokens.Value)
										</span>
									}
									@if (TotalCostUsd.HasValue && TotalCostUsd.Value > 0)
									{
										<span class="d-inline-flex align-items-center px-2 py-1 rounded-pill text-nowrap text-success fw-medium"
											  style="background: rgba(63, 185, 80, 0.15);" title="Total Cost">
											<i class="bi bi-currency-dollar me-1 opacity-75"></i>@TokenHelper.FormatCost(TotalCostUsd.Value)
										</span>
									}
								</div>
							}
						</div>
					</div>

@code {
	[Parameter, EditorRequired]
	public JobStatus Status { get; set; }

	/// <summary>
	/// The job title to display in the header (uses Title property from job, which is the original idea text for idea-based
	/// </summary>
	[Parameter]
	public string? JobTitle { get; set; }

	[Parameter]
	public bool CancellationRequested { get; set; }

	[Parameter]
	public string? GitHubRepository { get; set; }

	[Parameter]
	public string? BranchName { get; set; }

	[Parameter]
	public Guid ProjectId { get; set; }

	[Parameter]
	public string ProjectName { get; set; } = "Unknown";

	[Parameter]
	public string ProviderName { get; set; } = "Unknown";

	[Parameter]
	public int? ProcessId { get; set; }

	[Parameter]
	public DateTime CreatedAt { get; set; }

	[Parameter]
	public DateTime? StartedAt { get; set; }

	[Parameter]
	public DateTime? CompletedAt { get; set; }

	[Parameter]
	public TimeSpan? ExecutionDuration { get; set; }

	[Parameter]
	public string? ModelUsed { get; set; }

	[Parameter]
	public int RetryCount { get; set; }

	[Parameter]
	public int? InputTokens { get; set; }

	[Parameter]
	public int? OutputTokens { get; set; }

	[Parameter]
	public decimal? TotalCostUsd { get; set; }

	[Parameter]
	public bool CanRetry { get; set; }

	[Parameter]
	public bool CanCancel { get; set; }

	[Parameter]
	public bool CanForceCancel { get; set; }

	[Parameter]
	public bool ShowRetryOptions { get; set; }

	[Parameter]
	public bool IsRetrying { get; set; }

	[Parameter]
	public bool IsCancelling { get; set; }

	[Parameter]
	public bool IsForceCancelling { get; set; }

	[Parameter]
	public EventCallback OnRetry { get; set; }

	[Parameter]
	public EventCallback OnRetryWithOptions { get; set; }

	[Parameter]
	public EventCallback OnCancel { get; set; }

	[Parameter]
	public EventCallback OnForceCancel { get; set; }

	[Parameter]
	public string? CurrentActivity { get; set; }

	[Parameter]
	public DateTime? LastActivityAt { get; set; }

	[Parameter]
	public int CurrentCycle { get; set; } = 1;

	[Parameter]
	public int MaxCycles { get; set; } = 1;

	[Parameter]
	public CycleMode CycleMode { get; set; } = CycleMode.SingleCycle;

	private bool IsRunning => Status == JobStatus.Started || Status == JobStatus.Processing;

	private bool ShowStats => !string.IsNullOrEmpty(ModelUsed) ||
	(InputTokens.HasValue && InputTokens.Value > 0) ||
	(OutputTokens.HasValue && OutputTokens.Value > 0) ||
	(TotalCostUsd.HasValue && TotalCostUsd.Value > 0) ||
	RetryCount > 0;

	private string GetCycleModeTitle()
	{
		return CycleMode switch
		{
			CycleMode.FixedCount => $"Fixed Count Mode: {CurrentCycle} of {MaxCycles} cycles",
			CycleMode.Autonomous => $"Autonomous Mode: {CurrentCycle} of {MaxCycles} max cycles",
			_ => $"Cycle {CurrentCycle} of {MaxCycles}"
		};
	}
}