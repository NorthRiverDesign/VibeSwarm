@* Goal prompt display card with editable support *@

<div class="card mb-3 mb-lg-4">
	<div class="card-header bg-body-secondary d-flex align-items-center justify-content-between">
		<div class="d-flex align-items-center">
			<i class="bi bi-bullseye me-2 opacity-75"></i>
			<strong>Goal Prompt</strong>
		</div>
		@* Actions *@
		<div class="d-flex align-items-center gap-1">
			@if (IsEditable && _isEditing)
			{
				<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CancelEdit" title="Cancel editing">
					<i class="bi bi-x-lg"></i>
				</button>
				<button type="button" class="btn btn-sm btn-primary" @onclick="SavePrompt" disabled="@_isSaving"
					title="Save changes">
					@if (_isSaving)
					{
						<span class="spinner-border spinner-border-sm" role="status"></span>
					}
					else
					{
						<i class="bi bi-check-lg"></i>
					}
				</button>
			}
			else
			{
				@if (IsEditable)
				{
					<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="StartEdit" title="Edit prompt">
						<i class="bi bi-pencil"></i>
					</button>
				}
				<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CopyToClipboard"
					title="Copy to clipboard">
					<i class="bi bi-clipboard"></i>
				</button>
				<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ShowFullPrompt" title="View full">
					<i class="bi bi-arrows-fullscreen"></i>
				</button>
			}
		</div>
	</div>
	<div class="card-body d-flex flex-column gap-3">
		@if (IsEditable && _isEditing)
		{
			<textarea class="form-control lh-base" style="min-height: 150px; resize: vertical;" @bind="_editedPrompt"
				rows="6" placeholder="Enter the goal prompt for the AI agent..."></textarea>
		}
		else
		{
			<div class="bg-body-tertiary p-3 rounded lh-base text-break" style="white-space: pre-wrap;">
				@GoalPrompt</div>
		}
	</div>
</div>

@* Full Prompt Modal *@
@if (_showModal)
{
	<div class="modal-backdrop fade show vs-modal-backdrop"></div>
	<div class="modal fade show d-block vs-modal-container" tabindex="-1" role="dialog" @onclick="CloseModal">
		<div class="modal-dialog modal-lg vs-modal-dialog modal-dialog-centered modal-dialog-scrollable"
			@onclick:stopPropagation="true">
			<div class="modal-content vs-modal-content">
				<div class="modal-header">
					<h5 class="modal-title"><i class="bi bi-file-text me-2"></i>Full Input Prompt</h5>
					<button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<pre class="bg-body-tertiary border rounded p-3 overflow-auto lh-base m-0 text-break"
						style="white-space: pre-wrap; max-height: 60vh;">@GoalPrompt</pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" @onclick="CopyToClipboard">
						<i class="bi bi-clipboard me-1"></i>Copy to Clipboard
					</button>
					<button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
				</div>
			</div>
		</div>
	</div>
}

@code {
	[Parameter, EditorRequired]
	public string GoalPrompt { get; set; } = string.Empty;

	[Parameter]
	public JobStatus Status { get; set; }

	[Parameter]
	public bool CanRetry { get; set; }

	[Parameter]
	public bool HasConsoleOutput { get; set; }

	[Parameter]
	public EventCallback OnCopyToClipboard { get; set; }

	[Parameter]
	public EventCallback<string> OnPromptChanged { get; set; }

	private bool _showModal = false;
	private bool _isEditing = false;
	private string _editedPrompt = string.Empty;
	private bool _isSaving = false;

	private bool IsEditable => Status == JobStatus.New || Status == JobStatus.Failed || Status == JobStatus.Cancelled;

	private void ShowFullPrompt()
	{
		_showModal = true;
	}

	private void CloseModal()
	{
		_showModal = false;
	}

	private async Task CopyToClipboard()
	{
		await OnCopyToClipboard.InvokeAsync();
	}

	private void StartEdit()
	{
		_editedPrompt = GoalPrompt;
		_isEditing = true;
	}

	private void CancelEdit()
	{
		_isEditing = false;
		_editedPrompt = string.Empty;
	}

	private async Task SavePrompt()
	{
		if (string.IsNullOrWhiteSpace(_editedPrompt)) return;

		_isSaving = true;
		try
		{
			await OnPromptChanged.InvokeAsync(_editedPrompt);
			_isEditing = false;
		}
		finally
		{
			_isSaving = false;
		}
	}
}