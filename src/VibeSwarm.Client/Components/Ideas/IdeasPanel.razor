@* Ideas panel component for managing project feature ideas *@
@inject IProjectService ProjectService
@using VibeSwarm.Shared.Data

<div class="card">
	<div class="card-header bg-body-secondary d-flex justify-content-between align-items-center">
		<h5 class="mb-0 fw-semibold">
			<i class="bi bi-lightbulb me-2"></i>Ideas
		</h5>
		<div class="d-flex align-items-center gap-2">
			<span class="badge bg-secondary">@Ideas.Count</span>
			@if (Ideas.Count >= 1)
			{
				@if (IsProcessingActive)
				{
					<button type="button" class="btn btn-sm btn-outline-danger" @onclick="OnStopProcessing"
							disabled="@IsTogglingProcessing">
						@if (IsTogglingProcessing)
						{
							<span class="spinner-border spinner-border-sm me-1" role="status"></span>
						}
						else
						{
							<i class="bi bi-stop-fill me-1"></i>
						}
						Stop
					</button>
				}
				else
				{
					<button type="button" class="btn btn-sm btn-success" @onclick="OpenStartAllModal"
<<<<<<< Updated upstream
						disabled="@(IsTogglingProcessing || !HasDefaultProvider || HasActiveJobs)"
						title="@(HasActiveJobs ? "A job is already running on this project" : "Start all ideas processing")">
=======
							disabled="@(IsTogglingProcessing || !HasDefaultProvider || HasActiveJobs || UnprocessedIdeasCount == 0)"
							title="@(HasActiveJobs ? "A job is already running on this project" : UnprocessedIdeasCount == 0 ? "All ideas have already been processed" : "Start all ideas processing")">
>>>>>>> Stashed changes
						@if (IsTogglingProcessing)
						{
							<span class="spinner-border spinner-border-sm me-1" role="status"></span>
						}
						else
						{
							<i class="bi bi-play-fill me-1"></i>
						}
						Start All
					</button>
				}
			}
		</div>
	</div>
	<div class="card-body">
		@* Add New Idea Form *@
		<div class="mb-3">
			<div class="d-flex gap-2 align-items-end">
				<div class="flex-grow-1">
					<textarea class="form-control" rows="2" placeholder="Enter a feature idea..."
							  @bind="NewIdeaDescription" @bind:event="oninput" @onkeypress="HandleKeyPress"></textarea>
				</div>
				<button type="button" class="btn btn-primary" @onclick="AddIdea"
						disabled="@(string.IsNullOrWhiteSpace(NewIdeaDescription) || IsAddingIdea)" style="height: 58px;">
					@if (IsAddingIdea)
					{
						<span class="spinner-border spinner-border-sm" role="status"></span>
					}
					else
					{
						<i class="bi bi-plus-lg"></i>
					}
				</button>
			</div>
			<div class="form-text">
				Short description of a feature or update. Ideas will be expanded into full specs when processed. Press
				Ctrl+Enter to submit.
			</div>
		</div>

		@if (IsProcessingActive)
		{
			<div class="alert alert-info py-2 mb-3 d-flex align-items-center gap-2">
				<span class="spinner-border spinner-border-sm" role="status"></span>
				<span>Auto-processing active. Ideas will be converted to jobs automatically.</span>
			</div>
		}

		@* Ideas List *@
		@if (!Ideas.Any())
		{
			<div class="text-body-secondary text-center py-3">
				<i class="bi bi-lightbulb fs-1 opacity-50 mb-2 d-block"></i>
				<p class="mb-0">No ideas yet. Add some feature ideas above!</p>
			</div>
		}
		else
		{
			<ul class="list-group list-group-flush">
				@foreach (var idea in Ideas)
				{
					<IdeaListItem Idea="idea" IsProcessing="@(idea.IsProcessing || IsIdeaProcessing(idea.Id))"
								  IsStarting="@(StartingIdeaId == idea.Id)" HasActiveJobs="@HasActiveJobs"
								  HasDefaultProvider="@HasDefaultProvider" OnExpand="@(() => OpenExpandModal(idea))"
								  OnStart="@(() => StartSingleIdea(idea))" OnCopy="@(() => OpenCopyModal(idea))"
								  OnMove="@(() => OpenMoveModal(idea))" OnDelete="@(() => OnDeleteIdea.InvokeAsync(idea.Id))"
								  OnSaveEdit="HandleIdeaEdit" />
				}
			</ul>
		}

		@if (!HasDefaultProvider && Ideas.Any())
		{
			<div class="alert alert-warning py-2 mt-3 mb-0">
				<i class="bi bi-exclamation-triangle me-1"></i>
				<a href="/providers">Set a default provider</a> to enable Ideas auto-processing.
			</div>
		}
	</div>
</div>

@* Copy Idea Modal *@
<ProjectTransferModal @bind-IsVisible="ShowCopyModal" IdeaDescription="@(SelectedIdea?.Description ?? "")"
					  ExcludeProjectId="@CurrentProjectId" AvailableProjects="@AvailableProjects" IsMove="false"
					  IsProcessing="@IsProcessingAction" OnConfirm="ConfirmCopyIdea" OnCancel="CloseModals" />

@* Move Idea Modal *@
<ProjectTransferModal @bind-IsVisible="ShowMoveModal" IdeaDescription="@(SelectedIdea?.Description ?? "")"
					  ExcludeProjectId="@CurrentProjectId" AvailableProjects="@AvailableProjects" IsMove="true"
					  IsProcessing="@IsProcessingAction" OnConfirm="ConfirmMoveIdea" OnCancel="CloseModals" />

@* Idea Expansion Modal *@
<IdeaExpansionModal @bind-IsVisible="ShowExpansionModal" Idea="SelectedIdeaForExpansion" IsExpanding="IsExpandingIdea"
					IsProcessing="IsProcessingExpansion" OnExpand="HandleExpandIdea" OnApprove="HandleApproveExpansion"
					OnReject="HandleRejectExpansion" />

@* Start All Confirmation Modal *@
<ModalDialog @bind-IsVisible="_showStartAllModal" Title="Start All Ideas" Icon="play-fill"
			 Size="ModalDialog.ModalSize.Small">
	<ChildContent>
		<p>Start processing <strong>@UnprocessedIdeasCount</strong> idea@(UnprocessedIdeasCount == 1 ? "" : "s")? Ideas
			will be expanded and converted to jobs automatically.</p>

			@if (IsGitRepository)
			{
				<div class="mb-2">
					<label for="startAllAutoCommit" class="form-label fw-medium">Auto-Commit Mode</label>
					<select id="startAllAutoCommit" class="form-select" @bind="_startAllAutoCommitMode">
						<option value="@AutoCommitMode.Off">Off - Manual commit required</option>
						<option value="@AutoCommitMode.CommitOnly">Commit Only - Auto-commit after job completion</option>
						<option value="@AutoCommitMode.CommitAndPush">Commit & Push - Auto-commit and push</option>
					</select>
					<div class="form-text">Controls what happens after each job completes.</div>
				</div>
			}
		</ChildContent>
		<FooterContent>
			<button type="button" class="btn btn-secondary" @onclick="CloseStartAllModal">Cancel</button>
			<button type="button" class="btn btn-success" @onclick="ConfirmStartAll" disabled="@IsTogglingProcessing">
				@if (IsTogglingProcessing)
				{
					<span class="spinner-border spinner-border-sm me-1" role="status"></span>
				}
				<i class="bi bi-play-fill me-1"></i>Start All
			</button>
		</FooterContent>
	</ModalDialog>

@* Start All Ideas Modal *@
<StartAllIdeasModal @ref="StartAllModal" @bind-IsVisible="ShowStartAllModal"
	IdeasCount="@UnprocessedIdeasCount" IsProcessing="@IsTogglingProcessing"
	OnConfirm="HandleStartAllConfirm" OnCancel="CloseStartAllModal" />

@code {
	[Parameter]
	public List<Idea> Ideas { get; set; } = new();

	[Parameter]
	public Guid CurrentProjectId { get; set; }

	[Parameter]
	public bool IsProcessingActive { get; set; }

	[Parameter]
	public bool IsTogglingProcessing { get; set; }

	[Parameter]
	public bool HasDefaultProvider { get; set; }

	[Parameter]
	public bool HasActiveJobs { get; set; }

	[Parameter]
	public bool IsAddingIdea { get; set; }

	[Parameter]
	public HashSet<Guid> ProcessingIdeaIds { get; set; } = new();

	[Parameter]
	public EventCallback<bool> OnStartProcessing { get; set; }

	[Parameter]
	public EventCallback OnStopProcessing { get; set; }

	[Parameter]
	public EventCallback<string> OnAddIdea { get; set; }

	[Parameter]
	public EventCallback<Idea> OnUpdateIdea { get; set; }

	[Parameter]
	public EventCallback<Guid> OnDeleteIdea { get; set; }

	[Parameter]
	public EventCallback<(Guid ideaId, Guid targetProjectId)> OnCopyIdea { get; set; }

	[Parameter]
	public EventCallback<(Guid ideaId, Guid targetProjectId)> OnMoveIdea { get; set; }

	[Parameter]
	public EventCallback<Guid> OnStartSingleIdea { get; set; }

	[Parameter]
	public EventCallback<Guid> OnExpandIdea { get; set; }

	[Parameter]
	public EventCallback<(Guid ideaId, string? editedDescription)> OnApproveExpansion { get; set; }

	[Parameter]
	public EventCallback<Guid> OnRejectExpansion { get; set; }

	[Parameter]
	public AutoCommitMode CurrentAutoCommitMode { get; set; } = AutoCommitMode.Off;

	[Parameter]
	public bool IsGitRepository { get; set; }

	[Parameter]
	public EventCallback<AutoCommitMode> OnStartProcessingWithOptions { get; set; }

	private string NewIdeaDescription { get; set; } = string.Empty;
	private Guid? StartingIdeaId { get; set; }

	// Start All confirmation modal state
	private bool _showStartAllModal { get; set; }
	private AutoCommitMode _startAllAutoCommitMode { get; set; }

	// Modal state
	private bool ShowCopyModal { get; set; }
	private bool ShowMoveModal { get; set; }
	private bool ShowExpansionModal { get; set; }
	private bool ShowStartAllModal { get; set; }
	private StartAllIdeasModal? StartAllModal { get; set; }
	private Idea? SelectedIdea { get; set; }
	private Idea? SelectedIdeaForExpansion { get; set; }
	private List<Project> AvailableProjects { get; set; } = new();
	private bool IsProcessingAction { get; set; }
	private bool IsExpandingIdea { get; set; }
	private bool IsProcessingExpansion { get; set; }

	private int UnprocessedIdeasCount => Ideas.Count(i => !i.IsProcessing && !i.JobId.HasValue);

	private void OpenStartAllModal()
	{
		StartAllModal?.Reset();
		ShowStartAllModal = true;
	}

	private void CloseStartAllModal()
	{
		ShowStartAllModal = false;
	}

	private async Task HandleStartAllConfirm(bool autoCommit)
	{
		await OnStartProcessing.InvokeAsync(autoCommit);
		ShowStartAllModal = false;
	}

	private async Task HandleKeyPress(KeyboardEventArgs e)
	{
		if (e.Key == "Enter" && e.CtrlKey && !string.IsNullOrWhiteSpace(NewIdeaDescription))
		{
			await AddIdea();
		}
	}

	private async Task AddIdea()
	{
		if (string.IsNullOrWhiteSpace(NewIdeaDescription)) return;
		await OnAddIdea.InvokeAsync(NewIdeaDescription.Trim());
		NewIdeaDescription = string.Empty;
	}

	private async Task HandleIdeaEdit(Idea idea)
	{
		await OnUpdateIdea.InvokeAsync(idea);
	}

	private async Task OpenCopyModal(Idea idea)
	{
		SelectedIdea = idea;
		await LoadAvailableProjects();
		ShowCopyModal = true;
	}

	private async Task OpenMoveModal(Idea idea)
	{
		SelectedIdea = idea;
		await LoadAvailableProjects();
		ShowMoveModal = true;
	}

	private async Task LoadAvailableProjects()
	{
		try
		{
			AvailableProjects = (await ProjectService.GetAllAsync()).ToList();
		}
		catch
		{
			AvailableProjects = new List<Project>();
		}
	}

	private void CloseModals()
	{
		ShowCopyModal = false;
		ShowMoveModal = false;
		SelectedIdea = null;
	}

	private async Task ConfirmCopyIdea(Guid targetProjectId)
	{
		if (SelectedIdea == null) return;

		IsProcessingAction = true;
		try
		{
			await OnCopyIdea.InvokeAsync((SelectedIdea.Id, targetProjectId));
			CloseModals();
		}
		finally
		{
			IsProcessingAction = false;
		}
	}

	private async Task ConfirmMoveIdea(Guid targetProjectId)
	{
		if (SelectedIdea == null) return;

		IsProcessingAction = true;
		try
		{
			await OnMoveIdea.InvokeAsync((SelectedIdea.Id, targetProjectId));
			CloseModals();
		}
		finally
		{
			IsProcessingAction = false;
		}
	}

	private async Task StartSingleIdea(Idea idea)
	{
		// Set the starting ID to show spinner immediately
		StartingIdeaId = idea.Id;
		StateHasChanged();

		try
		{
			// The parent component handles adding to ProcessingIdeaIds and calling the API
			await OnStartSingleIdea.InvokeAsync(idea.Id);
		}
		finally
		{
			StartingIdeaId = null;
			StateHasChanged();
		}
	}

	private bool IsIdeaProcessing(Guid ideaId) => ProcessingIdeaIds.Contains(ideaId);

	private void OpenExpandModal(Idea idea)
	{
		SelectedIdeaForExpansion = idea;
		ShowExpansionModal = true;
	}

	private async Task HandleExpandIdea(Guid ideaId)
	{
		IsExpandingIdea = true;
		StateHasChanged();

		try
		{
			await OnExpandIdea.InvokeAsync(ideaId);
			var updated = Ideas.FirstOrDefault(i => i.Id == ideaId);
			if (updated != null)
			{
				SelectedIdeaForExpansion = updated;
			}
		}
		finally
		{
			IsExpandingIdea = false;
			StateHasChanged();
		}
	}

	private async Task HandleApproveExpansion((Guid ideaId, string? editedDescription) args)
	{
		IsProcessingExpansion = true;
		StateHasChanged();

		try
		{
			await OnApproveExpansion.InvokeAsync(args);
		}
		finally
		{
			IsProcessingExpansion = false;
			ShowExpansionModal = false;
			SelectedIdeaForExpansion = null;
			StateHasChanged();
		}
	}

	private async Task HandleRejectExpansion(Guid ideaId)
	{
		IsProcessingExpansion = true;
		StateHasChanged();

		try
		{
			await OnRejectExpansion.InvokeAsync(ideaId);
			var updated = Ideas.FirstOrDefault(i => i.Id == ideaId);
			if (updated != null)
			{
				SelectedIdeaForExpansion = updated;
			}
		}
		finally
		{
			IsProcessingExpansion = false;
			StateHasChanged();
		}
	}

	private int UnprocessedIdeasCount => Ideas.Count(i => !i.IsProcessing && !i.JobId.HasValue);

	private void OpenStartAllModal()
	{
		_startAllAutoCommitMode = CurrentAutoCommitMode;
		_showStartAllModal = true;
	}

	private void CloseStartAllModal()
	{
		_showStartAllModal = false;
	}

	private async Task ConfirmStartAll()
	{
		_showStartAllModal = false;
		await OnStartProcessingWithOptions.InvokeAsync(_startAllAutoCommitMode);
	}
}