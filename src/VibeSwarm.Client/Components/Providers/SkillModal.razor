@* Modal component for adding and editing skills *@
@using VibeSwarm.Shared.Data
@using VibeSwarm.Shared.Services
@inject ISkillService SkillService
@inject IProviderService ProviderService

<ModalDialog IsVisible="IsVisible" IsVisibleChanged="HandleModalVisibilityChanged"
	Title="@(IsEdit ? "Edit Skill" : "Add Skill")" Icon="@(IsEdit ? "pencil" : "lightbulb")"
	Size="ModalDialog.ModalSize.Large" OnClose="HandleClose">
	<ChildContent>
		<EditForm Model="@Skill" OnValidSubmit="HandleValidSubmit">
			<DataAnnotationsValidator />
			<ValidationSummary class="text-danger mb-3" />

			<div class="mb-3">
				<label for="modal-name" class="form-label">Name</label>
				<InputText id="modal-name" @bind-Value="Skill.Name" class="form-control" placeholder="my-skill-name" />
				<ValidationMessage For="@(() => Skill.Name)" class="text-danger small" />
				<div class="form-text">
					Used as the MCP tool identifier. Use lowercase with hyphens.
				</div>
			</div>

			<div class="mb-3">
				<label for="modal-description" class="form-label">Description</label>
				<InputTextArea id="modal-description" @bind-Value="Skill.Description" class="form-control" rows="2"
					placeholder="Brief description of what this skill does..." />
				<div class="form-text">
					Shown to AI agents when they list available skills.
				</div>
			</div>

			<div class="mb-3">
				<label for="modal-content" class="form-label d-flex align-items-center justify-content-between">
					<span>Content (Markdown)</span>
					<button type="button" class="btn btn-sm btn-outline-info" @onclick="ToggleExpansionPanel"
						disabled="@(string.IsNullOrWhiteSpace(Skill.Description))">
						<i class="bi bi-magic me-1"></i>AI Expand
					</button>
				</label>

				@* AI Expansion Panel *@
				@if (_showExpansionPanel)
				{
					<div class="card bg-body-tertiary mb-2">
						<div class="card-body py-2">
							<div class="row g-2 align-items-end">
								<div class="col-12 col-md-5">
									<label class="form-label small mb-1">Provider</label>
									<select class="form-select form-select-sm" @bind="_selectedProviderId"
										@bind:after="LoadModelsForProvider">
										<option value="">Select provider...</option>
										@foreach (var provider in _providers.Where(p => p.IsEnabled))
										{
											<option value="@provider.Id">@provider.Name</option>
										}
									</select>
								</div>
								<div class="col-12 col-md-4">
									<label class="form-label small mb-1">Model</label>
									<select class="form-select form-select-sm" @bind="_selectedModelId"
										disabled="@(!_models.Any())">
										<option value="">@(_isLoadingModels ? "Loading..." : "Default")</option>
										@foreach (var model in _models.Where(m => m.IsAvailable))
										{
											<option value="@model.ModelId">@model.DisplayName</option>
										}
									</select>
								</div>
								<div class="col-12 col-md-3">
									<button type="button" class="btn btn-sm btn-primary w-100" @onclick="ExpandWithAI"
										disabled="@(_selectedProviderId == Guid.Empty || _isExpanding)">
										@if (_isExpanding)
										{
											<span class="spinner-border spinner-border-sm me-1" role="status"></span>
											<span>Expanding...</span>
										}
										else
										{
											<i class="bi bi-stars me-1"></i>
											<span>Generate</span>
										}
									</button>
								</div>
							</div>
							@if (!string.IsNullOrEmpty(_expansionError))
							{
								<div class="alert alert-danger py-1 px-2 mt-2 mb-0 small">
									<i class="bi bi-exclamation-triangle me-1"></i>@_expansionError
								</div>
							}
						</div>
					</div>
				}

				<InputTextArea id="modal-content" @bind-Value="Skill.Content" class="form-control font-monospace"
					rows="10"
					placeholder="# Skill Instructions&#10;&#10;Provide detailed instructions for the AI agent..." />
				<ValidationMessage For="@(() => Skill.Content)" class="text-danger small" />
				<div class="form-text">
					Markdown content defining the skill's instructions and capabilities.
				</div>
			</div>

			<div class="mb-3">
				<div class="form-check form-switch">
					<InputCheckbox id="modal-isEnabled" @bind-Value="Skill.IsEnabled" class="form-check-input" />
					<label class="form-check-label" for="modal-isEnabled">
						Enabled
					</label>
				</div>
				<div class="form-text">
					Disabled skills will not be exposed to providers.
				</div>
			</div>

			@if (!string.IsNullOrEmpty(ErrorMessage))
			{
				<Alert Type="Alert.AlertType.Danger" Message="@ErrorMessage" Class="mb-3" />
			}

			@if (!string.IsNullOrEmpty(SuccessMessage))
			{
				<Alert Type="Alert.AlertType.Success" Message="@SuccessMessage" Class="mb-3" />
			}

			<div class="d-flex gap-2 justify-content-end">
				<button type="button" class="btn btn-secondary" @onclick="HandleCancel">Cancel</button>
				<button type="submit" class="btn btn-primary" disabled="@IsSaving">
					@if (IsSaving)
					{
						<span class="spinner-border spinner-border-sm me-1" role="status"></span>
					}
					@(IsSaving ? "Saving..." : (IsEdit ? "Update Skill" : "Add Skill"))
				</button>
			</div>
		</EditForm>
	</ChildContent>
</ModalDialog>

@code {
	[Parameter]
	public bool IsVisible { get; set; }

	[Parameter]
	public EventCallback<bool> IsVisibleChanged { get; set; }

	[Parameter]
	public Skill? EditSkill { get; set; }

	[Parameter]
	public EventCallback<Guid?> OnSaved { get; set; }

	[Parameter]
	public EventCallback OnCancelled { get; set; }

	[Parameter]
	public EventCallback OnClosed { get; set; }

	private Skill Skill { get; set; } = new();
	private bool IsEdit => EditSkill != null;
	private bool IsSaving { get; set; }
	private string? ErrorMessage { get; set; }
	private string? SuccessMessage { get; set; }
	private bool _previousIsVisible;

	// AI Expansion state
	private bool _showExpansionPanel;
	private bool _isExpanding;
	private string? _expansionError;
	private List<Provider> _providers = new();
	private List<ProviderModel> _models = new();
	private Guid _selectedProviderId;
	private string _selectedModelId = string.Empty;
	private bool _isLoadingModels;

	protected override async Task OnInitializedAsync()
	{
		await LoadProviders();
	}

	protected override void OnParametersSet()
	{
		// Only reset state when modal is opening (transitioning from hidden to visible)
		if (IsVisible && !_previousIsVisible)
		{
			ResetState();

			if (EditSkill != null)
			{
				// Clone the skill for editing
				Skill = new Skill
				{
					Id = EditSkill.Id,
					Name = EditSkill.Name,
					Description = EditSkill.Description,
					Content = EditSkill.Content,
					IsEnabled = EditSkill.IsEnabled,
					CreatedAt = EditSkill.CreatedAt,
					UpdatedAt = EditSkill.UpdatedAt
				};
			}
			else
			{
				// Reset for new skill
				Skill = new Skill();
			}
		}

		_previousIsVisible = IsVisible;
	}

	private async Task LoadProviders()
	{
		try
		{
			_providers = (await ProviderService.GetAllAsync()).ToList();

			// Pre-select default provider if available
			var defaultProvider = _providers.FirstOrDefault(p => p.IsDefault && p.IsEnabled);
			if (defaultProvider != null)
			{
				_selectedProviderId = defaultProvider.Id;
				await LoadModelsForProvider();
			}
		}
		catch
		{
			_providers = new();
		}
	}

	private async Task LoadModelsForProvider()
	{
		if (_selectedProviderId == Guid.Empty)
		{
			_models = new();
			return;
		}

		_isLoadingModels = true;
		_selectedModelId = string.Empty;
		StateHasChanged();

		try
		{
			_models = (await ProviderService.GetModelsAsync(_selectedProviderId)).ToList();

			// Pre-select default model if available
			var defaultModel = _models.FirstOrDefault(m => m.IsDefault && m.IsAvailable);
			if (defaultModel != null)
			{
				_selectedModelId = defaultModel.ModelId;
			}
		}
		catch
		{
			_models = new();
		}
		finally
		{
			_isLoadingModels = false;
		}
	}

	private void ToggleExpansionPanel()
	{
		_showExpansionPanel = !_showExpansionPanel;
		_expansionError = null;
	}

	private async Task ExpandWithAI()
	{
		if (_selectedProviderId == Guid.Empty || string.IsNullOrWhiteSpace(Skill.Description))
			return;

		_isExpanding = true;
		_expansionError = null;
		StateHasChanged();

		try
		{
			var result = await SkillService.ExpandSkillAsync(
			Skill.Description,
			_selectedProviderId,
			string.IsNullOrEmpty(_selectedModelId) ? null : _selectedModelId);

			if (!string.IsNullOrWhiteSpace(result))
			{
				Skill.Content = result;
				_showExpansionPanel = false;
			}
			else
			{
				_expansionError = "Failed to expand skill. Please try again.";
			}
		}
		catch (Exception ex)
		{
			_expansionError = $"Error: {ex.Message}";
		}
		finally
		{
			_isExpanding = false;
		}
	}

	private async Task HandleValidSubmit()
	{
		IsSaving = true;
		ErrorMessage = null;
		SuccessMessage = null;

		try
		{
			// Validate unique name
			var nameExists = await SkillService.NameExistsAsync(
			Skill.Name,
			IsEdit ? Skill.Id : null);

			if (nameExists)
			{
				ErrorMessage = "A skill with this name already exists.";
				IsSaving = false;
				return;
			}

			Guid? newSkillId = null;

			if (IsEdit)
			{
				await SkillService.UpdateAsync(Skill);
				SuccessMessage = "Skill updated successfully.";
			}
			else
			{
				var created = await SkillService.CreateAsync(Skill);
				newSkillId = created.Id;
				SuccessMessage = "Skill added successfully.";
			}

			await OnSaved.InvokeAsync(newSkillId);
			await CloseModal();
		}
		catch (Exception ex)
		{
			ErrorMessage = $"Error saving skill: {ex.Message}";
		}
		finally
		{
			IsSaving = false;
		}
	}

	private async Task HandleCancel()
	{
		await OnCancelled.InvokeAsync();
		await CloseModal();
	}

	private async Task HandleClose()
	{
		ResetState();
		await OnClosed.InvokeAsync();
	}

	private async Task HandleModalVisibilityChanged(bool visible)
	{
		if (!visible)
		{
			ResetState();
			await IsVisibleChanged.InvokeAsync(false);
		}
	}

	private async Task CloseModal()
	{
		IsVisible = false;
		await IsVisibleChanged.InvokeAsync(false);
		ResetState();
	}

	private void ResetState()
	{
		Skill = new Skill();
		ErrorMessage = null;
		SuccessMessage = null;
		IsSaving = false;
		_showExpansionPanel = false;
		_isExpanding = false;
		_expansionError = null;
		_selectedModelId = string.Empty;
	}
}