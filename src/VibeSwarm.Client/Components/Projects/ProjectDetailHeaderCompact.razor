@* Compact project detail header with title on left, working directory on right *@
@using VibeSwarm.Shared.VersionControl.Models

@* Breadcrumb Navigation *@
<Breadcrumb Items="@_breadcrumbItems" />

<div class="card mb-3 border-0 shadow-sm">
	<div class="card-body bg-body-secondary p-3">
		@* Single Row: Title left, Working Path + Git right *@
		<div class="d-flex flex-wrap align-items-center gap-2 gap-md-3">
			@* Title Section *@
			<div class="d-flex align-items-center gap-2 flex-shrink-0">
				<h3 class="mb-0 fs-5 fw-semibold">@Name</h3>
				@if (IsGitRepository && !string.IsNullOrEmpty(GitHubRepository))
				{
					<a href="https://github.com/@GitHubRepository" target="_blank"
						class="d-flex align-items-center gap-1 text-body-secondary text-decoration-none small"
						title="View on GitHub">
						<i class="bi bi-github"></i>
					</a>
				}
			</div>

			@* Spacer *@
			<div class="flex-grow-1"></div>

			@* Working Path *@
			<div class="d-none d-md-flex align-items-center gap-1 text-body-secondary small">
				<i class="bi bi-folder opacity-75"></i>
				<code class="bg-body-tertiary px-2 py-1 rounded-1 text-truncate d-inline-block"
					style="max-width: 300px;" title="@WorkingPath">@WorkingPath</code>
			</div>

			@* Branch Selector (Git repos only) *@
			@if (IsGitRepository && Branches.Any())
			{
				<GitBranchSelector Branches="@Branches" CurrentBranch="@CurrentBranch"
					CurrentCommitHash="@CurrentCommitHash" IsDisabled="@IsGitOperationInProgress"
					OnBranchSelected="OnBranchSelected" />
			}
			else if (IsGitRepository && !string.IsNullOrEmpty(CurrentBranch))
			{
				<span class="badge bg-body-tertiary text-body d-flex align-items-center gap-1">
					<i class="bi bi-git text-danger"></i>
					@CurrentBranch
				</span>
			}

			@* Uncommitted Changes Warning Icon *@
			@if (IsGitRepository && HasUncommittedChanges)
			{
				<UncommittedChangesButton FilesCount="@UncommittedFilesCount" OnClick="OnUncommittedChangesClick" />
			}

			@* Token/Cost Stats (when data exists) *@
			@if (HasTokenData)
			{
				<div class="d-none d-lg-flex align-items-center gap-2">
					@if (TotalInputTokens > 0 || TotalOutputTokens > 0)
					{
						<div class="d-flex align-items-center gap-1 small text-body-secondary"
							title="Total tokens (input / output)">
							<i class="bi bi-braces opacity-75"></i>
							<span>@TokenHelper.FormatTokenCount(TotalInputTokens) /
								@TokenHelper.FormatTokenCount(TotalOutputTokens)</span>
						</div>
					}
					@if (TotalCost > 0)
					{
						<div class="d-flex align-items-center gap-1 small fw-medium text-success" title="Total cost">
							<i class="bi bi-currency-dollar opacity-75"></i>
							<span>@TokenHelper.FormatCost(TotalCost)</span>
						</div>
					}
				</div>
			}

			@* Git Actions Dropdown (when Git repo) *@
			@if (IsGitRepository)
			{
				<GitActionsDropdown IsDisabled="@IsGitOperationInProgress" IsSyncing="@(_currentGitOperation == "sync")"
					IsRefreshing="@(_currentGitOperation == "refresh")" OnCreateBranch="OnCreateBranch" OnSync="OnSync"
					OnRefresh="OnRefresh" />
			}
		</div>

		@* Git Operation Messages *@
		<AlertMessage Message="@GitOperationMessage" IsSuccess="@GitOperationSuccess"
			ProgressMessage="@GitProgressMessage" OnDismiss="OnClearGitMessage" />
	</div>
</div>

@code {
	[Parameter, EditorRequired]
	public string Name { get; set; } = string.Empty;

	[Parameter, EditorRequired]
	public string WorkingPath { get; set; } = string.Empty;

	[Parameter]
	public string? GitHubRepository { get; set; }

	[Parameter]
	public bool IsGitRepository { get; set; }

	private List<Breadcrumb.BreadcrumbItem> _breadcrumbItems => new()
{
new Breadcrumb.BreadcrumbItem("Projects", "/projects", "folder"),
new Breadcrumb.BreadcrumbItem(Name)
};

	[Parameter]
	public List<GitBranchInfo> Branches { get; set; } = new();

	[Parameter]
	public string? CurrentBranch { get; set; }

	[Parameter]
	public string? CurrentCommitHash { get; set; }

	[Parameter]
	public bool IsGitOperationInProgress { get; set; }

	[Parameter]
	public string? GitOperationMessage { get; set; }

	[Parameter]
	public bool GitOperationSuccess { get; set; }

	[Parameter]
	public string? GitProgressMessage { get; set; }

	[Parameter]
	public bool HasUncommittedChanges { get; set; }

	[Parameter]
	public int UncommittedFilesCount { get; set; }

	[Parameter]
	public bool HasTokenData { get; set; }

	[Parameter]
	public int TotalInputTokens { get; set; }

	[Parameter]
	public int TotalOutputTokens { get; set; }

	[Parameter]
	public decimal TotalCost { get; set; }

	[Parameter]
	public EventCallback OnCreateBranch { get; set; }

	[Parameter]
	public EventCallback OnSync { get; set; }

	[Parameter]
	public EventCallback OnRefresh { get; set; }

	[Parameter]
	public EventCallback<string> OnBranchSelected { get; set; }

	[Parameter]
	public EventCallback OnUncommittedChangesClick { get; set; }

	[Parameter]
	public EventCallback OnClearGitMessage { get; set; }

	private string? _currentGitOperation => IsGitOperationInProgress ? GitProgressMessage?.Contains("Fetching") == true ?
	"refresh" : "sync" : null;
}