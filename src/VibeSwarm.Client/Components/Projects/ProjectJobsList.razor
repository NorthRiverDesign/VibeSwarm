@* Project jobs list component *@
@using VibeSwarm.Shared.Utilities

<div class="card">
	<div class="card-header bg-body-secondary d-flex justify-content-between align-items-center">
		<h5 class="mb-0 fw-semibold">Jobs</h5>
		<div class="d-flex align-items-center gap-2">
			<span class="badge bg-secondary">@Jobs.Count</span>
			<button type="button" class="btn btn-sm btn-primary" @onclick="() => OnCreateJob.InvokeAsync()"
					disabled="@HasActiveJobs"
					title="@(HasActiveJobs ? "A job is already running on this project" : "Create a new job")">
				<i class="bi bi-plus-lg me-1"></i>Create Job
			</button>
		</div>
	</div>
	<div class="card-body p-0">
		@if (!Jobs.Any())
		{
			<div class="p-3">
				<EmptyState Icon="list-check" Title="No jobs yet"
							Message="Create a job to start working on this project." />
			</div>
		}
		else
		{
			<ul class="list-group list-group-flush">
				@foreach (var job in Jobs)
				{
					<li class="list-group-item">
						<div class="d-flex justify-content-between align-items-start gap-2">
							<div class="d-flex align-items-start gap-2 flex-grow-1 min-width-0">
								@* Status Icon *@
								<div class="flex-shrink-0 pt-1">
									@switch (job.Status)
									{
										case JobStatus.Completed:
											<i class="bi bi-check-circle-fill text-success fs-5" title="Completed"></i>
											break;
										case JobStatus.Failed:
										case JobStatus.Cancelled:
											<i class="bi bi-x-circle-fill text-danger fs-5" title="@job.Status.ToString()"></i>
											break;
										case JobStatus.Started:
										case JobStatus.Processing:
											<div class="spinner-border spinner-border-sm text-primary" role="status"
												 title="@job.Status.ToString()">
												<span class="visually-hidden">Processing...</span>
											</div>
											break;
										case JobStatus.Pending:
											<i class="bi bi-hourglass-split text-warning fs-5" title="Pending"></i>
											break;
										case JobStatus.Paused:
											<i class="bi bi-pause-circle-fill text-warning fs-5" title="Paused - Waiting for input"></i>
											break;
										case JobStatus.Stalled:
											<i class="bi bi-exclamation-triangle-fill text-warning fs-5" title="Stalled"></i>
											break;
										default:
											<i class="bi bi-circle text-secondary fs-5" title="@job.Status.ToString()"></i>
											break;
									}
								</div>
								@* Job Content *@
								<div class="flex-grow-1 min-width-0">
									<a href="/jobs/view/@job.Id"
										   class="d-block text-decoration-none fw-medium text-truncate-lines-2"
										   title="@job.GoalPrompt">
										@GetJobDisplayTitle(job)
									</a>
									<div class="d-flex flex-wrap gap-2 mt-1 small text-body-secondary">
										<span>@(job.Provider?.Name ?? "Unknown")</span>
										@if (!string.IsNullOrEmpty(job.ModelUsed))
										{
											<span class="text-body-tertiary">•</span>
											<span class="text-body-tertiary" title="Model">@FormatModelName(job.ModelUsed)</span>
										}
										<span class="text-body-tertiary">•</span>
										<span>@job.CreatedAt.FormatDateTimeShort()</span>
									</div>
									@* Token and cost stats row *@
									@if (job.InputTokens.HasValue || job.OutputTokens.HasValue || job.TotalCostUsd.HasValue)
									{
										<div class="d-flex flex-wrap gap-2 mt-1 small">
											@if (job.InputTokens.HasValue || job.OutputTokens.HasValue)
											{
												<span class="font-monospace text-body-secondary" title="Input / Output tokens">
													<i
													class="bi bi-arrow-left-right me-1 opacity-75"></i>@TokenHelper.FormatTokenCount(job.InputTokens
																						?? 0) / @TokenHelper.FormatTokenCount(job.OutputTokens ?? 0)
												</span>
											}
											@if (job.TotalCostUsd.HasValue && job.TotalCostUsd.Value > 0)
											{
												<span class="font-monospace fw-medium text-success" title="Cost">
													@TokenHelper.FormatCost(job.TotalCostUsd.Value)
												</span>
											}
										</div>
									}
									@if ((job.Status == JobStatus.Started || job.Status == JobStatus.Processing) &&
																!string.IsNullOrEmpty(job.CurrentActivity))
									{
										<div class="text-info fst-italic small mt-1">@TruncateText(job.CurrentActivity, 80)</div>
									}
									@if (job.Status == JobStatus.Paused)
									{
										<div class="text-warning fst-italic small mt-1">
											<i class="bi bi-chat-dots me-1"></i>Waiting for user input
										</div>
									}
									@if (!string.IsNullOrEmpty(job.ErrorMessage))
									{
										<div class="text-danger small font-monospace mt-2">@TruncateText(job.ErrorMessage, 100)
										</div>
									}
								</div>
							</div>
							@* Actions Dropdown *@
							<div class="dropdown flex-shrink-0">
								<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
										data-bs-toggle="dropdown" aria-expanded="false">
									<i class="bi bi-three-dots-vertical"></i>
								</button>
								<ul class="dropdown-menu dropdown-menu-end">
									<li>
										<a class="dropdown-item" href="/jobs/view/@job.Id">
											<i class="bi bi-eye me-2"></i>View Details
										</a>
									</li>
									<li>
										<hr class="dropdown-divider">
									</li>
									<li>
										<button class="dropdown-item text-danger"
												@onclick="() => OnDeleteJob.InvokeAsync(job.Id)">
											<i class="bi bi-trash me-2"></i>Delete
										</button>
									</li>
								</ul>
							</div>
						</div>
					</li>
				}
			</ul>
		}
	</div>
</div>

@code {
	[Parameter]
	public List<Job> Jobs { get; set; } = new();

	[Parameter]
	public bool HasActiveJobs { get; set; }

	[Parameter]
	public EventCallback<Guid> OnDeleteJob { get; set; }

	[Parameter]
	public EventCallback OnCreateJob { get; set; }

	private static string GetJobDisplayTitle(Job job)
	{
		// Use Title if available, otherwise truncate GoalPrompt
		if (!string.IsNullOrEmpty(job.Title))
			return TruncateText(job.Title, 100);
		return TruncateText(job.GoalPrompt, 100);
	}

	private static string TruncateText(string text, int maxLength)
	{
		if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
			return text;
		return text[..maxLength] + "...";
	}

	private static string FormatModelName(string modelName)
	{
		// Shorten common model names for display
		if (string.IsNullOrEmpty(modelName)) return modelName;

		// Remove common prefixes and date suffixes
		var name = modelName;
		if (name.Contains('-'))
		{
			// Try to get a shorter version (e.g., "claude-sonnet-4-20250514" -> "sonnet-4")
			var parts = name.Split('-');
			if (parts.Length >= 3)
			{
				// Look for version number pattern
				for (int i = 1; i < parts.Length - 1; i++)
				{
					if (char.IsDigit(parts[i][0]) || parts[i].All(char.IsDigit))
					{
						// Return model name + version
						return $"{parts[i - 1]}-{parts[i]}";
					}
				}
				// Fallback: skip first part and date-like suffix
				if (parts[^1].Length == 8 && parts[^1].All(char.IsDigit))
				{
					return string.Join("-", parts.Skip(1).Take(parts.Length - 2));
				}
			}
		}

		// Truncate if still too long
		return name.Length > 20 ? name[..17] + "..." : name;
	}
}