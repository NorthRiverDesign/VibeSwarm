@page "/projects"
@attribute [Authorize]
@inject IProjectService ProjectService
@inject IJobService JobService
@inject IVersionControlService VersionControlService
@inject NotificationService NotificationService
@implements IDisposable
@using VibeSwarm.Shared.Utilities
@using VibeSwarm.Shared.VersionControl

<PageHeader Title="Projects" Subtitle="Manage your AI agent project workspaces">
    <Actions>
        <ActionButton Icon="plus" Text="Add" OnClick="ShowAddModal" />
    </Actions>
</PageHeader>

@if (IsLoading)
{
    <LoadingSpinner />
}
else if (!ProjectsWithInfo.Any())
{
    <EmptyState Icon="folder" Title="No projects yet" Message="Create your first project to start running AI agent jobs." />
}
else
{
    @* Active / Inactive filter tabs *@
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link @(ActiveFilter == "active" ? "active" : "")" @onclick='() => SetFilter("active")'>
                <i class="bi bi-check-circle me-1"></i>Active
                <span class="badge bg-primary-subtle text-primary-emphasis ms-1">@GetActiveCount()</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(ActiveFilter == "inactive" ? "active" : "")" @onclick='() => SetFilter("inactive")'>
                <i class="bi bi-pause-circle me-1"></i>Inactive
                <span class="badge bg-secondary-subtle text-secondary-emphasis ms-1">@GetInactiveCount()</span>
            </button>
        </li>
    </ul>

    @if (!GetFilteredProjects().Any())
    {
        <EmptyState Icon="@(ActiveFilter == "active" ? "folder" : "pause-circle")"
                    Title="@(ActiveFilter == "active" ? "No active projects" : "No inactive projects")"
                    Message="@(ActiveFilter == "active" ? "All your projects are currently inactive." : "All your projects are currently active.")" />
    }
    else
    {
        <div class="list-group">
            @foreach (var projectInfo in GetFilteredProjects())
            {
                var project = projectInfo.Project;
                var stats = projectInfo.Stats;
                var latestJob = projectInfo.LatestJob;
                var currentBranch = projectInfo.CurrentBranch;
                var projectActiveJobs = ActiveJobs.Where(j => j.ProjectId == project.Id).ToList();
                <div class="list-group-item p-3 hover-bg-tertiary">
                    <div class="d-flex align-items-start gap-3">
                        <div class="flex-grow-1 min-width-0">
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <a href="/projects/@project.Id" class="fw-semibold text-decoration-none">@project.Name</a>
                                @if (project.AutoCommitMode != AutoCommitMode.Off)
                                {
                                    <i class="bi bi-arrow-repeat text-info opacity-75" title="Auto-commit: @project.AutoCommitMode"></i>
                                }
                                @if (!project.IsActive)
                                {
                                    <span class="badge bg-secondary-subtle text-secondary-emphasis">Inactive</span>
                                }
                                @if (stats.ActiveJobs > 0)
                                {
                                    <span class="badge bg-primary bg-opacity-75">@stats.ActiveJobs active</span>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(project.Description))
                            {
                                <div class="small text-body-secondary mt-1">@TruncateText(project.Description, 100)</div>
                            }
                            <div class="d-flex flex-wrap gap-2 gap-md-3 mt-2 small text-body-secondary">
                                <span class="font-monospace bg-body-tertiary px-2 py-1 rounded-1 text-truncate"
                                      style="max-width: 280px;" title="@project.WorkingPath">
                                    @project.WorkingPath
                                </span>
                                @if (!string.IsNullOrEmpty(project.GitHubRepository))
                                {
                                    <span class="d-flex align-items-center gap-1" title="GitHub Repository">
                                        <i class="bi bi-github opacity-75"></i>
                                        <a href="https://github.com/@project.GitHubRepository" target="_blank"
                                               class="text-body-secondary text-decoration-none hover-underline">
                                            @project.GitHubRepository
                                        </a>
                                    </span>
                                }
                                @if (!string.IsNullOrEmpty(currentBranch))
                                {
                                    <span class="d-flex align-items-center gap-1" title="Current branch">
                                        <i class="bi bi-git opacity-75"></i>
                                        @currentBranch
                                    </span>
                                }
                            </div>
                            @* Job Statistics Row *@
                            @if (stats.TotalJobs > 0)
                            {
                                <div class="d-flex flex-wrap gap-2 gap-md-3 mt-2 small">
                                    <span class="d-flex align-items-center gap-1 text-body-secondary" title="Total jobs">
                                        <i class="bi bi-list-check opacity-75"></i>
                                        @stats.TotalJobs jobs
                                    </span>
                                    @if (stats.TotalInputTokens > 0 || stats.TotalOutputTokens > 0)
                                    {
                                        <span class="d-flex align-items-center gap-1 text-body-secondary"
                                              title="Total tokens (input / output)">
                                            <i class="bi bi-braces opacity-75"></i>
                                            @TokenHelper.FormatTokenCount(stats.TotalInputTokens) /
                                            @TokenHelper.FormatTokenCount(stats.TotalOutputTokens)
                                        </span>
                                    }
                                    @if (stats.TotalCostUsd > 0)
                                    {
                                        <span class="d-flex align-items-center gap-1 text-success fw-medium" title="Total cost">
                                            <i class="bi bi-currency-dollar opacity-75"></i>
                                            @TokenHelper.FormatCost(stats.TotalCostUsd)
                                        </span>
                                    }
                                </div>
                            }
                            @* Latest Job Display *@
                            @if (latestJob != null)
                            {
                                <div class="border-top pt-2 mt-2">
                                    <div class="d-flex align-items-center gap-2 small min-width-0">
                                        <a href="/jobs/view/@latestJob.Id"
                                               class="d-flex align-items-center gap-2 text-decoration-none min-width-0"
                                               title="@latestJob.GoalPrompt">
                                            @switch (latestJob.Status)
                                            {
                                                case JobStatus.Completed:
                                                    <i class="bi bi-check-circle-fill text-success flex-shrink-0" title="Completed"></i>
                                                    break;
                                                case JobStatus.Failed:
                                                    <i class="bi bi-x-circle-fill text-danger flex-shrink-0" title="Failed"></i>
                                                    break;
                                                case JobStatus.Started:
                                                case JobStatus.Processing:
                                                    <span class="spinner-border spinner-border-sm text-info flex-shrink-0" role="status"
                                                          title="Running"></span>
                                                    break;
                                                case JobStatus.Cancelled:
                                                    <i class="bi bi-slash-circle text-secondary flex-shrink-0" title="Cancelled"></i>
                                                    break;
                                                case JobStatus.Stalled:
                                                    <i class="bi bi-exclamation-triangle-fill text-warning flex-shrink-0" title="Stalled"></i>
                                                    break;
                                                default:
                                                    <i class="bi bi-clock text-secondary flex-shrink-0" title="Pending"></i>
                                                    break;
                                            }
                                            <span class="text-truncate text-body-secondary">@TruncateText(latestJob.GoalPrompt,
                                                                                                                                                                                                                    60)</span>
                                            </a>
                                        </div>
                                    </div>
                                }
                                @* Active Jobs Display *@
                                @if (projectActiveJobs.Any())
                                {
                                    <div class="@(latestJob == null ? "border-top pt-2 mt-2" : "mt-1")">
                                        @foreach (var job in projectActiveJobs)
                                        {
                                            <div class="bg-body-tertiary rounded-2 p-2 mb-1 small">
                                                <a href="/jobs/view/@job.Id" class="d-flex align-items-center gap-2 text-decoration-none small">
                                                    <StatusBadge Status="@job.Status.ToString()" />
                                                    <span class="text-truncate" style="max-width: 200px;">@TruncateText(job.GoalPrompt,
                                                                                                                                                                                                                                                50)</span>
                                                        @if (!string.IsNullOrEmpty(job.CurrentActivity))
                                                        {
                                                            <span class="text-info fst-italic small d-none d-md-inline">@job.CurrentActivity</span>
                                                        }
                                                    </a>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                                <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                    @* Gear dropdown menu *@
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                                id="project-menu-@project.Id" data-bs-toggle="dropdown" aria-expanded="false"
                                                title="Project actions">
                                            <i class="bi bi-gear"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="project-menu-@project.Id">
                                            <li>
                                                <a class="dropdown-item" href="/projects/@project.Id">
                                                    <i class="bi bi-eye me-2"></i>
                                                    View Details
                                                </a>
                                            </li>
                                            <li>
                                                <button class="dropdown-item" @onclick="@(() => EditProject(project))"
                                                        @onclick:stopPropagation="true">
                                                    <i class="bi bi-pencil me-2"></i>
                                                    Edit
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item" @onclick="@(() => ToggleActive(project))"
                                                        @onclick:stopPropagation="true">
                                                    @if (project.IsActive)
                                                    {
                                                        <i class="bi bi-pause-circle me-2"></i>
                                                        @:Deactivate
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-play-circle me-2"></i>
                                                        @:Activate
                                                    }
                                                </button>
                                            </li>
                                            @if (projectInfo.CurrentBranch != null)
                                            {
                                                <li>
                                                    <button class="dropdown-item" @onclick="@(() => PruneBranches(project))"
                                                            @onclick:stopPropagation="true">
                                                        <i class="bi bi-scissors me-2"></i>
                                                        Prune Branches
                                                    </button>
                                                </li>
                                            }
                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-danger"
                                                        @onclick="@(() => ShowDeleteConfirmation(project))" @onclick:stopPropagation="true">
                                                    <i class="bi bi-trash me-2"></i>
                                                    Delete
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }

        @* Project Modal for Add/Edit *@
        <ProjectModal @bind-IsVisible="ShowProjectModal" EditProject="@EditingProject" OnSaved="HandleProjectSaved"
                      OnCancelled="HandleModalCancelled" OnClosed="HandleProjectModalClosed" />

        @* Delete Confirmation Modal *@
        <ModalDialog @bind-IsVisible="ShowDeleteModal" Title="Delete Project" Icon="exclamation-triangle"
                     Size="ModalDialog.ModalSize.Small" OnClose="HandleDeleteModalClosed">
            <ChildContent>
                <p>Are you sure you want to delete <strong>@ProjectToDelete?.Name</strong>?</p>
                <p class="text-body-secondary small">This will remove the project from VibeSwarm and delete all associated jobs.
                </p>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="deleteDirectory" @bind="DeleteDirectoryConfirmed">
                        <label class="form-check-label text-danger" for="deleteDirectory">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Also delete the project directory from disk
                        </label>
                    </div>
                    @if (DeleteDirectoryConfirmed)
                    {
                        <Alert Type="Alert.AlertType.Danger" Class="mt-2 py-2 px-3 small mb-0">
                            <strong>Warning:</strong> This will permanently delete
                            <code class="text-break">@ProjectToDelete?.WorkingPath</code>
                            and all its contents!
                        </Alert>
                    }
                </ChildContent>
                <FooterContent>
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@IsDeleting">
                        @if (IsDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        Delete@(DeleteDirectoryConfirmed ? " & Remove Files" : "")
                    </button>
                </FooterContent>
            </ModalDialog>

@code {
    private List<ProjectInfoWithStats> ProjectsWithInfo { get; set; } = new();
    private List<Job> ActiveJobs { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private System.Threading.Timer? _refreshTimer;
    private string ActiveFilter { get; set; } = "active";

    // Modal state
    private bool ShowProjectModal { get; set; }
    private Project? EditingProject { get; set; }

    // Delete confirmation state
    private bool ShowDeleteModal { get; set; }
    private Project? ProjectToDelete { get; set; }
    private bool IsDeleting { get; set; }
    private bool DeleteDirectoryConfirmed { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
        await LoadActiveJobs();
        StartAutoRefresh();
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (ActiveJobs.Any())
            {
                await InvokeAsync(async () =>
        {
            await LoadActiveJobs();
            StateHasChanged();
        });
            }
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private async Task LoadActiveJobs()
    {
        try
        {
            ActiveJobs = (await JobService.GetActiveJobsAsync()).ToList();
        }
        catch
        {
            // Ignore errors loading active jobs
        }
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text[..maxLength] + "...";
    }

    private void SetFilter(string filter)
    {
        ActiveFilter = filter;
    }

    private int GetActiveCount() => ProjectsWithInfo.Count(p => p.Project.IsActive);
    private int GetInactiveCount() => ProjectsWithInfo.Count(p => !p.Project.IsActive);

    private IEnumerable<ProjectInfoWithStats> GetFilteredProjects()
    {
        return ActiveFilter == "active"
            ? ProjectsWithInfo.Where(p => p.Project.IsActive)
            : ProjectsWithInfo.Where(p => !p.Project.IsActive);
    }

    private async Task ToggleActive(Project project)
    {
        try
        {
            project.IsActive = !project.IsActive;
            await ProjectService.UpdateAsync(project);
            NotificationService.ShowSuccess($"{project.Name} is now {(project.IsActive ? "active" : "inactive")}.");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            project.IsActive = !project.IsActive; // Revert on failure
            NotificationService.ShowError($"Error toggling project status: {ex.Message}");
        }
    }

    private async Task LoadProjects()
    {
        IsLoading = true;
        try
        {
            var projectsWithStats = (await ProjectService.GetAllWithStatsAsync()).ToList();

            // Build combined info with branch info
            ProjectsWithInfo = new List<ProjectInfoWithStats>();
            foreach (var pws in projectsWithStats)
            {
                var info = new ProjectInfoWithStats
                {
                    Project = pws.Project,
                    Stats = pws.Stats,
                    LatestJob = null,
                    CurrentBranch = null
                };

                // Try to get current branch
                try
                {
                    if (await VersionControlService.IsGitRepositoryAsync(pws.Project.WorkingPath))
                    {
                        info.CurrentBranch = await VersionControlService.GetCurrentBranchAsync(pws.Project.WorkingPath);
                    }
                }
                catch
                {
                    // Ignore errors getting branch info
                }

                // Try to get latest job
                try
                {
                    var projectWithJobs = await ProjectService.GetByIdWithJobsAsync(pws.Project.Id);
                    info.LatestJob = projectWithJobs?.Jobs
                    .OrderByDescending(j => j.CreatedAt)
                    .FirstOrDefault();
                }
                catch
                {
                    // Ignore errors getting latest job
                }

                ProjectsWithInfo.Add(info);
            }
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void ShowAddModal()
    {
        // Close any other open modals first
        ShowDeleteModal = false;
        ProjectToDelete = null;
        DeleteDirectoryConfirmed = false;

        EditingProject = null;
        ShowProjectModal = true;
        StateHasChanged();
    }

    private void EditProject(Project project)
    {
        // Close any other open modals first
        ShowDeleteModal = false;
        ProjectToDelete = null;
        DeleteDirectoryConfirmed = false;

        EditingProject = project;
        ShowProjectModal = true;
        StateHasChanged();
    }

    private async Task HandleProjectSaved(Guid? newProjectId)
    {
        ShowProjectModal = false;
        EditingProject = null;
        await LoadProjects();
    }

    private void HandleModalCancelled()
    {
        ShowProjectModal = false;
        EditingProject = null;
    }

    private void HandleProjectModalClosed()
    {
        ShowProjectModal = false;
        EditingProject = null;
        StateHasChanged();
    }

    private void ShowDeleteConfirmation(Project project)
    {
        // Close any other open modals first
        ShowProjectModal = false;
        EditingProject = null;

        ProjectToDelete = project;
        DeleteDirectoryConfirmed = false;
        ShowDeleteModal = true;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        ShowDeleteModal = false;
        ProjectToDelete = null;
        DeleteDirectoryConfirmed = false;
    }

    private void HandleDeleteModalClosed()
    {
        ShowDeleteModal = false;
        ProjectToDelete = null;
        DeleteDirectoryConfirmed = false;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (ProjectToDelete == null) return;

        IsDeleting = true;
        try
        {
            // Delete the directory if confirmed
            if (DeleteDirectoryConfirmed && !string.IsNullOrEmpty(ProjectToDelete.WorkingPath))
            {
                try
                {
                    if (Directory.Exists(ProjectToDelete.WorkingPath))
                    {
                        Directory.Delete(ProjectToDelete.WorkingPath, recursive: true);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error deleting directory: {ex.Message}");
                    // Continue with project deletion even if directory deletion fails
                }
            }

            await ProjectService.DeleteAsync(ProjectToDelete.Id);
            ShowDeleteModal = false;
            ProjectToDelete = null;
            DeleteDirectoryConfirmed = false;
            await LoadProjects();
        }
        finally
        {
            IsDeleting = false;
        }
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    private async Task PruneBranches(Project project)
    {
        try
        {
            var isRepo = await VersionControlService.IsGitRepositoryAsync(project.WorkingPath);
            if (!isRepo)
            {
                NotificationService.ShowWarning("This project is not a Git repository.", "Not a Git Repository");
                return;
            }

            var result = await VersionControlService.FetchAsync(project.WorkingPath, "origin", prune: true);
            if (result.Success)
            {
                NotificationService.ShowSuccess($"Branches pruned for {project.Name}.", "Prune Complete");
            }
            else
            {
                NotificationService.ShowError(result.Error ?? "Failed to prune branches.", "Prune Failed");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error pruning branches: {ex.Message}", "Prune Failed");
        }
    }
}